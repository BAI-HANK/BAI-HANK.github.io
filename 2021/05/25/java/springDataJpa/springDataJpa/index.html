<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 5.4.2">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/blog.svg">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/blog.svg">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/blog.svg">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css" integrity="sha256-DfWjNxDkM94fVBWx1H5BMMp0Zq7luBlV8QRcSES7s+0=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/themes/blue/pace-theme-big-counter.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/pace.min.js" integrity="sha256-gqd7YTjg/BtfqWSwsJOvndl0Bxc8gFImLEkXQT8+qj0=" crossorigin="anonymous"></script>

<script class="next-config" data-name="main" type="application/json">{"hostname":"bh.com","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.11.1","exturl":false,"sidebar":{"position":"left","width":300,"display":"post","padding":8,"offset":12},"copycode":{"enable":true,"style":"flat"},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":"gitalk","storage":true,"lazyload":false,"nav":{"gitalk":{"order":-1}},"activeClass":"gitalk"},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js"></script>

    <meta name="description" content="hibernate-基础hibernate 作为 ORM 解决方案，非常强调领域模型的概念,是非侵入式的，Hibernate不要求持久化类实现任何接口或继承任何类，POJO即可 hibernate 官方文档-https:&#x2F;&#x2F;docs.jboss.org&#x2F;hibernate&#x2F;orm&#x2F;5.6&#x2F;userguide&#x2F;html_single&#x2F;Hibernate_User_Guide.html hiberna">
<meta property="og:type" content="blog">
<meta property="og:title" content="spring data jpa">
<meta property="og:url" content="http://bh.com/2021/05/25/java/springDataJpa/springDataJpa/index.html">
<meta property="og:site_name" content="Hank Blog">
<meta property="og:description" content="hibernate-基础hibernate 作为 ORM 解决方案，非常强调领域模型的概念,是非侵入式的，Hibernate不要求持久化类实现任何接口或继承任何类，POJO即可 hibernate 官方文档-https:&#x2F;&#x2F;docs.jboss.org&#x2F;hibernate&#x2F;orm&#x2F;5.6&#x2F;userguide&#x2F;html_single&#x2F;Hibernate_User_Guide.html hiberna">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://bh.com/SimpleJpaRepository.png">
<meta property="article:published_time" content="2021-05-25T02:25:37.000Z">
<meta property="article:modified_time" content="2022-12-16T03:55:43.082Z">
<meta property="article:author" content="Hank Bai">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://bh.com/SimpleJpaRepository.png">


<link rel="canonical" href="http://bh.com/2021/05/25/java/springDataJpa/springDataJpa/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"http://bh.com/2021/05/25/java/springDataJpa/springDataJpa/","path":"2021/05/25/java/springDataJpa/springDataJpa/","title":"spring data jpa"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>spring data jpa | Hank Blog</title>
  





  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">Hank Blog</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">热爱生活,拥抱开源,乐于分享</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类<span class="badge">8</span></a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档<span class="badge">20</span></a></li><li class="menu-item menu-item-others"><a href="/others/" rel="section"><i class="fa fa-users fa-fw"></i>推荐</a></li><li class="menu-item menu-item-read"><a href="/read/" rel="section"><i class="fa fa-book fa-fw"></i>阅读</a></li>
  </ul>
</nav>




</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#hibernate-%E5%9F%BA%E7%A1%80"><span class="nav-number">1.</span> <span class="nav-text">hibernate-基础</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%8E%AF%E5%A2%83%E5%87%86%E5%A4%87"><span class="nav-number">1.1.</span> <span class="nav-text">环境准备</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%84%8F%E6%95%B0%E6%8D%AE"><span class="nav-number">1.2.</span> <span class="nav-text">脏数据</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#JPA-%E5%92%8C-Hibernate-API-%E9%80%9A%E8%BF%87-unwrap-%E4%BA%92%E7%9B%B8%E8%BD%AC"><span class="nav-number">1.3.</span> <span class="nav-text">JPA 和 Hibernate API 通过 unwrap 互相转</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AF%B9%E8%B1%A1%E7%9A%84%E7%8A%B6%E6%80%81"><span class="nav-number">1.4.</span> <span class="nav-text">对象的状态</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#EntityEntry-%E4%B8%8A%E4%B8%8B%E6%96%87%E8%B7%9F%E8%B8%AA%E7%9A%84%E5%AE%9E%E4%BD%93%E4%BF%A1%E6%81%AF%E5%AF%B9%E8%B1%A1"><span class="nav-number">1.4.1.</span> <span class="nav-text">EntityEntry 上下文跟踪的实体信息对象</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%84%8F%E6%95%B0%E6%8D%AE%E5%8F%8A%E5%AF%B9%E8%B1%A1%E7%9A%84%E7%BC%93%E5%AD%98"><span class="nav-number">1.4.2.</span> <span class="nav-text">脏数据及对象的缓存</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B8%85%E9%99%A4%E7%AE%A1%E7%90%86%E7%9A%84%E5%AE%9E%E4%BD%93"><span class="nav-number">1.4.3.</span> <span class="nav-text">清除管理的实体</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#evict-%E5%9C%A8-session-%E7%BC%93%E5%AD%98%E4%B8%AD%E6%B8%85%E9%99%A4%E4%B8%80%E4%B8%AA%E6%8C%81%E4%B9%85%E5%8C%96%E5%AF%B9%E8%B1%A1"><span class="nav-number">1.4.4.</span> <span class="nav-text">evict 在 session 缓存中清除一个持久化对象</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#session-%E5%AF%B9%E8%B1%A1"><span class="nav-number">1.5.</span> <span class="nav-text">session 对象</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#get-load-%E5%8C%BA%E5%88%AB"><span class="nav-number">1.5.1.</span> <span class="nav-text">get , load 区别</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#update-merge-%E5%8C%BA%E5%88%AB"><span class="nav-number">1.5.2.</span> <span class="nav-text">update , merge 区别</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#save-persist-%E5%8C%BA%E5%88%AB"><span class="nav-number">1.5.3.</span> <span class="nav-text">save , persist 区别</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%89%B9%E9%87%8F%E6%9B%B4%E6%96%B0"><span class="nav-number">1.5.4.</span> <span class="nav-text">批量更新</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#spring-data-jpa"><span class="nav-number">2.</span> <span class="nav-text">spring data jpa</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%8C%89%E7%85%A7-JPA-%E7%9A%84%E6%96%B9%E5%BC%8F%E4%BD%BF%E7%94%A8"><span class="nav-number">2.1.</span> <span class="nav-text">按照 JPA 的方式使用</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B5%8B%E8%AF%95-spring-data-%E9%87%8C%E7%9A%84%E4%BA%8B%E5%8A%A1"><span class="nav-number">2.2.</span> <span class="nav-text">测试 spring data 里的事务</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#spring-data-jpa-%E6%8B%93%E5%B1%95"><span class="nav-number">2.3.</span> <span class="nav-text">spring data jpa 拓展</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Repository-%E5%8F%8A%E5%85%B6%E5%AD%90%E7%B1%BB"><span class="nav-number">2.3.1.</span> <span class="nav-text">Repository 及其子类</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#spring-%E6%89%A9%E5%B1%95%E7%9A%84%E6%96%B9%E6%B3%95"><span class="nav-number">2.3.2.</span> <span class="nav-text">spring 扩展的方法</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Declared-Queries-%E6%96%B9%E6%B3%95%E5%AE%9A%E4%B9%89%E6%9F%A5%E8%AF%A2-%E5%A6%82%E6%9E%9C%E8%BF%94%E5%9B%9E%E5%AE%9E%E4%BD%93%EF%BC%8C%E4%B8%8D%E8%83%BD%E8%BF%94%E5%9B%9E%E5%AE%9E%E4%BD%93%E7%9A%84%E9%83%A8%E5%88%86%E5%B1%9E%E6%80%A7%EF%BC%8C%E8%80%8C%E6%98%AF%E5%85%A8%E9%83%A8%E5%B1%9E%E6%80%A7"><span class="nav-number">2.3.2.1.</span> <span class="nav-text">Declared Queries -方法定义查询 ,如果返回实体，不能返回实体的部分属性，而是全部属性</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Query-JPQL%E6%B3%A8%E8%A7%A3%E6%9F%A5%E8%AF%A2"><span class="nav-number">2.3.2.2.</span> <span class="nav-text">@Query -JPQL注解查询</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#SpEL-%E8%A1%A8%E8%BE%BE%E5%BC%8F"><span class="nav-number">2.3.2.2.1.</span> <span class="nav-text">SpEL 表达式</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#NamedQuery-%E5%91%BD%E5%90%8D%E6%9F%A5%E8%AF%A2"><span class="nav-number">2.3.2.3.</span> <span class="nav-text">@NamedQuery-命名查询</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#NamedStoredProcedureQueries-%EF%BC%8C-Procedure-%E5%91%BD%E5%90%8D%E6%9F%A5%E8%AF%A2%E7%9A%84%E5%AD%98%E5%82%A8%E8%BF%87%E7%A8%8B"><span class="nav-number">2.3.2.4.</span> <span class="nav-text">@NamedStoredProcedureQueries ， @Procedure 命名查询的存储过程</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#QueryByExampleExecutor-%E7%AE%80%E5%8D%95%E5%8C%96%E7%9A%84%E5%8A%A8%E6%80%81%E6%9F%A5%E8%AF%A2"><span class="nav-number">2.3.2.5.</span> <span class="nav-text">QueryByExampleExecutor 简单化的动态查询</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#JpaSpecificationExecutor-%E5%8F%AF%E7%BB%84%E5%90%88%E7%9A%84%E8%A7%84%E7%BA%A6%E6%9F%A5%E8%AF%A2"><span class="nav-number">2.3.2.6.</span> <span class="nav-text">JpaSpecificationExecutor-可组合的规约查询</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#QueryDSL-%E8%A7%A3%E5%86%B3%E5%A4%9A%E8%A1%A8%E6%9F%A5%E8%AF%A2%EF%BC%8C%E5%8A%A8%E6%80%81%E6%9F%A5%E8%AF%A2%E7%9A%84%E9%80%9A%E7%94%A8%E7%B1%BB%E5%9E%8B%E5%AE%89%E5%85%A8%E7%9A%84%E6%9F%A5%E8%AF%A2%E5%88%A9%E5%99%A8%EF%BC%8C%E4%BB%A3%E6%9B%BFJPQL"><span class="nav-number">2.3.2.7.</span> <span class="nav-text">QueryDSL - 解决多表查询，动态查询的通用类型安全的查询利器，代替JPQL</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E4%BB%93%E5%82%A8%E7%BB%A7%E6%89%BF-QuerydslPredicateExecutor-%E6%8E%A5%E5%8F%A3"><span class="nav-number">2.3.2.7.1.</span> <span class="nav-text">仓储继承 QuerydslPredicateExecutor 接口</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E4%BB%93%E5%82%A8%E6%B3%A8%E5%85%A5-JPAQueryFactory-%E5%AF%B9%E8%B1%A1%E9%93%BE%E5%BC%8F%E6%9F%A5%E8%AF%A2%EF%BC%8C%E5%A4%9A%E8%A1%A8%EF%BC%8C%E5%A4%9A%E5%AD%97%E6%AE%B5%E6%9F%A5%E8%AF%A2"><span class="nav-number">2.3.2.7.2.</span> <span class="nav-text">仓储注入 JPAQueryFactory 对象链式查询，多表，多字段查询</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#%E6%9B%B4%E6%96%B0%E5%88%A0%E9%99%A4"><span class="nav-number">2.3.2.7.2.1.</span> <span class="nav-text">更新删除</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E6%9F%A5%E8%AF%A2%E9%83%A8%E5%88%86%E5%AD%97%E6%AE%B5"><span class="nav-number">2.3.2.7.2.2.</span> <span class="nav-text">查询部分字段</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E5%85%B3%E8%81%94%E5%92%8C%E5%AD%90%E6%9F%A5%E8%AF%A2"><span class="nav-number">2.3.2.7.2.3.</span> <span class="nav-text">关联和子查询</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E5%88%86%E7%BB%84%E5%92%8C%E5%88%86%E9%A1%B5%E5%8F%8A%E6%8E%92%E5%BA%8F"><span class="nav-number">2.3.2.7.2.4.</span> <span class="nav-text">分组和分页及排序</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E8%81%9A%E5%90%88%E5%87%BD%E6%95%B0%EF%BC%8C%E6%9C%AC%E8%B4%A8%E8%BF%98%E6%98%AF%E8%B0%83%E7%94%A8%E6%95%B0%E6%8D%AE%E5%BA%93%E7%9A%84%E8%81%9A%E5%90%88%E5%87%BD%E6%95%B0"><span class="nav-number">2.3.2.7.2.5.</span> <span class="nav-text">聚合函数，本质还是调用数据库的聚合函数</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#spring-%E6%89%A9%E5%B1%95%E7%9A%84-%E5%8F%82%E6%95%B0%E5%88%86%E9%A1%B5%E5%92%8C%E6%8E%92%E5%BA%8F-Pageable-Sort"><span class="nav-number">2.3.3.</span> <span class="nav-text">spring 扩展的 参数分页和排序-Pageable&#x2F;Sort</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9F%A5%E8%AF%A2%E8%BF%94%E5%9B%9E%E7%BB%93%E6%9E%9C"><span class="nav-number">2.3.4.</span> <span class="nav-text">查询返回结果</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Projections%EF%BC%88%E6%8A%95%E5%BD%B1%EF%BC%89%E5%AF%B9%E6%9F%A5%E8%AF%A2%E7%BB%93%E6%9E%9C%E7%9A%84%E6%89%A9%E5%B1%95"><span class="nav-number">2.3.5.</span> <span class="nav-text">Projections（投影）对查询结果的扩展</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%9F%BA%E4%BA%8E%E6%8E%A5%E5%8F%A3%E7%9A%84%E6%8A%95%E5%BD%B1"><span class="nav-number">2.3.5.1.</span> <span class="nav-text">基于接口的投影</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%9F%BA%E4%BA%8EDTO-%E7%B1%BB%E7%9A%84%E6%8A%95%E5%BD%B1-%E6%8E%A8%E8%8D%90"><span class="nav-number">2.3.5.2.</span> <span class="nav-text">基于DTO 类的投影-推荐</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#jpa-hibernate-%E5%AE%9E%E4%BD%93%E7%9A%84%E7%BB%A7%E6%89%BF%E5%85%B3%E7%B3%BB"><span class="nav-number">3.</span> <span class="nav-text">jpa-hibernate 实体的继承关系</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#MappedSuperclass-%E5%8F%AA%E8%83%BD%E7%94%A8%E5%9C%A8%E7%B1%BB%E4%B8%8A"><span class="nav-number">3.1.</span> <span class="nav-text">@MappedSuperclass 只能用在类上</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#SecondaryTable-%E6%95%B0%E6%8D%AE%E5%BA%93%E6%8A%8A%E4%B8%BB%E8%A1%A8%E7%9A%84%E9%83%A8%E5%88%86%E5%AD%97%E6%AE%B5%E5%88%86%E5%88%B0%E5%AD%90%E8%A1%A8-%E4%B8%8D%E7%94%A8-%E5%A2%9E%E5%8A%A0%E5%A4%8D%E6%9D%82%E5%BA%A6"><span class="nav-number">3.2.</span> <span class="nav-text">@SecondaryTable 数据库把主表的部分字段分到子表 -不用,增加复杂度</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Inheritance-%E4%B8%8D%E7%94%A8-%E5%A2%9E%E5%8A%A0%E5%A4%8D%E6%9D%82%E5%BA%A6"><span class="nav-number">3.3.</span> <span class="nav-text">@Inheritance -不用,增加复杂度</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#jpa-hibernate-Entity-Callbacks-%E7%9A%84%E5%9B%9E%E8%B0%83%E6%96%B9%E6%B3%95"><span class="nav-number">4.</span> <span class="nav-text">jpa-hibernate @Entity Callbacks-的回调方法</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9C%A8%E6%A0%87%E6%B3%A8-super-class-%E6%B3%A8%E8%A7%A3%E7%9A%84%E5%AE%9E%E4%BD%93%E9%87%8C%E5%86%99%E5%9B%9E%E8%B0%83%E6%96%B9%E6%B3%95"><span class="nav-number">4.1.</span> <span class="nav-text">在标注 @super-class 注解的实体里写回调方法</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89-EntityListener%EF%BC%8C%E4%B8%8D%E5%BB%BA%E8%AE%AE%E4%BD%BF%E7%94%A8"><span class="nav-number">4.2.</span> <span class="nav-text">自定义 EntityListener，不建议使用</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#jpa-hibernate-%E4%B9%90%E8%A7%82%E9%94%81%E5%92%8C%E9%87%8D%E8%AF%95%E6%9C%BA%E5%88%B6"><span class="nav-number">5.</span> <span class="nav-text">jpa-hibernate 乐观锁和重试机制</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#jpa-hibernate-%E6%8F%90%E4%BE%9B%E7%9A%84%E6%B3%A8%E8%A7%A3"><span class="nav-number">6.</span> <span class="nav-text">jpa-hibernate 提供的注解</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Table"><span class="nav-number">6.1.</span> <span class="nav-text">@Table</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#IdClass-%EF%BC%8C-EmbeddedId-%E8%81%94%E5%90%88%E4%B8%BB%E9%94%AE"><span class="nav-number">6.2.</span> <span class="nav-text">@IdClass ， @EmbeddedId 联合主键</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#GeneratedValue"><span class="nav-number">6.3.</span> <span class="nav-text">@GeneratedValue</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Column"><span class="nav-number">6.4.</span> <span class="nav-text">@Column</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Temporal"><span class="nav-number">6.5.</span> <span class="nav-text">@Temporal</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Lob"><span class="nav-number">6.6.</span> <span class="nav-text">@Lob</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Basic"><span class="nav-number">6.7.</span> <span class="nav-text">@Basic</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Embeddable-Embedded-%E5%80%BC%E5%AF%B9%E8%B1%A1"><span class="nav-number">6.8.</span> <span class="nav-text">@Embeddable ,  @Embedded 值对象</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%80%BC%E5%AF%B9%E8%B1%A1%E7%9A%84%E5%85%B6%E4%BB%96%E8%A7%A3%E5%86%B3%E6%96%B9%E6%B3%95"><span class="nav-number">6.8.1.</span> <span class="nav-text">值对象的其他解决方法</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#jpa-hibernate-%E5%85%B3%E8%81%94%E5%85%B3%E7%B3%BB"><span class="nav-number">7.</span> <span class="nav-text">jpa-hibernate 关联关系</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#JoinColumn-%E6%B3%A8%E8%A7%A3%E7%94%A8%E6%9D%A5%E5%AE%9A%E4%B9%89%E4%B8%BB%E9%94%AE%E5%AD%97%E6%AE%B5%E5%92%8C%E5%A4%96%E9%94%AE%E5%AD%97%E6%AE%B5%E7%9A%84%E5%AF%B9%E5%BA%94%E5%85%B3%E7%B3%BB"><span class="nav-number">7.1.</span> <span class="nav-text">@JoinColumn 注解用来定义主键字段和外键字段的对应关系</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#OneToOne-%E5%AE%9E%E4%BD%93%E5%92%8C%E5%AE%9E%E4%BD%93%E6%98%AF1%E5%AF%B91%E5%85%B3%E8%81%94"><span class="nav-number">7.2.</span> <span class="nav-text">@OneToOne 实体和实体是1对1关联</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#OneToMany-%E5%AE%9E%E4%BD%93%E5%92%8C%E5%AE%9E%E4%BD%93%E6%98%AF1%E5%AF%B9%E5%A4%9A%E5%85%B3%E8%81%94"><span class="nav-number">7.3.</span> <span class="nav-text">@OneToMany 实体和实体是1对多关联</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#OrderBy-%E5%AF%B9%E5%A4%9A%E7%AB%AF%E7%9A%84%E8%BF%94%E5%9B%9E%E8%BF%9B%E8%A1%8C%E6%8E%92%E5%BA%8F"><span class="nav-number">7.4.</span> <span class="nav-text">@OrderBy 对多端的返回进行排序</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#JoinTable-%E8%87%AA%E5%AE%9A%E4%B9%89%E4%B8%AD%E9%97%B4%E8%A1%A8%EF%BC%8C%E5%9F%BA%E6%9C%AC%E4%B8%8D%E7%94%A8"><span class="nav-number">7.5.</span> <span class="nav-text">@JoinTable 自定义中间表，基本不用</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ManyToMany-%E5%A4%9A%E5%AF%B9%E5%A4%9A-%E5%BF%85%E9%A1%BB%E8%A6%81%E6%9C%89%E4%B8%AD%E9%97%B4%E8%A1%A8%EF%BC%8C%E5%9F%BA%E6%9C%AC%E4%B8%8D%E7%94%A8"><span class="nav-number">7.6.</span> <span class="nav-text">@ManyToMany 多对多-必须要有中间表，基本不用</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#jpa-hibernate-%E7%BC%93%E5%AD%98"><span class="nav-number">8.</span> <span class="nav-text">jpa-hibernate 缓存</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%80%E7%BA%A7%E7%BC%93%E5%AD%98"><span class="nav-number">8.1.</span> <span class="nav-text">一级缓存</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BA%8C%E7%BA%A7%E7%BC%93%E5%AD%98"><span class="nav-number">8.2.</span> <span class="nav-text">二级缓存</span></a></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Hank Bai"
      src="/images/rocket.png">
  <p class="site-author-name" itemprop="name">Hank Bai</p>
  <div class="site-description" itemprop="description">全栈工程师</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">20</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">8</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="/1410199713@qq.com" title="E-Mail → 1410199713@qq.com"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://github.com/BAI-HANK" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;BAI-HANK" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
  </div>
  <div class="cc-license site-overview-item animated" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" class="cc-opacity" rel="noopener" target="_blank"><img src="https://cdnjs.cloudflare.com/ajax/libs/creativecommons-vocabulary/2020.11.3/assets/license_badges/small/by_nc_sa.svg" alt="Creative Commons"></a>
  </div>


  <div class="links-of-blogroll site-overview-item animated">
    <div class="links-of-blogroll-title"><i class="fa fa-globe fa-fw"></i>
      Links
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="http://www.alloyteam.com/nav/" title="http:&#x2F;&#x2F;www.alloyteam.com&#x2F;nav&#x2F;" rel="noopener" target="_blank">Web前端导航</a>
        </li>
    </ul>
  </div>

        </div>
      </div>

      <div id="music163player" >
         <iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width=298 height=52 src="//music.163.com/outchain/player?type=2&id=5236281&auto=0&height=32">
         </iframe>
      </div><div>
  <br>
  <canvas id="canvasDiyBlock" style="width:60%;">当前浏览器不支持canvas，请更换浏览器后再试</canvas><script src="/js/custom/clock.js"></script>
</div>
      
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>

  <a href="https://github.com/BAI-HANK" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://bh.com/2021/05/25/java/springDataJpa/springDataJpa/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/rocket.png">
      <meta itemprop="name" content="Hank Bai">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hank Blog">
      <meta itemprop="description" content="全栈工程师">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="spring data jpa | Hank Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          spring data jpa
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-05-25 10:25:37" itemprop="dateCreated datePublished" datetime="2021-05-25T10:25:37+08:00">2021-05-25</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2022-12-16 11:55:43" itemprop="dateModified" datetime="2022-12-16T11:55:43+08:00">2022-12-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/java/" itemprop="url" rel="index"><span itemprop="name">java</span></a>
        </span>
    </span>

  
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>1.9k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>3 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <h1 id="hibernate-基础"><a href="#hibernate-基础" class="headerlink" title="hibernate-基础"></a>hibernate-基础</h1><p><em>hibernate 作为 ORM 解决方案，非常强调领域模型的概念,是非侵入式的，Hibernate不要求持久化类实现任何接口或继承任何类，POJO即可</em></p>
<p>hibernate 官方文档-<a target="_blank" rel="noopener" href="https://docs.jboss.org/hibernate/orm/5.6/userguide/html_single/Hibernate_User_Guide.html">https://docs.jboss.org/hibernate/orm/5.6/userguide/html_single/Hibernate_User_Guide.html</a></p>
<p>hibernate 总体的架构图<br>如下图所示，<em>hibernate 实现了java persistence api（JPA)，同时也自己扩展了接口 hibernate native api</em></p>
<pre class="mermaid">graph LR
 userDataAccessLayer(user data access layer)
 javaPersistenceApi(java persistence api)
 hibernateNativeApi(hibernate native api)
 hibernate
 jdbc
 database
 
 userDataAccessLayer -.-> javaPersistenceApi
 userDataAccessLayer -.-> hibernateNativeApi

 subgraph hibernate-core
  javaPersistenceApi -.-> hibernate
  hibernateNativeApi -.-> hibernate
 end

 subgraph database-jdbc
   hibernate-.->jdbc
   jdbc-.->database
 end

 style hibernate-core fill: #f9f, stroke: #333, stroke-width: 1px;
 style database-jdbc fill: #ee9f, stroke: #333, stroke-width: 1px;</pre>

<p>Hibernate API 最基础的 API</p>
<ol>
<li><p>SessionFactory（会话工厂）<br>是一个线程安全的，immutable（终态的），它是一个代理，表示应用程序域,SessionFactory 的建立代价很大,所以一个 应用只能有一个 SessionFactory,SessionFactory 维护 ,Hibernate 的所有 Session（会话），二级缓冲，连接池，事务等等。如果应用需要使用Hibernate访问多个数据库，则需要对每一个数据库使用一个SessionFactory。</p>
</li>
<li><p>Session（会话）<br>Session（会话）是一个单线程，短生命周期的对象，是按”Unit of Work（工作单元）,Session 维护了一级缓存，在第一次发送SQL语句查询后第二次直接使用缓存中的数据，不会再发送SQL。除非session缓存被清空，平常的 crud 就通过它。session是一个轻量级对象,Session实例并不是线程安全的，因此应该被设计为每次只能在一个线程中使用。通常将每一个Session实例和一个数据库事务绑定，也就是说，每执行一个数据库事务，都应该先创建一个新的Session实例</p>
</li>
<li><p>Transaction(事务)<br>那么每个Session的操作，是一个独立的事务,是Hibernate的数据库事务接口，它对底层的事务接口做了封装，底层事务接口包括JDBC事务和JTA（Java Transaction API）事务</p>
</li>
<li><p>Query （接口）<br>是Hibernate的查询接口，用于向数据库查询对象，以及控制执行查询的过程。Query实例包装了一个HQL（Hibernate Query Language）查询语句，HQL查询语句与SQL查询语句有些相似，但HQL查询语句是面向对象的，它引用类名及类的属性名，而不是表名及表的字段名。<br>Query接口让你方便地对数据库及持久对象进行查询，它可以有两种表达方式：HQL语言或本地数据库的SQL语句。Query经常被用来绑定查询参数、限制查询记录数量，并最终执行查询操作。</p>
</li>
<li><p>Criteria（接口）</p>
</li>
<li><p>Configuration（配置类）<br>Configuration 类的作用是对Hibernate 进行配置，以及对它进行启动。在Hibernate 的启动过程中，Configuration 类的实例首先定位映射文档的位置，读取这些配置，然后创建一个SessionFactory对象。虽然Configuration 类在整个Hibernate 项目中只扮演着一个很小的角色，但它是启动hibernate 时所遇到的第一个对象。</p>
</li>
</ol>
<p>如图中的根接口都是在 jpa 中定义的</p>
<pre class="mermaid">classDiagram
    I_EntityManagerFactory <|--  I_SessionFactory
     I_SessionFactory <|..    C_SessionFactoryImpl
    I_EntityManager  <|--  I_Session
    I_Session  <|..   C_SessionImpl
    I_EntityTransaction  <|--  I_Transaction
    I_Transaction  <|..  C_TransactionImpl</pre>

<h2 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h2><p>mysql 测试通过,postgres 用的是  42.5.1 版本 测试没有通过 ，无法加载 postgres drive</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--数据库驱动--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>8.0.30<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!--hibernate--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.hibernate<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hibernate-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.6.14.Final<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>基础类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Config</span> &#123;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 输出所有管理的实体</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> context</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> Map.Entry&lt;Object, EntityEntry&gt;[] getManagedEntities(PersistenceContext context) &#123;</span><br><span class="line">    <span class="type">var</span> <span class="variable">map</span> <span class="operator">=</span> context.reentrantSafeEntityEntries();</span><br><span class="line">    <span class="keyword">return</span>  map;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">extracted</span><span class="params">(Consumer&lt;Configuration&gt; configurer, Consumer&lt;Session&gt; handler)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">var</span> <span class="variable">cfg</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Configuration</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//.configure()  在classpath根路径下搜索名为hibernate.cfg.xml的文件，如果没有找到将会抛出异常, 也可以指定 configure 方法参数为指定的路径</span></span><br><span class="line">    <span class="comment">//var cfg = new Configuration().configure();</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    hibernate.cfg.xml</span></span><br><span class="line"><span class="comment">     &lt;hibernate-configuration&gt;</span></span><br><span class="line"><span class="comment">        &lt;session-factory&gt;</span></span><br><span class="line"><span class="comment">            &lt;property name=&quot;xxx&quot;&gt;yyy&lt;/property&gt;</span></span><br><span class="line"><span class="comment">            //数据库和类映射 xml 文件</span></span><br><span class="line"><span class="comment">            &lt;mapping resource=&quot;xxx.hbm.xml&quot;/&gt;</span></span><br><span class="line"><span class="comment">        &lt;/session-factory&gt;</span></span><br><span class="line"><span class="comment">     &lt;/hibernate-configuration&gt;</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// dialect 指明具体联系的数据库类型，因为同一个数据库因为版本的不同，标准也会有差异, SQL 标准各个厂家完全遵守的</span></span><br><span class="line">    cfg.setProperty(<span class="string">&quot;hibernate.dialect&quot;</span>, <span class="string">&quot;org.hibernate.dialect.MySQL8Dialect&quot;</span>);</span><br><span class="line">    cfg.setProperty(<span class="string">&quot;hibernate.connection.driver_class&quot;</span>, <span class="string">&quot;com.mysql.cj.jdbc.Driver&quot;</span>);</span><br><span class="line">    cfg.setProperty(<span class="string">&quot;hibernate.connection.url&quot;</span>, <span class="string">&quot;jdbc:mysql://localhost:3306/MyDB&quot;</span>);</span><br><span class="line">    cfg.setProperty(<span class="string">&quot;hibernate.connection.username&quot;</span>, <span class="string">&quot;root&quot;</span>);</span><br><span class="line">    cfg.setProperty(<span class="string">&quot;hibernate.connection.password&quot;</span>, <span class="string">&quot;root&quot;</span>);</span><br><span class="line">    cfg.setProperty(<span class="string">&quot;hibernate.show_sql&quot;</span>, <span class="string">&quot;true&quot;</span>);</span><br><span class="line">    cfg.setProperty(<span class="string">&quot;format_sql&quot;</span>, <span class="string">&quot;true&quot;</span>);</span><br><span class="line">    cfg.setProperty(<span class="string">&quot;use_sql_comments&quot;</span>, <span class="string">&quot;true&quot;</span>);</span><br><span class="line"></span><br><span class="line">    cfg.setProperty(<span class="string">&quot;hibernate.hbm2ddl.auto&quot;</span>,<span class="string">&quot;update&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//设置全局拦截器</span></span><br><span class="line">    cfg.setInterceptor(<span class="keyword">new</span> <span class="title class_">MyInterceptor</span>());</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//外部继续配置</span></span><br><span class="line">    configurer.accept(cfg);</span><br><span class="line"></span><br><span class="line">    <span class="type">SessionFactory</span> <span class="variable">factory</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="type">Session</span> <span class="variable">session</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//ServiceRegistry 是 Service 的注册表, 它为Service提供了一个统一的加载 / 初始化 / 存放 / 获取机制.</span></span><br><span class="line">    <span class="keyword">var</span> serviceRegistry=<span class="keyword">new</span> <span class="title class_">StandardServiceRegistryBuilder</span>().applySettings(cfg.getProperties()).build();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      factory = cfg.buildSessionFactory(serviceRegistry);</span><br><span class="line">      <span class="keyword">var</span> ii=  factory.unwrap(SessionFactoryImplementor.class);</span><br><span class="line">      ii.getServiceRegistry().getService(EventListenerRegistry.class).appendListeners(EventType.FLUSH,<span class="keyword">new</span> <span class="title class_">MyEvent</span>());</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">      session = factory.openSession();</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (session.isConnected()) &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;连接已通&quot;</span>);</span><br><span class="line">        <span class="comment">//关于 session 的测试</span></span><br><span class="line">        handler.accept(session);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">      ex.printStackTrace();</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (session != <span class="literal">null</span>) &#123;</span><br><span class="line">        session.close();</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (factory != <span class="literal">null</span>) &#123;</span><br><span class="line">        factory.close();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MyInterceptor</span>  <span class="keyword">extends</span>  <span class="title class_">EmptyInterceptor</span> &#123;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 脏数据检查，可以知道那些字段发什么了什么变化</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> entity</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> currentState</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> previousState</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> propertyNames</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> types</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span>  <span class="type">boolean</span> <span class="title function_">onFlushDirty</span><span class="params">(Object entity, Serializable id, Object[] currentState, Object[] previousState, String[] propertyNames, Type[] types)</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; propertyNames.length; i++) &#123;</span><br><span class="line">      <span class="type">var</span> <span class="variable">type</span> <span class="operator">=</span> types[i];</span><br><span class="line">      <span class="keyword">var</span> newValue= currentState[i];</span><br><span class="line">      <span class="keyword">var</span> oldValue= previousState[i];</span><br><span class="line">      System.out.println(<span class="string">&quot;Cargo 的属性：&quot;</span>+propertyNames[i] +</span><br><span class="line">          <span class="string">&quot;， 属性类型:&quot;</span>+type.getName()+</span><br><span class="line">          <span class="string">&quot;， id:&quot;</span>+id+</span><br><span class="line">          <span class="string">&quot;， old value:&quot;</span>+oldValue+</span><br><span class="line">          <span class="string">&quot;， new value:&quot;</span>+newValue);</span><br><span class="line">      <span class="comment">//在持久化到数据库之前，还可以再次修改属性值</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//返回 true ，在此方法里对 currentState 的修改会持久化到数据库.</span></span><br><span class="line">    <span class="comment">//返回 false, 不会把对 currentState 修改持久化到数据库</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>简单的测试类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Programmer</span> &#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ClassNotFoundException, SQLException &#123;</span><br><span class="line">    <span class="type">var</span> <span class="variable">config</span> <span class="operator">=</span><span class="keyword">new</span> <span class="title class_">Config</span>();</span><br><span class="line">    config.extracted(cfg -&gt; &#123;</span><br><span class="line">     <span class="comment">/*</span></span><br><span class="line"><span class="comment">       可以代替 xml 方式的映射文件 &lt;mapping resource=&quot;xxx.hbm..xml&quot; /&gt;  持久化类</span></span><br><span class="line"><span class="comment">       如果有多个实体类，一个个添加是不是很麻烦</span></span><br><span class="line"><span class="comment">       只能是自己去封装了</span></span><br><span class="line"><span class="comment">      */</span></span><br><span class="line">      cfg.addAnnotatedClass(Cargo.class);</span><br><span class="line">      cfg.addAnnotatedClass(Person.class);</span><br><span class="line">    &#125;, </span><br><span class="line">    </span><br><span class="line">    <span class="comment">//业务逻辑</span></span><br><span class="line">    session -&gt; &#123;</span><br><span class="line">      session.beginTransaction();</span><br><span class="line">      <span class="type">var</span> <span class="variable">cargo</span> <span class="operator">=</span> session.get(Cargo.class,<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">      <span class="type">var</span> <span class="variable">context</span> <span class="operator">=</span> session.unwrap(SessionImplementor.class).getPersistenceContext();</span><br><span class="line">      <span class="comment">//查询当前可管理实体</span></span><br><span class="line">      System.out.println(<span class="string">&quot;管理的实体个数：&quot;</span>+context.getNumberOfManagedEntities());</span><br><span class="line">      Arrays.stream(Config.getManagedEntities(context)).forEach(p-&gt;&#123;</span><br><span class="line">        System.out.println(p.getKey());</span><br><span class="line">        System.out.println(p.getValue());</span><br><span class="line">      &#125;);</span><br><span class="line"></span><br><span class="line">      session.getTransaction().commit();</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="脏数据"><a href="#脏数据" class="headerlink" title="脏数据"></a>脏数据</h2><p>对被 session 管理的数据进行更改后的数据是脏数据，也就是和数据库的数据不同步了，当提交事务的时候，脏数据会自动同步到数据库</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">session.beginTransaction();</span><br><span class="line"></span><br><span class="line"><span class="type">var</span> <span class="variable">cargo</span> <span class="operator">=</span> session.get(Cargo.class,<span class="number">1</span>);</span><br><span class="line"><span class="type">var</span> <span class="variable">context</span> <span class="operator">=</span> session.unwrap(SessionImplementor.class).getPersistenceContext();</span><br><span class="line"></span><br><span class="line"><span class="comment">//查询当前可管理实体</span></span><br><span class="line">System.out.println(<span class="string">&quot;管理的实体个数：&quot;</span>+context.getNumberOfManagedEntities());</span><br><span class="line">Arrays.stream(Config.getManagedEntities(context)).forEach(p-&gt;&#123;</span><br><span class="line">  System.out.println(p.getKey());</span><br><span class="line">  System.out.println(p.getValue());</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">System.out.println(<span class="string">&quot;数据是否改变&quot;</span>+session.isDirty());</span><br><span class="line"><span class="comment">//false</span></span><br><span class="line"></span><br><span class="line">cargo.setName(<span class="string">&quot;dirt&quot;</span>);</span><br><span class="line"></span><br><span class="line">System.out.println(<span class="string">&quot;数据是否改变&quot;</span>+session.isDirty());</span><br><span class="line"><span class="comment">//true</span></span><br><span class="line"></span><br><span class="line">session.getTransaction().commit();</span><br><span class="line"></span><br><span class="line">System.out.println(<span class="string">&quot;数据是否改变&quot;</span>+session.isDirty());</span><br><span class="line"><span class="comment">//false</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">连接已通</span></span><br><span class="line"><span class="comment">Hibernate: select cargo0_.id as id1_0_0_, cargo0_.name as name2_0_0_ from Cargo cargo0_ where cargo0_.id=?</span></span><br><span class="line"><span class="comment">管理的实体个数：1</span></span><br><span class="line"><span class="comment">com.hank.entity.Cargo@3d1f558a</span></span><br><span class="line"><span class="comment">EntityEntry[com.hank.entity.Cargo#1](MANAGED)</span></span><br><span class="line"><span class="comment">数据是否改变false</span></span><br><span class="line"><span class="comment">Cargo 的属性：name， 属性类型:string， id:1， old value:bag， new value:dirt</span></span><br><span class="line"><span class="comment">数据是否改变true</span></span><br><span class="line"><span class="comment">Cargo 的属性：name， 属性类型:string， id:1， old value:bag， new value:dirt</span></span><br><span class="line"><span class="comment">Hibernate: update Cargo set name=? where id=?</span></span><br><span class="line"><span class="comment">数据是否改变false</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>
<h2 id="JPA-和-Hibernate-API-通过-unwrap-互相转"><a href="#JPA-和-Hibernate-API-通过-unwrap-互相转" class="headerlink" title="JPA 和 Hibernate API 通过 unwrap 互相转"></a>JPA 和 Hibernate API 通过 unwrap 互相转</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">var</span> <span class="variable">context</span> <span class="operator">=</span> session.unwrap(SessionImplementor.class).getPersistenceContext();</span><br><span class="line"><span class="type">var</span> <span class="variable">entityManager</span> <span class="operator">=</span>session.unwrap(EntityManager.class);</span><br><span class="line"><span class="keyword">var</span> sessionFactory=session.getEntityManagerFactory().unwrap(SessionFactory.class);</span><br></pre></td></tr></table></figure>


<h2 id="对象的状态"><a href="#对象的状态" class="headerlink" title="对象的状态"></a>对象的状态</h2><p><font color=blue>session 的主要工作就是让实体对象在不同的状态之间进行互相切换</font></p>
<ol>
<li><p>瞬时状态：实体-没有ID，没有与Session关联</p>
</li>
<li><p>持久化状态：实体-有ID，与Session关联，特点：持久化状态对象的任何改变都会同步到数据库中<br>在Hibernate中，持久对象是具有数据库标识且在Session中的实例，持久对象有一个主键值设为数据库标识符。持久对象可能来自瞬时对象被save或saveOrUpdate之后形成，也可能是通过get()或load()等方法从数据库中检索出来的对象。</p>
</li>
<li><p>游离态：实体-有ID，没有与Session关联.游离态实例表示曾经与某个持久化上下文发生过关联，不过那个上下文被关闭了。它拥有持久化标识，并且在数据库中通常还存在一个对应的行，只是它已经不在持久化层的管理之下。</p>
</li>
<li><p>删除状态</p>
</li>
</ol>
<h3 id="EntityEntry-上下文跟踪的实体信息对象"><a href="#EntityEntry-上下文跟踪的实体信息对象" class="headerlink" title="EntityEntry 上下文跟踪的实体信息对象"></a>EntityEntry 上下文跟踪的实体信息对象</h3><h3 id="脏数据及对象的缓存"><a href="#脏数据及对象的缓存" class="headerlink" title="脏数据及对象的缓存"></a>脏数据及对象的缓存</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">session.beginTransaction();</span><br><span class="line"> <span class="keyword">var</span> context=session.unwrap(SessionImplementor.class).getPersistenceContext();</span><br><span class="line"> <span class="comment">//查询当前可管理实体</span></span><br><span class="line"> System.out.println(<span class="string">&quot;管理的实体个数：&quot;</span>+context.getNumberOfManagedEntities());</span><br><span class="line"> Arrays.stream(Config.getManagedEntities(context)).forEach(p-&gt;&#123;</span><br><span class="line">   System.out.println(p.getKey());</span><br><span class="line">   System.out.println(p.getValue());</span><br><span class="line"> &#125;);</span><br><span class="line"></span><br><span class="line"> <span class="type">var</span> <span class="variable">cargo</span> <span class="operator">=</span> session.get(Cargo.class,<span class="number">1</span>);</span><br><span class="line"> cargo.setName(<span class="string">&quot;tool&quot;</span>);</span><br><span class="line"> System.out.println(<span class="string">&quot;session 是否有脏数据:&quot;</span>+session.isDirty());</span><br><span class="line"> <span class="comment">//属性缓存的作用，根据缓存的状态，提前生成SQL 语句，但是不会执行，执行要提交事务的时候</span></span><br><span class="line"> <span class="comment">//会生成 更新语句,同时会更新缓存的状态</span></span><br><span class="line"> session.flush();</span><br><span class="line"></span><br><span class="line"> System.out.println(<span class="string">&quot;session 是否有脏数据:&quot;</span>+session.isDirty());</span><br><span class="line"></span><br><span class="line"> <span class="comment">//会在缓存里找数据</span></span><br><span class="line"> <span class="type">var</span> <span class="variable">cargo1</span> <span class="operator">=</span> session.get(Cargo.class,<span class="number">1</span>);</span><br><span class="line"> System.out.println(cargo.equals(cargo1));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> System.out.println(<span class="string">&quot;管理的实体个数：&quot;</span>+context.getNumberOfManagedEntities());</span><br><span class="line"> Arrays.stream(Config.getManagedEntities(context)).forEach(p-&gt;&#123;</span><br><span class="line">   System.out.println(p.getKey());</span><br><span class="line">   System.out.println(p.getValue());</span><br><span class="line"> &#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> session.getTransaction().commit();</span><br></pre></td></tr></table></figure>

<h3 id="清除管理的实体"><a href="#清除管理的实体" class="headerlink" title="清除管理的实体"></a>清除管理的实体</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">session.beginTransaction();</span><br><span class="line"><span class="keyword">var</span> context=session.unwrap(SessionImplementor.class).getPersistenceContext();</span><br><span class="line"><span class="comment">//查询当前可管理实体</span></span><br><span class="line">System.out.println(<span class="string">&quot;管理的实体个数：&quot;</span>+context.getNumberOfManagedEntities());</span><br><span class="line">Arrays.stream(Config.getManagedEntities(context)).forEach(p-&gt;&#123;</span><br><span class="line">  System.out.println(p.getKey());</span><br><span class="line">  System.out.println(p.getValue());</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="type">var</span> <span class="variable">cargo</span> <span class="operator">=</span> session.get(Cargo.class,<span class="number">1</span>);</span><br><span class="line">cargo.setName(<span class="string">&quot;tools&quot;</span>);</span><br><span class="line">System.out.println(<span class="string">&quot;session 是否有脏数据:&quot;</span>+session.isDirty());</span><br><span class="line"></span><br><span class="line"><span class="comment">//清除 session 管理的所有实体</span></span><br><span class="line">session.clear();</span><br><span class="line"></span><br><span class="line">System.out.println(<span class="string">&quot;管理的实体个数：&quot;</span>+context.getNumberOfManagedEntities());</span><br><span class="line">Arrays.stream(Config.getManagedEntities(context)).forEach(p-&gt;&#123;</span><br><span class="line">  System.out.println(p.getKey());</span><br><span class="line">  System.out.println(p.getValue());</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="type">var</span> <span class="variable">cargo1</span> <span class="operator">=</span> session.get(Cargo.class,<span class="number">1</span>);</span><br><span class="line">System.out.println(cargo1.getName());</span><br><span class="line">System.out.println(<span class="string">&quot;是否是缓存:&quot;</span>+cargo.equals(cargo1));</span><br><span class="line"></span><br><span class="line">System.out.println(<span class="string">&quot;管理的实体个数：&quot;</span>+context.getNumberOfManagedEntities());</span><br><span class="line">Arrays.stream(Config.getManagedEntities(context)).forEach(p-&gt;&#123;</span><br><span class="line">  System.out.println(p.getKey());</span><br><span class="line">  System.out.println(p.getValue());</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">管理的实体个数：0</span></span><br><span class="line"><span class="comment">Hibernate: select cargo0_.id as id1_0_0_, cargo0_.name as name2_0_0_ from Cargo cargo0_ where cargo0_.id=?</span></span><br><span class="line"><span class="comment">session 是否有脏数据:true</span></span><br><span class="line"><span class="comment">管理的实体个数：0</span></span><br><span class="line"><span class="comment">Hibernate: select cargo0_.id as id1_0_0_, cargo0_.name as name2_0_0_ from Cargo cargo0_ where cargo0_.id=?</span></span><br><span class="line"><span class="comment">tool</span></span><br><span class="line"><span class="comment">是否是缓存:false</span></span><br><span class="line"><span class="comment">管理的实体个数：1</span></span><br><span class="line"><span class="comment">com.hank.entity.Cargo@4f4c88f9</span></span><br><span class="line"><span class="comment">EntityEntry[com.hank.entity.Cargo#1](MANAGED)   </span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<h3 id="evict-在-session-缓存中清除一个持久化对象"><a href="#evict-在-session-缓存中清除一个持久化对象" class="headerlink" title="evict 在 session 缓存中清除一个持久化对象"></a>evict 在 session 缓存中清除一个持久化对象</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> cargo=session.get(Cargo.class,<span class="number">1</span>);</span><br><span class="line">session.evict(cargo);</span><br><span class="line"><span class="comment">//jpa 方法 detach 同样的效果</span></span><br><span class="line"><span class="comment">//session.detach(cargo);</span></span><br><span class="line">System.out.println(<span class="string">&quot;管理的实体个数：&quot;</span>+context.getNumberOfManagedEntities());</span><br><span class="line">  Arrays.stream(Config.getManagedEntities(context)).forEach(p-&gt;&#123;</span><br><span class="line">  System.out.println(p.getKey());</span><br><span class="line">  System.out.println(p.getValue());</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">//1</span></span><br></pre></td></tr></table></figure>

<h2 id="session-对象"><a href="#session-对象" class="headerlink" title="session 对象"></a>session 对象</h2><h3 id="get-load-区别"><a href="#get-load-区别" class="headerlink" title="get , load 区别"></a>get , load 区别</h3><p>get 立即加载,load 延迟加载</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">session.beginTransaction();</span><br><span class="line"><span class="keyword">var</span> context=session.unwrap(SessionImplementor.class).getPersistenceContext();</span><br><span class="line"></span><br><span class="line"><span class="comment">//查询当前可管理实体</span></span><br><span class="line">System.out.println(<span class="string">&quot;管理的实体个数：&quot;</span>+context.getNumberOfManagedEntities());</span><br><span class="line">Arrays.stream(Config.getManagedEntities(context)).forEach(p-&gt;&#123;</span><br><span class="line">  System.out.println(p.getKey());</span><br><span class="line">  System.out.println(p.getValue());</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//立即加载</span></span><br><span class="line"><span class="keyword">var</span> cargo1=session.get(Cargo.class,<span class="number">1</span>);</span><br><span class="line"><span class="comment">//懒加载,在使用属性的时候才会加载</span></span><br><span class="line"><span class="keyword">var</span> cargo2=session.load(Cargo.class,<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//查询当前可管理实体</span></span><br><span class="line">System.out.println(<span class="string">&quot;管理的实体个数：&quot;</span>+context.getNumberOfManagedEntities());</span><br><span class="line">Arrays.stream(Config.getManagedEntities(context)).forEach(p-&gt;&#123;</span><br><span class="line">  System.out.println(p.getKey());</span><br><span class="line">  System.out.println(p.getValue());</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">//使用属性的时候才加载</span></span><br><span class="line">System.out.println(cargo2);</span><br><span class="line"></span><br><span class="line"><span class="comment">//查询当前可管理实体</span></span><br><span class="line">System.out.println(<span class="string">&quot;管理的实体个数：&quot;</span>+context.getNumberOfManagedEntities());</span><br><span class="line">Arrays.stream(Config.getManagedEntities(context)).forEach(p-&gt;&#123;</span><br><span class="line">  System.out.println(p.getKey());</span><br><span class="line">  System.out.println(p.getValue());</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">session.getTransaction().commit();</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">  管理的实体个数：0</span></span><br><span class="line"><span class="comment">  Hibernate: select cargo0_.id as id1_0_0_, cargo0_.name as name2_0_0_ from Cargo cargo0_ where cargo0_.id=?</span></span><br><span class="line"><span class="comment">  管理的实体个数：1</span></span><br><span class="line"><span class="comment">  com.hank.entity.Cargo@4f327096</span></span><br><span class="line"><span class="comment">  EntityEntry[com.hank.entity.Cargo#1](MANAGED)</span></span><br><span class="line"><span class="comment">  Hibernate: select cargo0_.id as id1_0_0_, cargo0_.name as name2_0_0_ from Cargo cargo0_ where cargo0_.id=?</span></span><br><span class="line"><span class="comment">  com.hank.entity.Cargo@75e09567</span></span><br><span class="line"><span class="comment">  管理的实体个数：2</span></span><br><span class="line"><span class="comment">  com.hank.entity.Cargo@4f327096</span></span><br><span class="line"><span class="comment">  EntityEntry[com.hank.entity.Cargo#1](MANAGED)</span></span><br><span class="line"><span class="comment">  com.hank.entity.Cargo@75e09567</span></span><br><span class="line"><span class="comment">  EntityEntry[com.hank.entity.Cargo#2](MANAGED)</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<h3 id="update-merge-区别"><a href="#update-merge-区别" class="headerlink" title="update , merge 区别"></a>update , merge 区别</h3><p><em>注意点</em>：</p>
<ol>
<li><p>update<br>更新 dispatch 对象，此对象会变成持久对象<br>更新 persistent 对象没有意义<br>更新 transient 对象，如果此对象有id，更新后除了设定更新的字段，其他字段会重置成null,无id 不能执行会报错</p>
</li>
<li><p>merge<br>更新 transient 对象，如果此对象有id，数据库有记录就进行更新数据库，无记录插入数据<br>更新 persistent 对象没有意义</p>
</li>
</ol>
<h3 id="save-persist-区别"><a href="#save-persist-区别" class="headerlink" title="save , persist 区别"></a>save , persist 区别</h3><p>persist 不会立即执行sql,所以拿不到数据库返回的 id ,save 会立即执行 sql,可以立即拿到数据库返回的 id</p>
<h3 id="批量更新"><a href="#批量更新" class="headerlink" title="批量更新"></a>批量更新</h3><p>批量更新，并且不会再访问的对象。具体的做法是在处理完一个对象或小批量对象后，立刻调用flush()方法清理缓存，然后再调用clear()方法 或 evict 方法清空缓存</p>
<p><font color=blue>普通的批量更新</font></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"> session.beginTransaction();</span><br><span class="line">  <span class="keyword">var</span> context=session.unwrap(SessionImplementor.class).getPersistenceContext();</span><br><span class="line"></span><br><span class="line">  <span class="comment">//查询当前可管理实体</span></span><br><span class="line">  System.out.println(<span class="string">&quot;管理的实体个数：&quot;</span>+context.getNumberOfManagedEntities());</span><br><span class="line">  Arrays.stream(Config.getManagedEntities(context)).forEach(p-&gt;&#123;</span><br><span class="line">    System.out.println(p.getKey());</span><br><span class="line">    System.out.println(p.getValue());</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="comment">//批量更新，如果批量数据比较大，缓存里不清空是比较危险的</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>; i &lt; <span class="number">9</span>; i++) &#123;</span><br><span class="line">    <span class="keyword">var</span> cargo=session.get(Cargo.class,i);</span><br><span class="line">    cargo.setName(LocalDateTime.now().toString());</span><br><span class="line">    <span class="comment">//生成 sql 语句</span></span><br><span class="line">    session.flush();</span><br><span class="line">    <span class="comment">// 删除缓存里的记录</span></span><br><span class="line">    session.evict(cargo);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//查询当前可管理实体</span></span><br><span class="line">  System.out.println(<span class="string">&quot;管理的实体个数：&quot;</span>+context.getNumberOfManagedEntities());</span><br><span class="line">  Arrays.stream(Config.getManagedEntities(context)).forEach(p-&gt;&#123;</span><br><span class="line">    System.out.println(p.getKey());</span><br><span class="line">    System.out.println(p.getValue());</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="comment">//一次性把所有 sql 语句发给数据库</span></span><br><span class="line">  session.getTransaction().commit();</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p><font color=blue>通过 HQL 的批量操作,是在数据库完成 .scroll 方法返回的是游标，只有真正访问对象的时候才会去查询对象</font></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//返回的是游标</span></span><br><span class="line"><span class="keyword">var</span> scroll= session.createQuery(<span class="string">&quot;from Cargo &quot;</span>).scroll(ScrollMode.FORWARD_ONLY);</span><br><span class="line"><span class="keyword">while</span> (scroll.next())&#123;</span><br><span class="line">  <span class="comment">//查询对象</span></span><br><span class="line">  <span class="type">var</span> <span class="variable">cargo</span> <span class="operator">=</span>(Cargo) scroll.get()[<span class="number">0</span>];</span><br><span class="line">  cargo.setName(LocalDateTime.now().toString());</span><br><span class="line">  session.flush();</span><br><span class="line">  session.clear();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="spring-data-jpa"><a href="#spring-data-jpa" class="headerlink" title="spring data jpa"></a>spring data jpa</h1><p>需要的依赖</p>
<p>父模块引入 spring-data-bom 方便子模块的版本管理</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 在父级声明需要的依赖，通过这种关系可以引入多个父类  parent 标签只能引入一个父类   --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.data<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-data-bom<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>2021.1.10<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencyManagement</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>子模块</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.data<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-data-jpa<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>8.0.30<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.zaxxer<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>HikariCP<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.0.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.hibernate<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hibernate-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.6.14.Final<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-autoconfigure<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.7.5<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>


<p>实体类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="meta">@Setter</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Person</span> &#123;</span><br><span class="line">  <span class="meta">@Id</span></span><br><span class="line">  <span class="meta">@Column(name = &quot;id&quot;, nullable = false)</span></span><br><span class="line">  <span class="meta">@GeneratedValue(strategy = GenerationType.IDENTITY)</span></span><br><span class="line">  <span class="keyword">private</span> <span class="type">int</span> id;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Column(name = &quot;name&quot;, nullable = true)</span></span><br><span class="line">  String name;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>spring data jpa 配置类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ConfigerDB</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 配置数据源</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="meta">@Bean(&quot;dataSource&quot;)</span></span><br><span class="line">  <span class="keyword">public</span> DataSource <span class="title function_">getDataSource</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">var</span> <span class="variable">dataSource</span> <span class="operator">=</span> DataSourceBuilder.create();</span><br><span class="line">    dataSource.url(<span class="string">&quot;jdbc:mysql://localhost:3306/MyDB&quot;</span>);</span><br><span class="line">    dataSource.driverClassName(<span class="string">&quot;com.mysql.cj.jdbc.Driver&quot;</span>);</span><br><span class="line">    dataSource.username(<span class="string">&quot;root&quot;</span>);</span><br><span class="line">    dataSource.password(<span class="string">&quot;root&quot;</span>);</span><br><span class="line">    <span class="comment">//连接池，演示目的不设置参数了</span></span><br><span class="line">    <span class="type">var</span> <span class="variable">pool</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HikariDataSource</span>();</span><br><span class="line">    pool.setDataSource(dataSource.build());</span><br><span class="line">    <span class="keyword">return</span> pool;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 配置 jpa 属性</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="meta">@Bean(&quot;jpaProperties&quot;)</span></span><br><span class="line">  <span class="keyword">public</span> JpaProperties <span class="title function_">getJpaProperties</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">var</span> <span class="variable">jpaProperties</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JpaProperties</span>() &#123;</span><br><span class="line">    &#125;;</span><br><span class="line">    jpaProperties.setShowSql(<span class="literal">true</span>);</span><br><span class="line">    <span class="comment">//设置属性</span></span><br><span class="line">    jpaProperties.setProperties(<span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;() &#123;</span><br><span class="line">      &#123;</span><br><span class="line">        put(<span class="string">&quot;hibernate.hbm2ddl.auto&quot;</span>, <span class="string">&quot;update&quot;</span>);</span><br><span class="line">        put(<span class="string">&quot;hibernate.dialect&quot;</span>, <span class="string">&quot;org.hibernate.dialect.MySQL8Dialect&quot;</span>);</span><br><span class="line">        put(<span class="string">&quot;hibernate.show_sql&quot;</span>, <span class="string">&quot;true&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">return</span> jpaProperties;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 提供 jpa 的实现者</span></span><br><span class="line"><span class="comment">   * spring  boot  默认就包含了 Hibernate 的包</span></span><br><span class="line"><span class="comment">   * Hibernate对Jpa的实现</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="meta">@Bean(&quot;jpaVendorAdapter&quot;)</span></span><br><span class="line">  <span class="keyword">public</span> JpaVendorAdapter <span class="title function_">getJpaVendorAdapter</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">HibernateJpaVendorAdapter</span>();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 实体管理工厂</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> dataSource</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> jpaProperties</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> jpaVendorAdapter</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="meta">@Bean(&quot;myEntityManagerFactory&quot;)</span></span><br><span class="line">  <span class="meta">@Primary</span></span><br><span class="line">  <span class="keyword">public</span> LocalContainerEntityManagerFactoryBean <span class="title function_">getEntityManagerFactory</span><span class="params">(</span></span><br><span class="line"><span class="params">      DataSource dataSource, JpaProperties jpaProperties, JpaVendorAdapter jpaVendorAdapter)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">var</span> <span class="variable">localContainerEntityManagerFactoryBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">LocalContainerEntityManagerFactoryBean</span>();</span><br><span class="line"></span><br><span class="line">    localContainerEntityManagerFactoryBean.setDataSource(dataSource);</span><br><span class="line">    localContainerEntityManagerFactoryBean.setJpaVendorAdapter(jpaVendorAdapter);</span><br><span class="line">    localContainerEntityManagerFactoryBean.setJpaPropertyMap(jpaProperties.getProperties());</span><br><span class="line">    localContainerEntityManagerFactoryBean.setPersistenceUnitName(<span class="string">&quot;myPersistenceUnitName&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//指定扫描的实体所在的包路径</span></span><br><span class="line">    localContainerEntityManagerFactoryBean.setPackagesToScan(<span class="string">&quot;com.hank.entityModel&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> localContainerEntityManagerFactoryBean;</span><br><span class="line">  &#125;</span><br><span class="line">   </span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * spring 需要的事务</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> myEntityManagerFactory</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="meta">@Bean(&quot;jdbcTransactionManager&quot;)</span></span><br><span class="line">  <span class="keyword">public</span> JpaTransactionManager <span class="title function_">getJdbcTransactionManager</span><span class="params">(LocalContainerEntityManagerFactoryBean myEntityManagerFactory)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">JpaTransactionManager</span>(myEntityManagerFactory.getObject());</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="按照-JPA-的方式使用"><a href="#按照-JPA-的方式使用" class="headerlink" title="按照 JPA 的方式使用"></a>按照 JPA 的方式使用</h2><p>如下代理在 spring jpa 里可以完全按照 jpa 规范使用</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ComponentScan(&#123;&quot;com.hank&quot;&#125;)</span></span><br><span class="line"><span class="meta">@EnableTransactionManagement</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Programmer</span> &#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="type">var</span> <span class="variable">context</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AnnotationConfigApplicationContext</span>(Programmer.class);</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="comment">//这里不能通过字符串获取 bean ，因为这样获取到的是代理对象</span></span><br><span class="line">      <span class="type">var</span> <span class="variable">localContainerEntityManagerFactoryBean</span> <span class="operator">=</span> context.getBean(LocalContainerEntityManagerFactoryBean.class);</span><br><span class="line"></span><br><span class="line">      </span><br><span class="line">      <span class="comment">//读取数据并在事务里修改数据</span></span><br><span class="line">      &#123;</span><br><span class="line">        <span class="type">var</span> <span class="variable">entityManager</span> <span class="operator">=</span>localContainerEntityManagerFactoryBean.getObject().createEntityManager();</span><br><span class="line">        <span class="keyword">var</span> transaction=entityManager.getTransaction();</span><br><span class="line">        transaction.begin();</span><br><span class="line"></span><br><span class="line">        System.out.println(entityManager);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> person= entityManager.find(Person.class,<span class="number">1</span>);</span><br><span class="line">        System.out.println(person.getName());</span><br><span class="line">        person.setName(LocalDateTime.now().toString());</span><br><span class="line">        transaction.commit();</span><br><span class="line">        entityManager.close();</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">//读取上面事务代码修改的数据</span></span><br><span class="line">      &#123;</span><br><span class="line">        <span class="type">var</span> <span class="variable">entityManager</span> <span class="operator">=</span>localContainerEntityManagerFactoryBean.getObject().createEntityManager();</span><br><span class="line">        System.out.println(entityManager);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> person= entityManager.find(Person.class,<span class="number">1</span>);</span><br><span class="line">        System.out.println(person.getName());</span><br><span class="line">        entityManager.close();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">SessionImpl(518349613&lt;open&gt;)</span></span><br><span class="line"><span class="comment">2022-12-07T11:14:06.420353</span></span><br><span class="line"><span class="comment">SessionImpl(5998675&lt;open&gt;)</span></span><br><span class="line"><span class="comment">2022-12-07T11:30:04.118294800</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>


<h2 id="测试-spring-data-里的事务"><a href="#测试-spring-data-里的事务" class="headerlink" title="测试 spring data 里的事务"></a>测试 spring data 里的事务</h2><p>注意点：</p>
<ol>
<li>@PersistenceContext 获取  EntityManager 代理，是线程安全的</li>
<li>@PersistenceUnit   获取 EntityManagerFactory </li>
</ol>
<p>测试用例</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Dao</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 这里获取的是 EntityManager 代理</span></span><br><span class="line"><span class="comment">   * Shared EntityManager proxy for target factory </span></span><br><span class="line"><span class="comment">   * [org.springframework.orm.jpa.LocalContainerEntityManagerFactoryBean@401c4250]</span></span><br><span class="line"><span class="comment">   * 如果有多个持久化单元，需要指定持久化单元的名字 --myEntityManagerFactory</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="meta">@PersistenceContext(unitName = &quot;myEntityManagerFactory&quot;)</span></span><br><span class="line">  <span class="keyword">private</span> EntityManager entityManager;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * org.springframework.orm.jpa.LocalContainerEntityManagerFactoryBean@401c4250</span></span><br><span class="line"><span class="comment">   * 如果有多个持久化单元，需要指定持久化单元的名字 --myEntityManagerFactory</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="meta">@PersistenceUnit(unitName = &quot;myEntityManagerFactory&quot;)</span></span><br><span class="line">  <span class="keyword">private</span> EntityManagerFactory entityManagerFactory;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Transactional(&quot;jdbcTransactionManager&quot;)</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">func1</span><span class="params">()</span> &#123;</span><br><span class="line">    System.out.println(entityManager);</span><br><span class="line">    <span class="comment">//entityManager 是代理对象</span></span><br><span class="line">    <span class="comment">//entityManager 代理对象不能像 func2 那样使用事务，需要按照 spring 事务的使用方式使用</span></span><br><span class="line">    <span class="type">var</span> <span class="variable">person</span> <span class="operator">=</span> entityManager.find(Person.class, <span class="number">1</span>);</span><br><span class="line">    person.setName(LocalDateTime.now().toString());</span><br><span class="line">    System.out.println(<span class="string">&quot;设置数值:&quot;</span> + person.getName());</span><br><span class="line">    entityManager.close();</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 验证 func1 事务</span></span><br><span class="line"><span class="comment">   * 在本方法里手动开启事务</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">func2</span><span class="params">()</span> &#123;</span><br><span class="line">    System.out.println(entityManagerFactory);</span><br><span class="line">    <span class="type">var</span> <span class="variable">entityManager</span> <span class="operator">=</span> entityManagerFactory.createEntityManager();</span><br><span class="line">    System.out.println(entityManager);</span><br><span class="line">    <span class="comment">//SessionImpl(1337346642&lt;open&gt;)</span></span><br><span class="line">    <span class="comment">//此处不是代理对象，不能使用 spring 的事务需要自己开启事务</span></span><br><span class="line">    <span class="keyword">var</span> transaction=entityManager.getTransaction();</span><br><span class="line">    transaction.begin();</span><br><span class="line"></span><br><span class="line">    <span class="type">var</span> <span class="variable">person</span> <span class="operator">=</span> entityManager.find(Person.class, <span class="number">1</span>);</span><br><span class="line">    System.out.println(<span class="string">&quot;读取数值:&quot;</span> + person.getName());</span><br><span class="line"></span><br><span class="line">    person.setName(LocalDateTime.now().toString());</span><br><span class="line">    System.out.println(<span class="string">&quot;设置数值:&quot;</span> + person.getName());</span><br><span class="line"></span><br><span class="line">    transaction.commit();</span><br><span class="line"></span><br><span class="line">    entityManager.close();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 验证 func2 手动开启的事务</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">func3</span><span class="params">()</span> &#123;</span><br><span class="line">    System.out.println(entityManagerFactory);</span><br><span class="line">    <span class="type">var</span> <span class="variable">entityManager</span> <span class="operator">=</span> entityManagerFactory.createEntityManager();</span><br><span class="line">    System.out.println(entityManager);</span><br><span class="line">    <span class="comment">//SessionImpl(789367604&lt;open&gt;)</span></span><br><span class="line"></span><br><span class="line">    <span class="type">var</span> <span class="variable">person</span> <span class="operator">=</span> entityManager.find(Person.class, <span class="number">1</span>);</span><br><span class="line">    System.out.println(<span class="string">&quot;读取数值:&quot;</span> + person.getName());</span><br><span class="line"></span><br><span class="line">    entityManager.close();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ComponentScan(&#123;&quot;com.hank&quot;&#125;)</span></span><br><span class="line"><span class="meta">@EnableTransactionManagement</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Programmer</span> &#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="type">var</span> <span class="variable">context</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AnnotationConfigApplicationContext</span>(Programmer.class);</span><br><span class="line"></span><br><span class="line">    context.getBean(Dao.class).func1();</span><br><span class="line"></span><br><span class="line">    context.getBean(Dao.class).func2();</span><br><span class="line"></span><br><span class="line">    context.getBean(Dao.class).func3();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">  Shared EntityManager proxy for target factory [org.springframework.orm.jpa.LocalContainerEntityManagerFactoryBean@401c4250]</span></span><br><span class="line"><span class="comment">  设置数值:2022-12-07T11:14:06.381306600</span></span><br><span class="line"><span class="comment">  org.springframework.orm.jpa.LocalContainerEntityManagerFactoryBean@401c4250</span></span><br><span class="line"><span class="comment">  SessionImpl(1337346642&lt;open&gt;)</span></span><br><span class="line"><span class="comment">  读取数值:2022-12-07T11:14:06.381306600</span></span><br><span class="line"><span class="comment">  设置数值:2022-12-07T11:14:06.420353</span></span><br><span class="line"><span class="comment">  org.springframework.orm.jpa.LocalContainerEntityManagerFactoryBean@401c4250</span></span><br><span class="line"><span class="comment">  SessionImpl(789367604&lt;open&gt;)</span></span><br><span class="line"><span class="comment">  读取数值:2022-12-07T11:14:06.420353</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="spring-data-jpa-拓展"><a href="#spring-data-jpa-拓展" class="headerlink" title="spring data jpa 拓展"></a>spring data jpa 拓展</h2><h3 id="Repository-及其子类"><a href="#Repository-及其子类" class="headerlink" title="Repository 及其子类"></a>Repository 及其子类</h3><p>Repository&lt;T,ID&gt; 位于Spring Data Common的lib里面，是Spring Data 里面做数据库操作的最底层的抽象接口、最顶级的父类，源码里面其实什么方法都没有，仅仅起到一个标识作用。管理域类以及域类的id类型作为类型参数，此接口主要作为标记接口捕获要使用的类型，并帮助你发现扩展此接口的接口。能够在类路径扫描期间发现扩展该类型的接口.Spring底层做动态代理的时候发现只要是它的子类或者实现类，都代表储存库操作</p>
<p><img src="/SimpleJpaRepository.png" alt="Repository&lt;T,ID&gt; 类型关系图"></p>
<p>注意：</p>
<ol>
<li>@NoRepositoryBean 在接口或对象上加此注解的 jpa 存储库,不会注入 spring ioc</li>
<li>@Repository 如果在加了 @NoRepositoryBean 接口的实现类注入 spring ioc ,要把 @Repository 加载类或接口上</li>
<li>为什么存储库的方法只用会有事务，因为 SimpleJpaRepository 实现类上加了注解 @Transactional</li>
</ol>
<p>Repository 大类：</p>
<ol>
<li>ReactiveCrudRepository,响应式编程,主要支持当前 NoSQL 方面的操作,因为这方面大部分操作都是分布式的,目前 Reactive 主要有 Cassandra、MongoDB、Redis 的实现。</li>
<li>CoroutineCrudRepository ：为了支持 Kotlin 语法而实现的。</li>
<li>CrudRepository ：JPA 相关的操作接口，也是我们主要用到的接口</li>
</ol>
<p>更详细一点，我们需要掌握和使用到的7 大 Repository 接口如下所示：</p>
<ol>
<li>Repository(org.springframework.data.repository)，没有暴露任何方法；</li>
<li>CrudRepository(org.springframework.data.repository)，简单的 Curd 方法；</li>
<li>PagingAndSortingRepository(org.springframework.data.repository)，带分页和排序的方法；</li>
<li>QueryByExampleExecutor(org.springframework.data.repository.query)，简单 Example 查询；</li>
<li>JpaRepository(org.springframework.data.jpa.repository)，JPA 的扩展方法；</li>
<li>JpaSpecificationExecutor(org.springframework.data.jpa.repository)，JpaSpecification 扩展查询；</li>
</ol>
<p>两大 Repository 实现类：</p>
<ol>
<li>SimpleJpaRepository(org.springframework.data.jpa.repository.support)，JPA 所有接口的默认实现类；</li>
</ol>
<p>第三方的 QueryDsl 在 JPA 和 spring data 的基础上扩展的第三方查询库：</p>
<ol>
<li>接口 QueryDslPredicateExecutor(org.springframework.data.querydsl)，QueryDsl 的封装</li>
<li>实现 QueryDslJpaRepository(org.springframework.data.jpa.repository.support)，QueryDsl 的实现类</li>
</ol>
<h3 id="spring-扩展的方法"><a href="#spring-扩展的方法" class="headerlink" title="spring 扩展的方法"></a>spring 扩展的方法</h3><p>@NamedQuery、@Query和方法定义查询的对比：</p>
<ol>
<li>Spring JPA里面的优先级，@Query &gt; @NameQuery &gt; 方法定义查询。</li>
<li>推荐使用的优先级：@Query &gt; 方法定义查询 &gt; @NameQuery。</li>
<li>相同点是都不支持动态条件查询。</li>
</ol>
<p>方法的查询策略设置<br>@EnableJpaRepositories 注解来配置方法的查询策略，详细配置方法如下：<br>@EnableJpaRepositories(queryLookupStrategy= QueryLookupStrategy.Key.CREATE_IF_NOT_FOUND)</p>
<p>其中，QueryLookupStrategy.Key 的值共 3 个，具体如下：</p>
<ol>
<li>Create：直接根据方法名进行创建，规则是根据方法名称的构造进行尝试，一般的方法是从方法名中删除给定的一组已知前缀，并解析该方法的其余部分。如果方法名不符合规则，<br>启动的时候会报异常，这种情况可以理解为，即使配置了 @Query 也是没有用的。</li>
<li>USE_DECLARED_QUERY：声明方式创建，启动的时候会尝试找到一个声明的查询，如果没有找到将抛出一个异常，可以理解为必须配置 @Query 或 @NameQuery</li>
<li>CREATE_IF_NOT_FOUND：这个是默认的，除非有特殊需求，可以理解为这是以上 2 种方式的兼容版。先用声明方式（@Query 或 @NameQuery）进行查找，如果没有找到与方法相<br>匹配的查询，那用 Create 的方法名创建规则创建一个查询；这两者都不满足的情况下，启动就会报错。</li>
</ol>
<p><font color=blue>通过 @EnableJpaRepositories  注解需要提供 Repositories 包路径，entityManagerFactory 的beanName,transactionManager 的  beanName<br>此注解会扫描 Repository 及其子接口，并为其生成代理类，我们操作的是代理类</font></p>
<h4 id="Declared-Queries-方法定义查询-如果返回实体，不能返回实体的部分属性，而是全部属性"><a href="#Declared-Queries-方法定义查询-如果返回实体，不能返回实体的部分属性，而是全部属性" class="headerlink" title="Declared Queries -方法定义查询 ,如果返回实体，不能返回实体的部分属性，而是全部属性"></a>Declared Queries -方法定义查询 ,如果返回实体，不能返回实体的部分属性，而是全部属性</h4><p>方法定义查询的方法要定义在仓储接口里,有代理类用相应的接口的实现类去实现接口内自定义方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//@Indexed 提升 @CompoentScan 扫描的效率</span></span><br><span class="line"><span class="comment">//spring jpa 定义的 Repository 是个空接口</span></span><br><span class="line"><span class="meta">@Indexed</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Repository</span>&lt;T, ID&gt; &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">MyPersonRepository</span> <span class="keyword">extends</span> <span class="title class_">Repository</span>&lt;Person, Integer&gt; &#123;</span><br><span class="line">    <span class="comment">//方法定义查询，要以固定的前缀开头加属性表达式结尾</span></span><br><span class="line">    <span class="keyword">public</span> Person <span class="title function_">findDistinctByName</span><span class="params">(String name)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><em>这种方法个人感觉不好用，属于死记硬背的做法,而且写错也没办法在编译的时候，检查出错误</em></p>
<p>属性表达式（Property Expressions）(findByAddressZipCode) 只能引用托管（泛化）实体的直接属性，如前一个示例所示。在查询创建时，你已经确保解析的属性是托管实体的属性。同时，还可以通过遍历嵌套属性定义约束。假设一个Person实体对象里面有一个Address属性里面包含一个ZipCode属性。在这种情况下，方法名为：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">List&lt;Person&gt; <span class="title function_">findByAddressZipCode</span><span class="params">(string zipCode)</span></span><br><span class="line"><span class="comment">//或</span></span><br><span class="line">List&lt;Person&gt; <span class="title function_">findByAddress_ZipCode</span><span class="params">(string zipCode)</span></span><br></pre></td></tr></table></figure>

<p><font color=blue>声明的查询支持的前缀</font></p>
<table>
<thead>
<tr>
<th>关键词</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>find, get, query, stream</td>
<td>查询所有的字段</td>
</tr>
<tr>
<td>count</td>
<td>统计数量</td>
</tr>
<tr>
<td>exists</td>
<td>是否存在</td>
</tr>
<tr>
<td>delete , remove</td>
<td>移除</td>
</tr>
<tr>
<td>save</td>
<td>保存或更新</td>
</tr>
</tbody></table>
<p><font color=blue>* 声明的查询支持的关键字， 在类 org.springframework.data.repository.query.parser.PartTree 定义*</font></p>
<table>
<thead>
<tr>
<th>关键词</th>
<th>举例</th>
</tr>
</thead>
<tbody><tr>
<td>Distinct</td>
<td>findDistinctByLastnameAndFirstname</td>
</tr>
<tr>
<td>And</td>
<td>findByLastnameAndFirstname</td>
</tr>
<tr>
<td>Or</td>
<td>findByLastnameOrFirstname</td>
</tr>
<tr>
<td>Is,Equals</td>
<td>findByFirstname, findByFirstnameIs,findByFirstnameEquals</td>
</tr>
<tr>
<td>Between</td>
<td>findByStartDateBetween</td>
</tr>
<tr>
<td>LessThan</td>
<td>findByAgeLessThan</td>
</tr>
<tr>
<td>LessThanEqual</td>
<td>findByAgeLessThanEqual</td>
</tr>
<tr>
<td>GreaterThan</td>
<td>findByAgeGreaterThan</td>
</tr>
<tr>
<td>GreaterThanEqual</td>
<td>findByAgeGreaterThanEqual</td>
</tr>
<tr>
<td>After</td>
<td>findByStartDateAfter</td>
</tr>
<tr>
<td>Before</td>
<td>findByStartDateBefore</td>
</tr>
<tr>
<td>IsNull,Null</td>
<td>findByAge(Is)Null</td>
</tr>
<tr>
<td>IsNotNull,NotNull</td>
<td>findByAge(Is)NotNull</td>
</tr>
<tr>
<td>Like</td>
<td>findByFirstnameLike</td>
</tr>
<tr>
<td>NotLike</td>
<td>findByFirstnameNotLike</td>
</tr>
<tr>
<td>StartingWith</td>
<td>findByFirstnameStartingWith</td>
</tr>
<tr>
<td>EndingWith</td>
<td>findByFirstnameEndingWith</td>
</tr>
<tr>
<td>Containing</td>
<td>findByFirstnameContaining</td>
</tr>
<tr>
<td>OrderBy</td>
<td>findByAgeOrderByLastnameDesc</td>
</tr>
<tr>
<td>Not</td>
<td>findByLastnameNot</td>
</tr>
<tr>
<td>In</td>
<td>findByAgeIn(Collection<Age> ages)</td>
</tr>
<tr>
<td>NotIn</td>
<td>findByAgeNotIn(Collection<Age> ages)</td>
</tr>
<tr>
<td>True</td>
<td>findByActiveTrue()</td>
</tr>
<tr>
<td>False</td>
<td>findByActiveFalse()</td>
</tr>
<tr>
<td>IgnoreCase</td>
<td>findByFirstnameIgnoreCase</td>
</tr>
</tbody></table>
<p>综上，总结 3 点经验：</p>
<ol>
<li>方法名的表达式通常是实体属性连接运算符的组合，如 And、or、Between、LessThan、GreaterThan、Like 等属性连接运算表达式，不同的数据库（NoSQL、MySQL）可能产生的效果不一样，如果遇到问题，我们可以打开 SQL 日志观察。</li>
<li>IgnoreCase 可以针对单个属性（如 findByLastnameIgnoreCase(…)），也可以针对查询条件里面所有的实体属性忽略大小写（所有属性必须在 String 情况下，如 findByLastnameAndFirstnameAllIgnoreCase(…)）。</li>
<li>OrderBy 可以在某些属性的排序上提供方向（Asc 或 Desc），称为静态排序，也可以通过一个方便的参数 Sort 实现指定字段的动态排序的查询方法（如 repository.findAll(Sort.by(Sort.Direction.ASC, “myField”))）。</li>
</ol>
<p>通过 @EnableJpaRepositories  注解需要提供 Repositories 包路径，entityManagerFactory 的beanName,transactionManager 的  beanName<br>此注解会扫描 Repository 及其子接口，并为其生成代理类，我们操作的是代理类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ComponentScan(&#123;&quot;com.hank&quot;&#125;)</span></span><br><span class="line"><span class="meta">@EnableTransactionManagement</span></span><br><span class="line"><span class="meta">@EnableJpaRepositories(</span></span><br><span class="line"><span class="meta">    basePackages = &#123;&quot;com.hank.Pesis&quot;&#125;,</span></span><br><span class="line"><span class="meta">    entityManagerFactoryRef = &quot;myEntityManagerFactory&quot;,</span></span><br><span class="line"><span class="meta">    transactionManagerRef = &quot;jdbcTransactionManager&quot;</span></span><br><span class="line"><span class="meta">)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Programmer</span> &#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">var</span>  <span class="variable">context</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AnnotationConfigApplicationContext</span>(Programmer.class);</span><br><span class="line"></span><br><span class="line">    <span class="type">var</span> <span class="variable">repository</span> <span class="operator">=</span> context.getBean(MyPersonRepository.class);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// true</span></span><br><span class="line">    System.out.println(Proxy.isProxyClass(repository.getClass()));</span><br><span class="line">    <span class="comment">//class com.sun.proxy.$Proxy62</span></span><br><span class="line">    System.out.println(repository.getClass());</span><br><span class="line">    <span class="comment">//org.springframework.data.jpa.repository.support.SimpleJpaRepository@2fac80a8</span></span><br><span class="line">    <span class="comment">//代理对象代理的实现类是 SimpleJpaRepository</span></span><br><span class="line">    System.out.println(repository);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//方法 findByName 的实现在 SimpleJpaRepository 类里</span></span><br><span class="line">    <span class="type">var</span> <span class="variable">person</span> <span class="operator">=</span>repository.findDistinctByName(<span class="string">&quot;ok&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Query-JPQL注解查询"><a href="#Query-JPQL注解查询" class="headerlink" title="@Query -JPQL注解查询"></a>@Query -JPQL注解查询</h4><p>@Query 属于JPQL 查询，同时也可以指定原生的 sql 查询方式（nativeQuery = true）,除过查询其他方法要加 @Modifying  注解<br>@Modifying(clearAutomatically = true) 作用是在做更新后立即清除当前缓存，并做一次数据库查询<br>参数的指定方式有：</p>
<ol>
<li>?1  传入的参数是方法的第一个参数 ,序号参数</li>
<li>:name  传入的参数是方法的参数上加 @Param(“name”) 注解的，命名参数</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">MyPersonRepository</span> <span class="keyword">extends</span> <span class="title class_">Repository</span>&lt;Person, Integer&gt; &#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//查询部分字段，相比较声明查询的优点</span></span><br><span class="line">  <span class="meta">@Query(&quot; select u.name from Person u where  u.id=1 and  u.name=?1&quot;)</span></span><br><span class="line">  <span class="keyword">public</span> String <span class="title function_">findByName1</span><span class="params">(String name)</span>;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Query(&quot;from Person u where  u.id=1 and  u.name=:name&quot;)</span></span><br><span class="line">  <span class="keyword">public</span> Person <span class="title function_">findByName2</span><span class="params">(<span class="meta">@Param(&quot;name&quot;)</span> String name)</span>;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">//原生查询</span></span><br><span class="line">  <span class="meta">@Query(value = &quot;select  * from Person u where  u.id=1 and  u.name=:name&quot;, nativeQuery = true)</span></span><br><span class="line">  <span class="keyword">public</span> Person <span class="title function_">findByName3</span><span class="params">(<span class="meta">@Param(&quot;name&quot;)</span> String name)</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//还可以传入对象 :#&#123;#person.name&#125; 属于 SpEL 表达式</span></span><br><span class="line">  <span class="meta">@Query(value = &quot;from Person u where  u.id=1 and  u.name=:#&#123;#person.name&#125;&quot;)</span></span><br><span class="line">  <span class="keyword">public</span> Person <span class="title function_">findByName4</span><span class="params">(<span class="meta">@Param(&quot;person&quot;)</span> Person person)</span>;</span><br><span class="line">   </span><br><span class="line">   <span class="comment">//更新</span></span><br><span class="line">  <span class="meta">@Modifying</span></span><br><span class="line">  <span class="meta">@Transactional</span></span><br><span class="line">  <span class="meta">@Query(value = &quot;update Person  u set u.name=?1 where u.id=?2 &quot;)</span></span><br><span class="line">  <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">updatePerson</span><span class="params">(String name,<span class="type">int</span> id)</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//删除</span></span><br><span class="line">  <span class="meta">@Modifying</span></span><br><span class="line">  <span class="meta">@Transactional</span></span><br><span class="line">  <span class="meta">@Query(value = &quot;delete  from Person u where  u.id=?1&quot;)</span></span><br><span class="line">  <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">deletePerson</span><span class="params">(<span class="type">int</span> id)</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//新增</span></span><br><span class="line">  <span class="meta">@Modifying</span></span><br><span class="line">  <span class="meta">@Transactional</span></span><br><span class="line">  <span class="meta">@Query(value = &quot;insert into Person (name)  values(?1) &quot;,nativeQuery = true)</span></span><br><span class="line">  <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">insetPerson</span><span class="params">(String name)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ComponentScan(&#123;&quot;com.hank&quot;&#125;)</span></span><br><span class="line"><span class="meta">@EnableJpaRepositories(</span></span><br><span class="line"><span class="meta">    basePackages = &#123;&quot;com.hank.Pesis&quot;&#125;,</span></span><br><span class="line"><span class="meta">    entityManagerFactoryRef = &quot;myEntityManagerFactory&quot;,</span></span><br><span class="line"><span class="meta">    transactionManagerRef = &quot;jdbcTransactionManager&quot;</span></span><br><span class="line"><span class="meta">)</span></span><br><span class="line"><span class="meta">@EnableTransactionManagement</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Programmer</span> &#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">var</span>  <span class="variable">context</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AnnotationConfigApplicationContext</span>(Programmer.class);</span><br><span class="line"></span><br><span class="line">    <span class="type">var</span> <span class="variable">repository</span> <span class="operator">=</span> context.getBean(MyPersonRepository.class);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// true</span></span><br><span class="line">    System.out.println(Proxy.isProxyClass(repository.getClass()));</span><br><span class="line">    <span class="comment">//class com.sun.proxy.$Proxy62</span></span><br><span class="line">    System.out.println(repository.getClass());</span><br><span class="line">    <span class="comment">//org.springframework.data.jpa.repository.support.SimpleJpaRepository@2fac80a8</span></span><br><span class="line">    <span class="comment">//代理对象代理的实现类是 SimpleJpaRepository</span></span><br><span class="line">    System.out.println(repository);</span><br><span class="line"></span><br><span class="line">    System.out.println(repository.findByName1(<span class="string">&quot;ok&quot;</span>));</span><br><span class="line">    System.out.println(repository.findByName2(<span class="string">&quot;ok&quot;</span>));</span><br><span class="line">    System.out.println(repository.findByName3(<span class="string">&quot;ok&quot;</span>));</span><br><span class="line">    System.out.println(repository.findByName4(<span class="keyword">new</span> <span class="title class_">Person</span>()&#123;&#123;setName(<span class="string">&quot;ok&quot;</span>);&#125;&#125;));</span><br><span class="line"></span><br><span class="line">    System.out.println(repository.updatePerson(<span class="string">&quot;ok&quot;</span>,<span class="number">1</span>));</span><br><span class="line">    System.out.println(repository.deletePerson(<span class="number">1</span>));</span><br><span class="line">    System.out.println(repository.insetPerson(<span class="string">&quot;bad&quot;</span>));</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">  true</span></span><br><span class="line"><span class="comment">  class com.sun.proxy.$Proxy66</span></span><br><span class="line"><span class="comment">  org.springframework.data.jpa.repository.support.SimpleJpaRepository@5112b7</span></span><br><span class="line"><span class="comment">  ok</span></span><br><span class="line"><span class="comment">  com.hank.entityModel.Person@333d44f6</span></span><br><span class="line"><span class="comment">  com.hank.entityModel.Person@32b112a1</span></span><br><span class="line"><span class="comment">  com.hank.entityModel.Person@678586f0</span></span><br><span class="line"><span class="comment">  1</span></span><br><span class="line"><span class="comment">  1</span></span><br><span class="line"><span class="comment">  1</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="SpEL-表达式"><a href="#SpEL-表达式" class="headerlink" title="SpEL 表达式"></a>SpEL 表达式</h5><p>在Spring Data JPA 1.4以后，支持在@Query中使用SpEL表达式（简介）来接收变量，这为使用 @Query 提供了更大的便利性</p>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">//还可以传入对象 :#&#123;#person.name&#125; 属于 SpEL 表达式</span></span><br><span class="line"> <span class="comment">//#&#123;#entity&#125; 表示的是 @Entity 指定的名字会 实体的类名</span></span><br><span class="line"><span class="meta">@Query(value = &quot;from #&#123;#entity&#125; u where  u.id=1 and  u.name=:#&#123;#person.name&#125;&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Person <span class="title function_">findByName4</span><span class="params">(<span class="meta">@Param(&quot;person&quot;)</span> Person person)</span>;</span><br></pre></td></tr></table></figure>


<h4 id="NamedQuery-命名查询"><a href="#NamedQuery-命名查询" class="headerlink" title="@NamedQuery-命名查询"></a>@NamedQuery-命名查询</h4><p>@NamedQuery注解定义的查询里写的也是 jpql,之相对应的还有@NamedNativeQuery 书写的是原生 sql<br>这种把查询方法定义在实体的方式用起来不优雅，一般不使用</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="meta">@Setter</span></span><br><span class="line"><span class="comment">//name = &quot;Person.myNamedQuery&quot;  用实体名称开头</span></span><br><span class="line"><span class="meta">@NamedQuery(name = &quot;Person.myNamedQuery&quot;,query = &quot;select c from Person c where c.id=?1&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Person</span> &#123;</span><br><span class="line">  <span class="meta">@Id</span></span><br><span class="line">  <span class="meta">@Column(name = &quot;id&quot;, nullable = false)</span></span><br><span class="line">  <span class="meta">@GeneratedValue(strategy = GenerationType.IDENTITY)</span></span><br><span class="line">  <span class="keyword">private</span> <span class="type">int</span> id;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Column(name = &quot;name&quot;, nullable = true)</span></span><br><span class="line">  String name;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="NamedStoredProcedureQueries-，-Procedure-命名查询的存储过程"><a href="#NamedStoredProcedureQueries-，-Procedure-命名查询的存储过程" class="headerlink" title="@NamedStoredProcedureQueries ， @Procedure 命名查询的存储过程"></a>@NamedStoredProcedureQueries ， @Procedure 命名查询的存储过程</h4><p>@NamedStoredProcedureQueries 必须加载一个实体上<br>@Procedure 加载方法上</p>
<h4 id="QueryByExampleExecutor-简单化的动态查询"><a href="#QueryByExampleExecutor-简单化的动态查询" class="headerlink" title="QueryByExampleExecutor 简单化的动态查询"></a>QueryByExampleExecutor 简单化的动态查询</h4><p><font color=blue>QueryByExampleExecutor 接口实现动态查询创建，并且不需要编写包含字段名称的查询，所谓动态查询是查询的字段不一定有几个，也可以传入排序和分页</font></p>
<p>提供一个实例作为动态查询条件<br>Query by Example 也有几个限制：</p>
<ol>
<li>不支持嵌套或分组的属性约束，例如firstname = ?0 or (firstname = ?1 and lastname = ?2)</li>
<li>仅支持字符串的 starts/contains/ends/regex 匹配和其他属性类型的精确匹配</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">QueryByExampleExecutor</span>&lt;T&gt; &#123;</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Returns a single entity matching the given &#123;<span class="doctag">@link</span> Example&#125; or &#123;<span class="doctag">@link</span> Optional#empty()&#125; if none was found.</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> example must not be &#123;<span class="doctag">@literal</span> null&#125;.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span> a single entity matching the given &#123;<span class="doctag">@link</span> Example&#125; or &#123;<span class="doctag">@link</span> Optional#empty()&#125; if none was found.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@throws</span> org.springframework.dao.IncorrectResultSizeDataAccessException if the Example yields more than one result.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	&lt;S <span class="keyword">extends</span> <span class="title class_">T</span>&gt; Optional&lt;S&gt; <span class="title function_">findOne</span><span class="params">(Example&lt;S&gt; example)</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Returns all entities matching the given &#123;<span class="doctag">@link</span> Example&#125;. In case no match could be found an empty &#123;<span class="doctag">@link</span> Iterable&#125;</span></span><br><span class="line"><span class="comment">	 * is returned.</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> example must not be &#123;<span class="doctag">@literal</span> null&#125;.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span> all entities matching the given &#123;<span class="doctag">@link</span> Example&#125;.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	&lt;S <span class="keyword">extends</span> <span class="title class_">T</span>&gt; Iterable&lt;S&gt; <span class="title function_">findAll</span><span class="params">(Example&lt;S&gt; example)</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Returns all entities matching the given &#123;<span class="doctag">@link</span> Example&#125; applying the given &#123;<span class="doctag">@link</span> Sort&#125;. In case no match could be</span></span><br><span class="line"><span class="comment">	 * found an empty &#123;<span class="doctag">@link</span> Iterable&#125; is returned.</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> example must not be &#123;<span class="doctag">@literal</span> null&#125;.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> sort the &#123;<span class="doctag">@link</span> Sort&#125; specification to sort the results by, may be &#123;<span class="doctag">@link</span> Sort#unsorted()&#125;, must not be</span></span><br><span class="line"><span class="comment">	 *          &#123;<span class="doctag">@literal</span> null&#125;.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span> all entities matching the given &#123;<span class="doctag">@link</span> Example&#125;.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@since</span> 1.10</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	&lt;S <span class="keyword">extends</span> <span class="title class_">T</span>&gt; Iterable&lt;S&gt; <span class="title function_">findAll</span><span class="params">(Example&lt;S&gt; example, Sort sort)</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Returns a &#123;<span class="doctag">@link</span> Page&#125; of entities matching the given &#123;<span class="doctag">@link</span> Example&#125;. In case no match could be found, an empty</span></span><br><span class="line"><span class="comment">	 * &#123;<span class="doctag">@link</span> Page&#125; is returned.</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> example must not be &#123;<span class="doctag">@literal</span> null&#125;.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> pageable the pageable to request a paged result, can be &#123;<span class="doctag">@link</span> Pageable#unpaged()&#125;, must not be</span></span><br><span class="line"><span class="comment">	 *          &#123;<span class="doctag">@literal</span> null&#125;.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span> a &#123;<span class="doctag">@link</span> Page&#125; of entities matching the given &#123;<span class="doctag">@link</span> Example&#125;.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	&lt;S <span class="keyword">extends</span> <span class="title class_">T</span>&gt; Page&lt;S&gt; <span class="title function_">findAll</span><span class="params">(Example&lt;S&gt; example, Pageable pageable)</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Returns the number of instances matching the given &#123;<span class="doctag">@link</span> Example&#125;.</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> example the &#123;<span class="doctag">@link</span> Example&#125; to count instances for. Must not be &#123;<span class="doctag">@literal</span> null&#125;.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span> the number of instances matching the &#123;<span class="doctag">@link</span> Example&#125;.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	&lt;S <span class="keyword">extends</span> <span class="title class_">T</span>&gt; <span class="type">long</span> <span class="title function_">count</span><span class="params">(Example&lt;S&gt; example)</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Checks whether the data store contains elements that match the given &#123;<span class="doctag">@link</span> Example&#125;.</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> example the &#123;<span class="doctag">@link</span> Example&#125; to use for the existence check. Must not be &#123;<span class="doctag">@literal</span> null&#125;.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span> &#123;<span class="doctag">@literal</span> true&#125; if the data store contains elements that match the given &#123;<span class="doctag">@link</span> Example&#125;.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	&lt;S <span class="keyword">extends</span> <span class="title class_">T</span>&gt; <span class="type">boolean</span> <span class="title function_">exists</span><span class="params">(Example&lt;S&gt; example)</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Returns entities matching the given &#123;<span class="doctag">@link</span> Example&#125; applying the &#123;<span class="doctag">@link</span> Function queryFunction&#125; that defines the</span></span><br><span class="line"><span class="comment">	 * query and its result type.</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> example must not be &#123;<span class="doctag">@literal</span> null&#125;.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> queryFunction the query function defining projection, sorting, and the result type</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span> all entities matching the given &#123;<span class="doctag">@link</span> Example&#125;.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@since</span> 2.6</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	&lt;S <span class="keyword">extends</span> <span class="title class_">T</span>, R&gt; R <span class="title function_">findBy</span><span class="params">(Example&lt;S&gt; example, Function&lt;FluentQuery.FetchableFluentQuery&lt;S&gt;, R&gt; queryFunction)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">MyPersonRepository</span> <span class="keyword">extends</span> <span class="title class_">Repository</span>&lt;Person, Integer&gt;, QueryByExampleExecutor&lt;Person&gt; &#123;</span><br><span class="line">     <span class="meta">@Override</span></span><br><span class="line">     List&lt;Person&gt; <span class="title function_">findAll</span><span class="params">(Example example)</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@ComponentScan(&#123;&quot;com.hank&quot;&#125;)</span></span><br><span class="line"><span class="meta">@EnableJpaRepositories(</span></span><br><span class="line"><span class="meta">    basePackages = &#123;&quot;com.hank.Pesis&quot;&#125;,</span></span><br><span class="line"><span class="meta">    entityManagerFactoryRef = &quot;myEntityManagerFactory&quot;,</span></span><br><span class="line"><span class="meta">    transactionManagerRef = &quot;jdbcTransactionManager&quot;</span></span><br><span class="line"><span class="meta">)</span></span><br><span class="line"><span class="meta">@EnableTransactionManagement</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Programmer</span> &#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="type">var</span> <span class="variable">context</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AnnotationConfigApplicationContext</span>(Programmer.class);</span><br><span class="line">    <span class="type">var</span> <span class="variable">repository</span> <span class="operator">=</span> context.getBean(MyPersonRepository.class);</span><br><span class="line">    </span><br><span class="line">     <span class="comment">//动态匹配的实体对象</span></span><br><span class="line">     <span class="keyword">var</span> person=<span class="keyword">new</span> <span class="title class_">Person</span>();</span><br><span class="line">     person.setFirstName(<span class="string">&quot;ok3&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 因为 id 有默认值，需要排除</span></span><br><span class="line">    <span class="keyword">var</span> matcher= ExampleMatcher.matching().withIgnorePaths(Person_.ID);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//字符串 Starting 匹配，也能对所有的字符串属性指定字符串匹配</span></span><br><span class="line">    matcher= matcher.withMatcher(Person_.FIRST_NAME, ExampleMatcher.GenericPropertyMatcher.of(ExampleMatcher.StringMatcher.STARTING,<span class="literal">true</span>));</span><br><span class="line">    <span class="comment">// 方法2 matcher= matcher.withMatcher(Person_.FIRST_NAME, p-&gt;p.endsWith().ignoreCase());</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//用动态查询去匹配</span></span><br><span class="line">    <span class="keyword">var</span> list=repository.findAll(Example.of(person,matcher));</span><br><span class="line">    list.forEach(p-&gt;&#123;</span><br><span class="line">      System.out.println(p);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>流畅的动态化 findBy</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="meta">@Setter</span></span><br><span class="line"><span class="meta">@ToString</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Person</span> &#123;</span><br><span class="line">  <span class="meta">@Id</span></span><br><span class="line">  <span class="meta">@Column(name = &quot;id&quot;, nullable = false)</span></span><br><span class="line">  <span class="meta">@GeneratedValue(strategy = GenerationType.IDENTITY)</span></span><br><span class="line">  <span class="keyword">private</span> <span class="type">int</span> id;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Column(name = &quot;firstName&quot;, nullable = true)</span></span><br><span class="line">  String firstName;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Column(name = &quot;lastName&quot;, nullable = true)</span></span><br><span class="line">  String lastName;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Column(name = &quot;personAge&quot;, nullable = true)</span></span><br><span class="line">  <span class="type">int</span> age;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@ComponentScan(&#123;&quot;com.hank&quot;&#125;)</span></span><br><span class="line"><span class="meta">@EnableJpaRepositories(</span></span><br><span class="line"><span class="meta">    basePackages = &#123;&quot;com.hank.Pesis&quot;&#125;,</span></span><br><span class="line"><span class="meta">    entityManagerFactoryRef = &quot;myEntityManagerFactory&quot;,</span></span><br><span class="line"><span class="meta">    transactionManagerRef = &quot;jdbcTransactionManager&quot;</span></span><br><span class="line"><span class="meta">)</span></span><br><span class="line"><span class="meta">@EnableTransactionManagement</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Programmer</span> &#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="type">var</span> <span class="variable">context</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AnnotationConfigApplicationContext</span>(Programmer.class);</span><br><span class="line">    <span class="type">var</span> <span class="variable">repository</span> <span class="operator">=</span> context.getBean(MyPersonRepository.class);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> person=<span class="keyword">new</span> <span class="title class_">Person</span>();</span><br><span class="line">    person.setFirstName(<span class="string">&quot;k1&quot;</span>);</span><br><span class="line">    person.setLastName(<span class="string">&quot;dA1&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//数字类型的字段忽略掉，最好是用包装类型就不用在这里忽略了，因为 null 类型, Example B不会进行匹配</span></span><br><span class="line">    <span class="keyword">var</span> exampleMatcher= ExampleMatcher.matching().</span><br><span class="line">        withIgnorePaths(Person_.ID).withIgnorePaths(Person_.AGE);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> sort= Sort.by(Person_.FIRST_NAME).ascending();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//可以在第二个参数里选取第一个数据</span></span><br><span class="line">    <span class="keyword">var</span> result=  repository.findBy(Example.of(person,exampleMatcher),p-&gt;p.sortBy(sort).first());</span><br><span class="line"></span><br><span class="line">    System.out.println(result.isPresent()?result.get():<span class="literal">null</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h4 id="JpaSpecificationExecutor-可组合的规约查询"><a href="#JpaSpecificationExecutor-可组合的规约查询" class="headerlink" title="JpaSpecificationExecutor-可组合的规约查询"></a>JpaSpecificationExecutor-可组合的规约查询</h4><p><em>规约的最大好处就是可组合可复用</em></p>
<p>hibernate 的使用方式</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">CriteriaBuilder</span> <span class="variable">cb</span> <span class="operator">=</span> session.getCriteriaBuilder();</span><br><span class="line">CriteriaQuery&lt;Person&gt; criteriaQuery = cb.createQuery(Person.class);</span><br><span class="line"></span><br><span class="line">Root&lt;Person&gt; root = criteriaQuery.from(Person.class);</span><br><span class="line">criteriaQuery.select(root).where(cb.equal(root.get(<span class="string">&quot;firstName&quot;</span>), <span class="string">&quot;ok1&quot;</span>));</span><br><span class="line"></span><br><span class="line">Query&lt;Person&gt; query = session.createQuery(criteriaQuery);</span><br><span class="line">List&lt;Person&gt; results = query.getResultList();</span><br></pre></td></tr></table></figure>


<p>Spring Data JPA 采用 Eric Evans 的书“领域驱动设计”中的规范概念，遵循相同的语义并提供 API 以使用 JPA 标准 API 定义此类规范。为了支持规范，您可以使用接口扩展您的存储库接口JpaSpecificationExecutor，如下所示：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">JpaSpecificationExecutor</span>&lt;T&gt; &#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Returns a single entity matching the given &#123;<span class="doctag">@link</span> Specification&#125; or &#123;<span class="doctag">@link</span> Optional#empty()&#125; if none found.</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> spec can be &#123;<span class="doctag">@literal</span> null&#125;.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span> never &#123;<span class="doctag">@literal</span> null&#125;.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@throws</span> org.springframework.dao.IncorrectResultSizeDataAccessException if more than one entity found.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	Optional&lt;T&gt; <span class="title function_">findOne</span><span class="params">(<span class="meta">@Nullable</span> Specification&lt;T&gt; spec)</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Returns all entities matching the given &#123;<span class="doctag">@link</span> Specification&#125;.</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> spec can be &#123;<span class="doctag">@literal</span> null&#125;.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span> never &#123;<span class="doctag">@literal</span> null&#125;.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	List&lt;T&gt; <span class="title function_">findAll</span><span class="params">(<span class="meta">@Nullable</span> Specification&lt;T&gt; spec)</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Returns a &#123;<span class="doctag">@link</span> Page&#125; of entities matching the given &#123;<span class="doctag">@link</span> Specification&#125;.</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> spec can be &#123;<span class="doctag">@literal</span> null&#125;.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> pageable must not be &#123;<span class="doctag">@literal</span> null&#125;.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span> never &#123;<span class="doctag">@literal</span> null&#125;.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	Page&lt;T&gt; <span class="title function_">findAll</span><span class="params">(<span class="meta">@Nullable</span> Specification&lt;T&gt; spec, Pageable pageable)</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Returns all entities matching the given &#123;<span class="doctag">@link</span> Specification&#125; and &#123;<span class="doctag">@link</span> Sort&#125;.</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> spec can be &#123;<span class="doctag">@literal</span> null&#125;.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> sort must not be &#123;<span class="doctag">@literal</span> null&#125;.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span> never &#123;<span class="doctag">@literal</span> null&#125;.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	List&lt;T&gt; <span class="title function_">findAll</span><span class="params">(<span class="meta">@Nullable</span> Specification&lt;T&gt; spec, Sort sort)</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Returns the number of instances that the given &#123;<span class="doctag">@link</span> Specification&#125; will return.</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> spec the &#123;<span class="doctag">@link</span> Specification&#125; to count instances for. Can be &#123;<span class="doctag">@literal</span> null&#125;.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span> the number of instances.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="type">long</span> <span class="title function_">count</span><span class="params">(<span class="meta">@Nullable</span> Specification&lt;T&gt; spec)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>规约的接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Specification</span>&lt;T&gt; <span class="keyword">extends</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> <span class="number">1L</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Negates the given &#123;<span class="doctag">@link</span> Specification&#125;.</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> &lt;T&gt; the type of the &#123;<span class="doctag">@link</span> Root&#125; the resulting &#123;<span class="doctag">@literal</span> Specification&#125; operates on.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> spec can be &#123;<span class="doctag">@literal</span> null&#125;.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span> guaranteed to be not &#123;<span class="doctag">@literal</span> null&#125;.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@since</span> 2.0</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">static</span> &lt;T&gt; Specification&lt;T&gt; <span class="title function_">not</span><span class="params">(<span class="meta">@Nullable</span> Specification&lt;T&gt; spec)</span> &#123;</span><br><span class="line"></span><br><span class="line">		<span class="type">return</span> <span class="variable">spec</span> <span class="operator">=</span>= <span class="literal">null</span> <span class="comment">//</span></span><br><span class="line">				? (root, query, builder) -&gt; <span class="literal">null</span> <span class="comment">//</span></span><br><span class="line">				: (root, query, builder) -&gt; builder.not(spec.toPredicate(root, query, builder));</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Simple static factory method to add some syntactic sugar around a &#123;<span class="doctag">@link</span> Specification&#125;.</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> &lt;T&gt; the type of the &#123;<span class="doctag">@link</span> Root&#125; the resulting &#123;<span class="doctag">@literal</span> Specification&#125; operates on.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> spec can be &#123;<span class="doctag">@literal</span> null&#125;.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span> guaranteed to be not &#123;<span class="doctag">@literal</span> null&#125;.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@since</span> 2.0</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">static</span> &lt;T&gt; Specification&lt;T&gt; <span class="title function_">where</span><span class="params">(<span class="meta">@Nullable</span> Specification&lt;T&gt; spec)</span> &#123;</span><br><span class="line">		<span class="type">return</span> <span class="variable">spec</span> <span class="operator">=</span>= <span class="literal">null</span> ? (root, query, builder) -&gt; <span class="literal">null</span> : spec;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * ANDs the given &#123;<span class="doctag">@link</span> Specification&#125; to the current one.</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> other can be &#123;<span class="doctag">@literal</span> null&#125;.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span> The conjunction of the specifications</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@since</span> 2.0</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">default</span> Specification&lt;T&gt; <span class="title function_">and</span><span class="params">(<span class="meta">@Nullable</span> Specification&lt;T&gt; other)</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> SpecificationComposition.composed(<span class="built_in">this</span>, other, CriteriaBuilder::and);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * ORs the given specification to the current one.</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> other can be &#123;<span class="doctag">@literal</span> null&#125;.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span> The disjunction of the specifications</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@since</span> 2.0</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">default</span> Specification&lt;T&gt; <span class="title function_">or</span><span class="params">(<span class="meta">@Nullable</span> Specification&lt;T&gt; other)</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> SpecificationComposition.composed(<span class="built_in">this</span>, other, CriteriaBuilder::or);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Creates a WHERE clause for a query of the referenced entity in form of a &#123;<span class="doctag">@link</span> Predicate&#125; for the given</span></span><br><span class="line"><span class="comment">	 * &#123;<span class="doctag">@link</span> Root&#125; and &#123;<span class="doctag">@link</span> CriteriaQuery&#125;.</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> root must not be &#123;<span class="doctag">@literal</span> null&#125;.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> query must not be &#123;<span class="doctag">@literal</span> null&#125;.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> criteriaBuilder must not be &#123;<span class="doctag">@literal</span> null&#125;.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span> a &#123;<span class="doctag">@link</span> Predicate&#125;, may be &#123;<span class="doctag">@literal</span> null&#125;.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="meta">@Nullable</span></span><br><span class="line">	Predicate <span class="title function_">toPredicate</span><span class="params">(Root&lt;T&gt; root, CriteriaQuery&lt;?&gt; query, CriteriaBuilder criteriaBuilder)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试代码</p>
<p><font color=blue>为了在规约中使用强类型的属性名编程， JPA 提供了 metemodel 的概念在编译时生成代码，为了使用此代码需要把生成的代码转变为源代码</font></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.hibernate<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hibernate-jpamodelgen<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.6.3.Final<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">//使用规约，继承 JpaSpecificationExecutor 接口</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">MyPersonRepository</span> <span class="keyword">extends</span> <span class="title class_">Repository</span>&lt;Person, Integer&gt;, JpaSpecificationExecutor&lt;Person&gt; &#123;</span><br><span class="line">     <span class="meta">@Override</span></span><br><span class="line">     List&lt;Person&gt; <span class="title function_">findAll</span><span class="params">(Specification&lt;Person&gt; spec)</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@ComponentScan(&#123;&quot;com.hank&quot;&#125;)</span></span><br><span class="line"><span class="meta">@EnableJpaRepositories(</span></span><br><span class="line"><span class="meta">    basePackages = &#123;&quot;com.hank.Pesis&quot;&#125;,</span></span><br><span class="line"><span class="meta">    entityManagerFactoryRef = &quot;myEntityManagerFactory&quot;,</span></span><br><span class="line"><span class="meta">    transactionManagerRef = &quot;jdbcTransactionManager&quot;</span></span><br><span class="line"><span class="meta">)</span></span><br><span class="line"><span class="meta">@EnableTransactionManagement</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Programmer</span> &#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="type">var</span> <span class="variable">context</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AnnotationConfigApplicationContext</span>(Programmer.class);</span><br><span class="line">    <span class="type">var</span> <span class="variable">repository</span> <span class="operator">=</span> context.getBean(MyPersonRepository.class);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//生成规约表达式，因为是函数式接口，此处也可以用 lambda 进行简写</span></span><br><span class="line">    <span class="keyword">var</span> spec= <span class="keyword">new</span> <span class="title class_">Specification</span>&lt;Person&gt;() &#123;</span><br><span class="line">      <span class="comment">/**</span></span><br><span class="line"><span class="comment">       *</span></span><br><span class="line"><span class="comment">       * <span class="doctag">@param</span> Root&lt;Person&gt; root 查询的实体</span></span><br><span class="line"><span class="comment">       * <span class="doctag">@param</span>  CriteriaQuery&lt;?&gt; query  代表一个specific的顶层查询对象，它包含着查询的各个部分，比如：select、from、where、group by、order by等。它提供了查询ROOT的方法</span></span><br><span class="line"><span class="comment">       * <span class="doctag">@param</span> criteriaBuilder  用来构建CritiaQuery的构建器对象，其实就相当于条件或者是条件组合，即以Predicate的形式返回，可以构建简单的查询</span></span><br><span class="line"><span class="comment">       复杂的查询还有要通过 CriteriaQuery&lt;?&gt; 生成</span></span><br><span class="line"><span class="comment">       * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">       */</span></span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="keyword">public</span> Predicate <span class="title function_">toPredicate</span><span class="params">(Root&lt;Person&gt; root, CriteriaQuery&lt;?&gt; query, CriteriaBuilder criteriaBuilder)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//获取的实体属性值，此处用了 metemodel 强类型</span></span><br><span class="line">        <span class="keyword">var</span> path1= root.get(Person_.firstName);</span><br><span class="line">        <span class="keyword">var</span> path2= root.get(Person_.lastName);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//谓词判断</span></span><br><span class="line">        <span class="type">var</span> <span class="variable">predicate1</span> <span class="operator">=</span>criteriaBuilder.equal(path1,<span class="string">&quot;ok1&quot;</span>);</span><br><span class="line">        <span class="type">var</span> <span class="variable">predicate2</span> <span class="operator">=</span>criteriaBuilder.equal(path2,<span class="string">&quot;ok2&quot;</span>);</span><br><span class="line">        <span class="keyword">var</span> and= criteriaBuilder.and(predicate1,predicate2);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//排序条件</span></span><br><span class="line">        <span class="keyword">var</span> order1=criteriaBuilder.asc(path1);</span><br><span class="line">        <span class="keyword">var</span> order2=criteriaBuilder.asc(path2);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//通过 query 组合</span></span><br><span class="line">        <span class="keyword">return</span> query.where(and).orderBy(order1,order2).getRestriction();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//不带排序</span></span><br><span class="line">        <span class="comment">//return criteriaBuilder.and(predicate1,predicate2);</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="type">var</span> <span class="variable">result</span> <span class="operator">=</span> repository.findAll(spec);</span><br><span class="line">    System.out.println(result.size());</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="QueryDSL-解决多表查询，动态查询的通用类型安全的查询利器，代替JPQL"><a href="#QueryDSL-解决多表查询，动态查询的通用类型安全的查询利器，代替JPQL" class="headerlink" title="QueryDSL - 解决多表查询，动态查询的通用类型安全的查询利器，代替JPQL"></a>QueryDSL - 解决多表查询，动态查询的通用类型安全的查询利器，代替JPQL</h4><p>QueryDSL 有多个模块，可以支持 JPA、Mongodb、Lucene 等,使用它们的 API 是统一的平台，这里我们用到的 module 是 JPA。</p>
<p>不可否认的是 JPA 使用是非常方便的，极简化的配置，只需要使用注解，无需任何 xml 的配置文件，语义简单易懂，但是，以上的一切都建立在单表查询的前提下的，我们可以使用 JPA 默认提供的方法，简单加轻松的完成 CRUD 操作。<br>但是如果涉及到多表动态查询， JPA 的功能就显得有些捉襟见肘了，虽然我们可以使用注解 @Query ，在这个注解中写 SQL 或者 HQL 都是在拼接字符串，并且拼接后的字符串可读性非常的差，当然 JPA 还为我们提供了 Specification 来做这件事情</p>
<p>QuerydslPredicateExecutor 接口提供的方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">QuerydslPredicateExecutor</span>&lt;T&gt; &#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Returns a single entity matching the given &#123;<span class="doctag">@link</span> Predicate&#125; or &#123;<span class="doctag">@link</span> Optional#empty()&#125; if none was found.</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> predicate must not be &#123;<span class="doctag">@literal</span> null&#125;.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span> a single entity matching the given &#123;<span class="doctag">@link</span> Predicate&#125; or &#123;<span class="doctag">@link</span> Optional#empty()&#125; if none was found.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@throws</span> org.springframework.dao.IncorrectResultSizeDataAccessException if the predicate yields more than one</span></span><br><span class="line"><span class="comment">	 *           result.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	Optional&lt;T&gt; <span class="title function_">findOne</span><span class="params">(Predicate predicate)</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Returns all entities matching the given &#123;<span class="doctag">@link</span> Predicate&#125;. In case no match could be found an empty</span></span><br><span class="line"><span class="comment">	 * &#123;<span class="doctag">@link</span> Iterable&#125; is returned.</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> predicate must not be &#123;<span class="doctag">@literal</span> null&#125;.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span> all entities matching the given &#123;<span class="doctag">@link</span> Predicate&#125;.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	Iterable&lt;T&gt; <span class="title function_">findAll</span><span class="params">(Predicate predicate)</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Returns all entities matching the given &#123;<span class="doctag">@link</span> Predicate&#125; applying the given &#123;<span class="doctag">@link</span> Sort&#125;. In case no match could</span></span><br><span class="line"><span class="comment">	 * be found an empty &#123;<span class="doctag">@link</span> Iterable&#125; is returned.</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> predicate must not be &#123;<span class="doctag">@literal</span> null&#125;.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> sort the &#123;<span class="doctag">@link</span> Sort&#125; specification to sort the results by, may be &#123;<span class="doctag">@link</span> Sort#unsorted()&#125;, must not be</span></span><br><span class="line"><span class="comment">	 *          &#123;<span class="doctag">@literal</span> null&#125;.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span> all entities matching the given &#123;<span class="doctag">@link</span> Predicate&#125;.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@since</span> 1.10</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	Iterable&lt;T&gt; <span class="title function_">findAll</span><span class="params">(Predicate predicate, Sort sort)</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Returns all entities matching the given &#123;<span class="doctag">@link</span> Predicate&#125; applying the given &#123;<span class="doctag">@link</span> OrderSpecifier&#125;s. In case no</span></span><br><span class="line"><span class="comment">	 * match could be found an empty &#123;<span class="doctag">@link</span> Iterable&#125; is returned.</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> predicate must not be &#123;<span class="doctag">@literal</span> null&#125;.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> orders the &#123;<span class="doctag">@link</span> OrderSpecifier&#125;s to sort the results by, must not be &#123;<span class="doctag">@literal</span> null&#125;.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span> all entities matching the given &#123;<span class="doctag">@link</span> Predicate&#125; applying the given &#123;<span class="doctag">@link</span> OrderSpecifier&#125;s.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	Iterable&lt;T&gt; <span class="title function_">findAll</span><span class="params">(Predicate predicate, OrderSpecifier&lt;?&gt;... orders)</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Returns all entities ordered by the given &#123;<span class="doctag">@link</span> OrderSpecifier&#125;s.</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> orders the &#123;<span class="doctag">@link</span> OrderSpecifier&#125;s to sort the results by, must not be &#123;<span class="doctag">@literal</span> null&#125;.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span> all entities ordered by the given &#123;<span class="doctag">@link</span> OrderSpecifier&#125;s.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	Iterable&lt;T&gt; <span class="title function_">findAll</span><span class="params">(OrderSpecifier&lt;?&gt;... orders)</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Returns a &#123;<span class="doctag">@link</span> Page&#125; of entities matching the given &#123;<span class="doctag">@link</span> Predicate&#125;. In case no match could be found, an empty</span></span><br><span class="line"><span class="comment">	 * &#123;<span class="doctag">@link</span> Page&#125; is returned.</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> predicate must not be &#123;<span class="doctag">@literal</span> null&#125;.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> pageable may be &#123;<span class="doctag">@link</span> Pageable#unpaged()&#125;, must not be &#123;<span class="doctag">@literal</span> null&#125;.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span> a &#123;<span class="doctag">@link</span> Page&#125; of entities matching the given &#123;<span class="doctag">@link</span> Predicate&#125;.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	Page&lt;T&gt; <span class="title function_">findAll</span><span class="params">(Predicate predicate, Pageable pageable)</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Returns the number of instances matching the given &#123;<span class="doctag">@link</span> Predicate&#125;.</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> predicate the &#123;<span class="doctag">@link</span> Predicate&#125; to count instances for, must not be &#123;<span class="doctag">@literal</span> null&#125;.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span> the number of instances matching the &#123;<span class="doctag">@link</span> Predicate&#125;.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="type">long</span> <span class="title function_">count</span><span class="params">(Predicate predicate)</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Checks whether the data store contains elements that match the given &#123;<span class="doctag">@link</span> Predicate&#125;.</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> predicate the &#123;<span class="doctag">@link</span> Predicate&#125; to use for the existence check, must not be &#123;<span class="doctag">@literal</span> null&#125;.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span> &#123;<span class="doctag">@literal</span> true&#125; if the data store contains elements that match the given &#123;<span class="doctag">@link</span> Predicate&#125;.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="type">boolean</span> <span class="title function_">exists</span><span class="params">(Predicate predicate)</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Returns entities matching the given &#123;<span class="doctag">@link</span> Predicate&#125; applying the &#123;<span class="doctag">@link</span> Function queryFunction&#125; that defines the</span></span><br><span class="line"><span class="comment">	 * query and its result type.</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> predicate must not be &#123;<span class="doctag">@literal</span> null&#125;.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> queryFunction the query function defining projection, sorting, and the result type</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span> all entities matching the given &#123;<span class="doctag">@link</span> Predicate&#125;.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@since</span> 2.6</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	&lt;S <span class="keyword">extends</span> <span class="title class_">T</span>, R&gt; R <span class="title function_">findBy</span><span class="params">(Predicate predicate, Function&lt;FluentQuery.FetchableFluentQuery&lt;S&gt;, R&gt; queryFunction)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>准备工作</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- querydsl-jpa --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.querydsl<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>querydsl-jpa<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.0.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>此插件需要 querydsl-apt 依赖，此插件会在编译时生成强类型的实体类型，特征是生成在在实体前加Q的强类型元素据，类似于 JPA 的 metamodel，需要把生成的代码加到源码中</p>
<p>如下代码就是强类型的类型变量</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">QPerson person=QPerson.person;</span><br><span class="line"><span class="comment">//或</span></span><br><span class="line">QPerson person= <span class="keyword">new</span> <span class="title class_">QPerson</span>(<span class="string">&quot;myPerson&quot;</span>);</span><br></pre></td></tr></table></figure>

<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"> <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.mysema.maven<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>apt-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.1.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.querydsl<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>querydsl-apt<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.0.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">executions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">execution</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">phase</span>&gt;</span>generate-sources<span class="tag">&lt;/<span class="name">phase</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">goals</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">goal</span>&gt;</span>process<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">goals</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">outputDirectory</span>&gt;</span>target/generated-sources/java<span class="tag">&lt;/<span class="name">outputDirectory</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">processor</span>&gt;</span>com.querydsl.apt.jpa.JPAAnnotationProcessor<span class="tag">&lt;/<span class="name">processor</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">execution</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">executions</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h5 id="仓储继承-QuerydslPredicateExecutor-接口"><a href="#仓储继承-QuerydslPredicateExecutor-接口" class="headerlink" title="仓储继承 QuerydslPredicateExecutor 接口"></a>仓储继承 QuerydslPredicateExecutor 接口</h5><p><font color=blue>QuerydslPredicateExecutor 接口是谓词查询,缺点是只能是单表查询，返回的实体的所有字段</font></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">MyPersonRepository</span> <span class="keyword">extends</span> <span class="title class_">Repository</span>&lt;Person, Integer&gt;, QuerydslPredicateExecutor&lt;Person&gt; &#123;</span><br><span class="line">     <span class="meta">@Override</span></span><br><span class="line">     List&lt;Person&gt; <span class="title function_">findAll</span><span class="params">(Predicate predicate)</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@ComponentScan(&#123;&quot;com.hank&quot;&#125;)</span></span><br><span class="line"><span class="meta">@EnableJpaRepositories(</span></span><br><span class="line"><span class="meta">    basePackages = &#123;&quot;com.hank.Pesis&quot;&#125;,</span></span><br><span class="line"><span class="meta">    entityManagerFactoryRef = &quot;myEntityManagerFactory&quot;,</span></span><br><span class="line"><span class="meta">    transactionManagerRef = &quot;jdbcTransactionManager&quot;</span></span><br><span class="line"><span class="meta">)</span></span><br><span class="line"><span class="meta">@EnableTransactionManagement</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Programmer</span> &#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="type">var</span> <span class="variable">context</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AnnotationConfigApplicationContext</span>(Programmer.class);</span><br><span class="line">    <span class="type">var</span> <span class="variable">repository</span> <span class="operator">=</span> context.getBean(MyPersonRepository.class);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> person=QPerson.person;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> booleanExpression1=person.firstName.in(<span class="string">&quot;k1&quot;</span>, <span class="string">&quot;k2&quot;</span>);</span><br><span class="line">    <span class="keyword">var</span> booleanExpression2=person.lastName.containsIgnoreCase(<span class="string">&quot;a1&quot;</span>);</span><br><span class="line">    <span class="keyword">var</span> booleanExpression3=person.id.goe(<span class="number">4</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> list= repository.findAll(booleanExpression1.and(booleanExpression2).and(booleanExpression3));</span><br><span class="line">    System.out.println(list.get(<span class="number">0</span>).toString());</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="仓储注入-JPAQueryFactory-对象链式查询，多表，多字段查询"><a href="#仓储注入-JPAQueryFactory-对象链式查询，多表，多字段查询" class="headerlink" title="仓储注入 JPAQueryFactory 对象链式查询，多表，多字段查询"></a>仓储注入 JPAQueryFactory 对象链式查询，多表，多字段查询</h5><p>JPAQueryFactory 用来生成 JPAQuery,当然也可以自己 new JPAQuery</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">var</span> <span class="variable">myPerson</span> <span class="operator">=</span> QPerson.person;</span><br><span class="line"> <span class="comment">//可以自己构建 JPAQuery</span></span><br><span class="line">JPAQuery&lt;Person&gt; query = <span class="keyword">new</span> <span class="title class_">JPAQuery</span>&lt;Person&gt;(entityManager);</span><br><span class="line"><span class="comment">//或</span></span><br><span class="line">JPAQuery&lt;Person&gt; query = jPAQueryFactory.selectFrom(myPerson)</span><br></pre></td></tr></table></figure>


<p>配置 JPAQueryFactory 工厂在仓储里使用</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">QueryDSLConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@PersistenceContext</span></span><br><span class="line"> <span class="keyword">private</span> EntityManager entityManager;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Bean</span></span><br><span class="line">  <span class="meta">@Scope(BeanDefinition.SCOPE_PROTOTYPE)</span></span><br><span class="line">  <span class="keyword">public</span> JPAQueryFactory <span class="title function_">getJPAQueryFactory</span><span class="params">()</span>&#123;</span><br><span class="line">     <span class="keyword">return</span>  <span class="keyword">new</span> <span class="title class_">JPAQueryFactory</span>(entityManager);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>链式写法的 jpaQuery 用java 语法写SQL 非常的方便</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span>  <span class="keyword">interface</span> <span class="title class_">MyPersonRepository</span> <span class="keyword">extends</span> <span class="title class_">Repository</span>&lt;Person, Integer&gt; &#123;</span><br><span class="line">    <span class="keyword">default</span> List&lt;Person&gt; <span class="title function_">findDSL</span><span class="params">(JPAQueryFactory jPAQueryFactory)</span>&#123;</span><br><span class="line">        <span class="keyword">var</span>  person=QPerson.person;</span><br><span class="line">        <span class="keyword">var</span>  jpaQuery=jPAQueryFactory.select(person)</span><br><span class="line">               .from(person)</span><br><span class="line">               .where(person.firstName.containsIgnoreCase(<span class="string">&quot;ok&quot;</span>));</span><br><span class="line"></span><br><span class="line">      <span class="keyword">var</span> list= jpaQuery.fetch();</span><br><span class="line">      <span class="keyword">return</span>  list;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@ComponentScan(&#123;&quot;com.hank&quot;&#125;)</span></span><br><span class="line"><span class="meta">@EnableJpaRepositories(</span></span><br><span class="line"><span class="meta">    basePackages = &#123;&quot;com.hank.Pesis&quot;&#125;,</span></span><br><span class="line"><span class="meta">    entityManagerFactoryRef = &quot;myEntityManagerFactory&quot;,</span></span><br><span class="line"><span class="meta">    transactionManagerRef = &quot;jdbcTransactionManager&quot;</span></span><br><span class="line"><span class="meta">)</span></span><br><span class="line"><span class="meta">@EnableTransactionManagement</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Programmer</span> &#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="type">var</span> <span class="variable">context</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AnnotationConfigApplicationContext</span>(Programmer.class);</span><br><span class="line">    <span class="type">var</span> <span class="variable">repository</span> <span class="operator">=</span> context.getBean(MyPersonRepository.class);</span><br><span class="line">    <span class="keyword">var</span> jPQLQueryFactory=  context.getBean(JPAQueryFactory.class);</span><br><span class="line">    <span class="comment">//调用存储方法</span></span><br><span class="line">    System.out.println(repository.findDSL(jPQLQueryFactory));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="更新删除"><a href="#更新删除" class="headerlink" title="更新删除"></a>更新删除</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">MyPersonRepository</span> <span class="keyword">extends</span> <span class="title class_">Repository</span>&lt;Person, Integer&gt; &#123;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Transactional</span></span><br><span class="line">  <span class="keyword">default</span> <span class="type">long</span> <span class="title function_">updateDSL</span><span class="params">(JPAQueryFactory jPAQueryFactory)</span> &#123;</span><br><span class="line">    <span class="type">var</span> <span class="variable">person</span> <span class="operator">=</span> QPerson.person;</span><br><span class="line">    <span class="type">var</span> <span class="variable">updateClause</span> <span class="operator">=</span> jPAQueryFactory.update(person)</span><br><span class="line">        .set(person.firstName, <span class="string">&quot;name good&quot;</span>)</span><br><span class="line">        .where(person.id.eq(<span class="number">1</span>));</span><br><span class="line">    <span class="keyword">return</span> updateClause.execute();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Transactional</span></span><br><span class="line">  <span class="keyword">default</span> <span class="type">long</span> <span class="title function_">deleteDSL</span><span class="params">(JPAQueryFactory jPAQueryFactory)</span> &#123;</span><br><span class="line">    <span class="type">var</span> <span class="variable">person</span> <span class="operator">=</span> QPerson.person;</span><br><span class="line">    <span class="type">var</span> <span class="variable">deleteClause</span> <span class="operator">=</span> jPAQueryFactory.delete(person)</span><br><span class="line">        .where(person.firstName.eq(<span class="string">&quot;K2&quot;</span>));</span><br><span class="line">    <span class="keyword">return</span> deleteClause.execute();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="查询部分字段"><a href="#查询部分字段" class="headerlink" title="查询部分字段"></a>查询部分字段</h6><p><font color=blue>返回一个字段</font></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">MyPersonRepository</span> <span class="keyword">extends</span> <span class="title class_">Repository</span>&lt;Person, Integer&gt; &#123;</span><br><span class="line">  <span class="keyword">default</span> String <span class="title function_">queryDSL</span><span class="params">(JPAQueryFactory jPAQueryFactory)</span> &#123;</span><br><span class="line">    <span class="type">var</span> <span class="variable">person</span> <span class="operator">=</span> QPerson.person;</span><br><span class="line">    <span class="comment">//选择映射的字段</span></span><br><span class="line">    <span class="type">var</span> <span class="variable">jpaQuery</span> <span class="operator">=</span> jPAQueryFactory.select(person.lastName)</span><br><span class="line">        .from(person)</span><br><span class="line">        .where(person.id.eq(<span class="number">1</span>));</span><br><span class="line">    <span class="keyword">return</span> jpaQuery.fetchOne();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><font color=blue>返回多个字段组合的是元组</font></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">MyPersonRepository</span> <span class="keyword">extends</span> <span class="title class_">Repository</span>&lt;Person, Integer&gt; &#123;</span><br><span class="line">  <span class="keyword">default</span> Tuple <span class="title function_">queryDSL</span><span class="params">(JPAQueryFactory jPAQueryFactory)</span> &#123;</span><br><span class="line">    <span class="type">var</span> <span class="variable">person</span> <span class="operator">=</span> QPerson.person;</span><br><span class="line">    <span class="type">var</span> <span class="variable">jpaQuery</span> <span class="operator">=</span> jPAQueryFactory.select(person.lastName,person.lastName)</span><br><span class="line">        .from(person)</span><br><span class="line">        .where(person.id.eq(<span class="number">1</span>));</span><br><span class="line">    <span class="keyword">var</span>  tuple=jpaQuery.fetchOne();</span><br><span class="line"></span><br><span class="line">    System.out.println(tuple.get(person.lastName));</span><br><span class="line">    System.out.println(tuple.get(person.lastName));</span><br><span class="line">    <span class="keyword">return</span> tuple;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><font color=blue>返回多个字段组合的的元组不方便使用，还可以进行投影</font></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//投影的类</span></span><br><span class="line"><span class="meta">@Value</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyReturnDto</span> &#123;</span><br><span class="line">     String firstNameDto;</span><br><span class="line">     String lastNameDto;</span><br><span class="line">   <span class="keyword">public</span>  String <span class="title function_">getFullName</span><span class="params">()</span>&#123;</span><br><span class="line">      <span class="keyword">return</span>  firstNameDto+<span class="string">&quot;,&quot;</span>+lastNameDto;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">MyPersonRepository</span> <span class="keyword">extends</span> <span class="title class_">Repository</span>&lt;Person, Integer&gt; &#123;</span><br><span class="line">  <span class="keyword">default</span> MyReturnDto <span class="title function_">queryDSL</span><span class="params">(JPAQueryFactory jPAQueryFactory)</span> &#123;</span><br><span class="line">    <span class="type">var</span> <span class="variable">person</span> <span class="operator">=</span> QPerson.person;</span><br><span class="line">    <span class="type">var</span> <span class="variable">jpaQuery</span> <span class="operator">=</span> jPAQueryFactory.select(</span><br><span class="line">        <span class="comment">//对返回结果进行投影</span></span><br><span class="line">        Projections.constructor(MyReturnDto.class,</span><br><span class="line">            person.firstName.as(<span class="string">&quot;firstNameDto&quot;</span>),person.lastName.as(<span class="string">&quot;lastNameDto&quot;</span>)))</span><br><span class="line">        .from(person)</span><br><span class="line">        .where(person.id.eq(<span class="number">1</span>));</span><br><span class="line">    <span class="keyword">var</span>  myReturnDto=jpaQuery.fetchOne();</span><br><span class="line">    System.out.println(myReturnDto.getFullName());</span><br><span class="line">    <span class="keyword">return</span> myReturnDto;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="关联和子查询"><a href="#关联和子查询" class="headerlink" title="关联和子查询"></a>关联和子查询</h6><p><font color=blue>关联查询,支持 内联结、联结、左联结和右联结</font></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//增加的实体</span></span><br><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderCargo</span> &#123;</span><br><span class="line">  <span class="meta">@Id</span></span><br><span class="line">  <span class="meta">@Column(name = &quot;id&quot;, nullable = false)</span></span><br><span class="line">  <span class="meta">@GeneratedValue(strategy = GenerationType.IDENTITY)</span></span><br><span class="line">  <span class="keyword">private</span> <span class="type">int</span> id;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span>  <span class="type">int</span> PersonId;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span>  String CargoName;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">MyPersonRepository</span> <span class="keyword">extends</span> <span class="title class_">Repository</span>&lt;Person, Integer&gt; &#123;</span><br><span class="line">  <span class="keyword">default</span> List&lt;Tuple&gt; <span class="title function_">queryDSL</span><span class="params">(JPAQueryFactory jPAQueryFactory)</span> &#123;</span><br><span class="line">    <span class="type">var</span> <span class="variable">person</span> <span class="operator">=</span> QPerson.person;</span><br><span class="line">    <span class="type">var</span> <span class="variable">orderCargo</span> <span class="operator">=</span> QOrderCargo.orderCargo;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> jpaQuery=  jPAQueryFactory.select(person,orderCargo).</span><br><span class="line">        from(person).join(orderCargo).on(person.id.eq(orderCargo.PersonId));</span><br><span class="line">    <span class="type">var</span> <span class="variable">result</span> <span class="operator">=</span>jpaQuery.fetch();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//显示结果</span></span><br><span class="line">    result.forEach(p-&gt;&#123;</span><br><span class="line">      <span class="keyword">var</span> i= p.get(person);</span><br><span class="line">      <span class="keyword">var</span> j=p.get(orderCargo);</span><br><span class="line">      System.out.println(i);</span><br><span class="line">      System.out.println(j);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span>  result ;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><font color=blue>子查询，提过静态方法 JPAExpressions 提供子查询</font></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//增加实体</span></span><br><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CargoType</span> &#123;</span><br><span class="line">  <span class="meta">@Id</span></span><br><span class="line">  <span class="meta">@Column(name = &quot;id&quot;, nullable = false)</span></span><br><span class="line">  <span class="meta">@GeneratedValue(strategy = GenerationType.IDENTITY)</span></span><br><span class="line">  <span class="keyword">private</span> <span class="type">int</span> id;</span><br><span class="line">  <span class="keyword">private</span>  String  CargoName;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过子查询实现  orderCargo 的 CargoName 出现在 cargoType 的 CargoName 里</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">MyPersonRepository</span> <span class="keyword">extends</span> <span class="title class_">Repository</span>&lt;Person, Integer&gt; &#123;</span><br><span class="line">  <span class="keyword">default</span> List&lt;OrderCargo&gt; <span class="title function_">queryDSL</span><span class="params">(JPAQueryFactory jPAQueryFactory)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">var</span> <span class="variable">orderCargo</span> <span class="operator">=</span> QOrderCargo.orderCargo;</span><br><span class="line">    <span class="keyword">var</span> type= QCargoType.cargoType;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> jpaQuery=  jPAQueryFactory.selectFrom(orderCargo)</span><br><span class="line">        .where(orderCargo.CargoName.in(JPAExpressions.select(type.CargoName).from(type)));</span><br><span class="line"></span><br><span class="line">   <span class="keyword">var</span> result= jpaQuery.fetch();</span><br><span class="line"></span><br><span class="line">   result.forEach(p-&gt;&#123;</span><br><span class="line">     System.out.println(p);</span><br><span class="line">   &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> result ;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="meta">@Setter</span></span><br><span class="line"><span class="meta">@ToString</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Person</span> &#123;</span><br><span class="line">  <span class="meta">@Id</span></span><br><span class="line">  <span class="meta">@Column(name = &quot;id&quot;, nullable = false)</span></span><br><span class="line">  <span class="meta">@GeneratedValue(strategy = GenerationType.IDENTITY)</span></span><br><span class="line">  <span class="keyword">private</span> <span class="type">int</span> id;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Column(name = &quot;firstName&quot;, nullable = true)</span></span><br><span class="line">  String firstName;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Column(name = &quot;lastName&quot;, nullable = true)</span></span><br><span class="line">  String lastName;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Column(name = &quot;personAge&quot;, nullable = true)</span></span><br><span class="line">  <span class="type">int</span> age;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//获取 person 里年龄大于平均年龄的集合</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">MyPersonRepository</span> <span class="keyword">extends</span> <span class="title class_">Repository</span>&lt;Person, Integer&gt; &#123;</span><br><span class="line">  <span class="keyword">default</span> List&lt;Person&gt; <span class="title function_">queryDSL</span><span class="params">(JPAQueryFactory jPAQueryFactory)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">var</span> <span class="variable">person</span> <span class="operator">=</span> QPerson.person;</span><br><span class="line">    <span class="keyword">var</span> jpaQuery= jPAQueryFactory.selectFrom(person)</span><br><span class="line">        .where(person.age.goe(JPAExpressions.select(person.age.avg()).from(person)));</span><br><span class="line"></span><br><span class="line">     <span class="keyword">var</span> result=jpaQuery.fetch();</span><br><span class="line">     </span><br><span class="line">    result.forEach(p-&gt;&#123;</span><br><span class="line">      System.out.println(p);</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">return</span> result ;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 或者</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">MyPersonRepository</span> <span class="keyword">extends</span> <span class="title class_">Repository</span>&lt;Person, Integer&gt; &#123;</span><br><span class="line">  <span class="keyword">default</span> List&lt;Person&gt; <span class="title function_">queryDSL</span><span class="params">(JPAQueryFactory jPAQueryFactory)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">var</span> <span class="variable">person</span> <span class="operator">=</span> QPerson.person;</span><br><span class="line">    <span class="keyword">var</span> q=<span class="keyword">new</span> <span class="title class_">QPerson</span>(<span class="string">&quot;q&quot;</span>);</span><br><span class="line">    <span class="keyword">var</span> jpaQuery= jPAQueryFactory.selectFrom(person)</span><br><span class="line">        .where(person.age.goe(JPAExpressions.select(q.age.avg()).from(q)));</span><br><span class="line"></span><br><span class="line">     <span class="keyword">var</span> result=jpaQuery.fetch();</span><br><span class="line"></span><br><span class="line">    result.forEach(p-&gt;&#123;</span><br><span class="line">      System.out.println(p);</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">return</span> result ;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="分组和分页及排序"><a href="#分组和分页及排序" class="headerlink" title="分组和分页及排序"></a>分组和分页及排序</h6><p><font color=blue>按照某个属性进行分组，获取也只能获取分组的属性，可以多次分组</font></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//单个属性的分组</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">MyPersonRepository</span> <span class="keyword">extends</span> <span class="title class_">Repository</span>&lt;Person, Integer&gt; &#123;</span><br><span class="line">  <span class="keyword">default</span> List&lt;Integer&gt; <span class="title function_">queryDSL</span><span class="params">(JPAQueryFactory jPAQueryFactory)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">var</span> <span class="variable">person</span> <span class="operator">=</span> QPerson.person;</span><br><span class="line">    <span class="type">var</span> <span class="variable">list</span> <span class="operator">=</span> jPAQueryFactory.select(person.age).from(person).groupBy(person.age).fetch();</span><br><span class="line">    list.forEach(p-&gt;&#123;</span><br><span class="line">      System.out.println(p);</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">return</span> list ;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//可以对多个元素的组合进行分组 groupBy(person.firstName,person.lastName)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">MyPersonRepository</span> <span class="keyword">extends</span> <span class="title class_">Repository</span>&lt;Person, Integer&gt; &#123;</span><br><span class="line">  <span class="keyword">default</span> List&lt;Object&gt; <span class="title function_">queryDSL</span><span class="params">(JPAQueryFactory jPAQueryFactory)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">var</span> <span class="variable">person</span> <span class="operator">=</span> QPerson.person;</span><br><span class="line">    <span class="type">var</span> <span class="variable">list</span> <span class="operator">=</span> jPAQueryFactory.select(person.firstName,person.lastName).from(person).groupBy(person.firstName,person.lastName).fetch();</span><br><span class="line">    list.forEach(p-&gt;&#123;</span><br><span class="line">      System.out.println(p);</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">return</span> Collections.singletonList(list);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//分组过滤  having</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">MyPersonRepository</span> <span class="keyword">extends</span> <span class="title class_">Repository</span>&lt;Person, Integer&gt; &#123;</span><br><span class="line">  <span class="keyword">default</span> List&lt;Integer&gt; <span class="title function_">queryDSL</span><span class="params">(JPAQueryFactory jPAQueryFactory)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">var</span> <span class="variable">person</span> <span class="operator">=</span> QPerson.person;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> list=jPAQueryFactory.select(person.age).from(person)</span><br><span class="line">         <span class="comment">//对分组的元素进行过滤 having(person.age.gt(20)) </span></span><br><span class="line">        .groupBy(person.age).having(person.age.gt(<span class="number">20</span>)).fetch();</span><br><span class="line"></span><br><span class="line">    list.forEach(p-&gt;&#123;</span><br><span class="line">      System.out.println(p);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> list;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><font color=blue>分页 通过 offset 设置页码，limit 设置每页记录数 </font></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">MyPersonRepository</span> <span class="keyword">extends</span> <span class="title class_">Repository</span>&lt;Person, Integer&gt; &#123;</span><br><span class="line">  <span class="keyword">default</span> QueryResults&lt;Person&gt; <span class="title function_">queryDSL</span><span class="params">(JPAQueryFactory jPAQueryFactory)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">var</span> <span class="variable">person</span> <span class="operator">=</span> QPerson.person;</span><br><span class="line">    <span class="keyword">var</span> pageable= PageRequest.of(<span class="number">0</span>,<span class="number">2</span>);</span><br><span class="line">    <span class="keyword">var</span> queryResults=jPAQueryFactory.selectFrom(person)</span><br><span class="line">        .offset(pageable.getOffset()).limit(pageable.getPageSize()).fetchResults();</span><br><span class="line"></span><br><span class="line">    System.out.println(queryResults.getTotal());</span><br><span class="line">    queryResults.getResults().forEach(p-&gt;&#123;</span><br><span class="line">      System.out.println(p);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> queryResults;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><font color=blue>排序 orderBy</font></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">MyPersonRepository</span> <span class="keyword">extends</span> <span class="title class_">Repository</span>&lt;Person, Integer&gt; &#123;</span><br><span class="line">  <span class="keyword">default</span> List&lt;Person&gt; <span class="title function_">queryDSL</span><span class="params">(JPAQueryFactory jPAQueryFactory)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">var</span> <span class="variable">person</span> <span class="operator">=</span> QPerson.person;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> list=jPAQueryFactory.selectFrom(person)</span><br><span class="line">             <span class="comment">//多个排序条件 asc 升序 ，</span></span><br><span class="line">             <span class="comment">//或 orderBy(person.age.asc(),person.id.asc())</span></span><br><span class="line">            .orderBy(person.age.asc()).orderBy(person.id.asc()).fetch();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> list;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="聚合函数，本质还是调用数据库的聚合函数"><a href="#聚合函数，本质还是调用数据库的聚合函数" class="headerlink" title="聚合函数，本质还是调用数据库的聚合函数"></a>聚合函数，本质还是调用数据库的聚合函数</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">MyPersonRepository</span> <span class="keyword">extends</span> <span class="title class_">Repository</span>&lt;Person, Integer&gt; &#123;</span><br><span class="line">  <span class="keyword">default</span> List&lt;String&gt; <span class="title function_">queryDSL</span><span class="params">(JPAQueryFactory jPAQueryFactory)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">var</span> <span class="variable">person</span> <span class="operator">=</span> QPerson.person;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> max=jPAQueryFactory.select(person.age.max()).from(person).fetchOne();</span><br><span class="line">    System.out.println(max);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> min=jPAQueryFactory.select(person.age.min()).from(person).fetchOne();</span><br><span class="line">    System.out.println(min);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> avg=jPAQueryFactory.select(person.age.avg()).from(person).fetchOne();</span><br><span class="line">    System.out.println(avg);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> sum=jPAQueryFactory.select(person.age.sum()).from(person).fetchOne();</span><br><span class="line">    System.out.println(sum);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//数字的减法，需要的有加法等</span></span><br><span class="line">    <span class="keyword">var</span> list=jPAQueryFactory.select(person.age.subtract(<span class="number">1</span>)).from(person).fetch();</span><br><span class="line">    list.forEach(p-&gt;&#123;</span><br><span class="line">      System.out.println(p);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//字符可以插入前缀或后缀</span></span><br><span class="line">    <span class="keyword">var</span> list1=jPAQueryFactory.select(person.firstName.prepend(<span class="string">&quot;hi,&quot;</span>)).from(person).fetch();</span><br><span class="line">    list1.forEach(p-&gt;&#123;</span><br><span class="line">      System.out.println(p);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> list1;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h3 id="spring-扩展的-参数分页和排序-Pageable-Sort"><a href="#spring-扩展的-参数分页和排序-Pageable-Sort" class="headerlink" title="spring 扩展的 参数分页和排序-Pageable/Sort"></a>spring 扩展的 参数分页和排序-Pageable/Sort</h3><p>Pageable 分页</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">MyPersonRepository</span> <span class="keyword">extends</span> <span class="title class_">Repository</span>&lt;Person, Integer&gt; &#123;</span><br><span class="line">      Page&lt;Person&gt; <span class="title function_">findPersonByName</span><span class="params">(String name, Pageable pageable)</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@ComponentScan(&#123;&quot;com.hank&quot;&#125;)</span></span><br><span class="line"><span class="meta">@EnableJpaRepositories(</span></span><br><span class="line"><span class="meta">    basePackages = &#123;&quot;com.hank.Pesis&quot;&#125;,</span></span><br><span class="line"><span class="meta">    entityManagerFactoryRef = &quot;myEntityManagerFactory&quot;,</span></span><br><span class="line"><span class="meta">    transactionManagerRef = &quot;jdbcTransactionManager&quot;</span></span><br><span class="line"><span class="meta">)</span></span><br><span class="line"><span class="meta">@EnableTransactionManagement</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Programmer</span> &#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="type">var</span>  <span class="variable">context</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AnnotationConfigApplicationContext</span>(Programmer.class);</span><br><span class="line">    <span class="type">var</span> <span class="variable">repository</span> <span class="operator">=</span> context.getBean(MyPersonRepository.class);</span><br><span class="line"></span><br><span class="line">    Pageable pageable= PageRequest.of(<span class="number">0</span>,<span class="number">2</span> );</span><br><span class="line">    <span class="keyword">var</span> pages= repository.findPersonByName(<span class="string">&quot;ok&quot;</span>, pageable);</span><br><span class="line">    System.out.println(<span class="string">&quot;可查询的总总页数&quot;</span>+pages.getTotalPages());</span><br><span class="line">    System.out.println(<span class="string">&quot;可查询的总条目数&quot;</span>+pages.getTotalElements());</span><br><span class="line">    System.out.println(<span class="string">&quot;本次查询到的集合&quot;</span>+pages.get().collect(Collectors.toList()));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Sort 排序</p>
<p>推荐 Sort.TypedSort&lt;&gt; 排序，而不是硬编码的排序</p>
<p>public interface MyPersonRepository extends Repository&lt;Person, Integer&gt; {<br>      List<Person> findPersonByName(String name, Sort sort);<br>}</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ComponentScan(&#123;&quot;com.hank&quot;&#125;)</span></span><br><span class="line"><span class="meta">@EnableJpaRepositories(</span></span><br><span class="line"><span class="meta">    basePackages = &#123;&quot;com.hank.Pesis&quot;&#125;,</span></span><br><span class="line"><span class="meta">    entityManagerFactoryRef = &quot;myEntityManagerFactory&quot;,</span></span><br><span class="line"><span class="meta">    transactionManagerRef = &quot;jdbcTransactionManager&quot;</span></span><br><span class="line"><span class="meta">)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@ComponentScan(&#123;&quot;com.hank&quot;&#125;)</span></span><br><span class="line"><span class="meta">@EnableJpaRepositories(</span></span><br><span class="line"><span class="meta">    basePackages = &#123;&quot;com.hank.Pesis&quot;&#125;,</span></span><br><span class="line"><span class="meta">    entityManagerFactoryRef = &quot;myEntityManagerFactory&quot;,</span></span><br><span class="line"><span class="meta">    transactionManagerRef = &quot;jdbcTransactionManager&quot;</span></span><br><span class="line"><span class="meta">)</span></span><br><span class="line"><span class="meta">@EnableTransactionManagement</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Programmer</span> &#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="type">var</span>  <span class="variable">context</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AnnotationConfigApplicationContext</span>(Programmer.class);</span><br><span class="line">    <span class="type">var</span> <span class="variable">repository</span> <span class="operator">=</span> context.getBean(MyPersonRepository.class);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//硬编码的排序</span></span><br><span class="line">    Sort sort=Sort.by(<span class="string">&quot;name&quot;</span>).ascending();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//强类型引用的排序</span></span><br><span class="line">    Sort.TypedSort&lt;Person&gt; sortPerson=Sort.sort(Person.class);</span><br><span class="line">    sortPerson.by(Person::getName).ascending();</span><br><span class="line">    <span class="keyword">var</span> list= repository.findPersonByName(<span class="string">&quot;ok&quot;</span>, sortPerson);</span><br><span class="line">    System.out.println(list);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>分页和排序一起使用</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">MyPersonRepository</span> <span class="keyword">extends</span> <span class="title class_">Repository</span>&lt;Person, Integer&gt; &#123;</span><br><span class="line">     Page&lt;Person&gt; <span class="title function_">findPersonByName</span><span class="params">(String name, Pageable pageable)</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@ComponentScan(&#123;&quot;com.hank&quot;&#125;)</span></span><br><span class="line"><span class="meta">@EnableJpaRepositories(</span></span><br><span class="line"><span class="meta">    basePackages = &#123;&quot;com.hank.Pesis&quot;&#125;,</span></span><br><span class="line"><span class="meta">    entityManagerFactoryRef = &quot;myEntityManagerFactory&quot;,</span></span><br><span class="line"><span class="meta">    transactionManagerRef = &quot;jdbcTransactionManager&quot;</span></span><br><span class="line"><span class="meta">)</span></span><br><span class="line"><span class="meta">@EnableTransactionManagement</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Programmer</span> &#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="type">var</span>  <span class="variable">context</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AnnotationConfigApplicationContext</span>(Programmer.class);</span><br><span class="line">    <span class="type">var</span> <span class="variable">repository</span> <span class="operator">=</span> context.getBean(MyPersonRepository.class);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    Sort.TypedSort&lt;Person&gt; sortPerson=Sort.sort(Person.class);</span><br><span class="line">    sortPerson.by(Person::getName).ascending();</span><br><span class="line">     </span><br><span class="line">    <span class="comment">//分页和排序</span></span><br><span class="line">    Pageable pageable= PageRequest.of(<span class="number">0</span>,<span class="number">2</span> ,sortPerson);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> pages= repository.findPersonByName(<span class="string">&quot;ok&quot;</span>, pageable);</span><br><span class="line">    System.out.println(<span class="string">&quot;可查询的总总页数&quot;</span>+pages.getTotalPages());</span><br><span class="line">    System.out.println(<span class="string">&quot;可查询的总条目数&quot;</span>+pages.getTotalElements());</span><br><span class="line">    System.out.println(<span class="string">&quot;本次查询到的集合&quot;</span>+pages.get().collect(Collectors.toList()));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="查询返回结果"><a href="#查询返回结果" class="headerlink" title="查询返回结果"></a>查询返回结果</h3><p>常见的返回结果：</p>
<ol>
<li>List</li>
<li>Slice</li>
<li>Page</li>
<li>Stream</li>
<li>CompletableFuture</li>
<li>Optional</li>
</ol>
<p><em>Stream 流的传输需要数据库的配合,数据库要支持数据的流式传输才行，需要在消费流的方法上加  @Transactional(readOnly = true)，流在用完后记得要关闭，这种方式的好处是对数据量大处理比较好</em></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Bar</span>&#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> MyPersonRepository myPersonRepository;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="title function_">Bar</span><span class="params">(MyPersonRepository myPersonRepository)</span>&#123;</span><br><span class="line">      <span class="built_in">this</span>.myPersonRepository=myPersonRepository;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Transactional(readOnly = true)</span></span><br><span class="line">   <span class="keyword">public</span>  <span class="keyword">void</span> <span class="title function_">f</span><span class="params">()</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//自动关闭流</span></span><br><span class="line">    <span class="keyword">try</span>(<span class="keyword">var</span> stream= myPersonRepository.findPersonByName(<span class="string">&quot;ok&quot;</span>)) &#123;</span><br><span class="line">        stream.forEach(p-&gt; System.out.println(p.getId()));</span><br><span class="line">    &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><em>CompletableFuture 可以使用Spring的异步方法执行功能异步的存储库查询。这意味着方法将在调用时立即返回，并且实际的查询执行将发生在已提交给Spring TaskExecutor的任务中,比较适合定时任务的实际场景</em></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">MyPersonRepository</span> <span class="keyword">extends</span> <span class="title class_">Repository</span>&lt;Person, Integer&gt; &#123;</span><br><span class="line">    CompletableFuture&lt;List&lt;Person&gt;&gt; <span class="title function_">findPersonByName</span><span class="params">(String name)</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@ComponentScan(&#123;&quot;com.hank&quot;&#125;)</span></span><br><span class="line"><span class="meta">@EnableJpaRepositories(</span></span><br><span class="line"><span class="meta">    basePackages = &#123;&quot;com.hank.Pesis&quot;&#125;,</span></span><br><span class="line"><span class="meta">    entityManagerFactoryRef = &quot;myEntityManagerFactory&quot;,</span></span><br><span class="line"><span class="meta">    transactionManagerRef = &quot;jdbcTransactionManager&quot;</span></span><br><span class="line"><span class="meta">)</span></span><br><span class="line"><span class="meta">@EnableTransactionManagement</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Programmer</span> &#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="type">var</span>  <span class="variable">context</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AnnotationConfigApplicationContext</span>(Programmer.class);</span><br><span class="line">    <span class="keyword">var</span>  repository=context.getBean(MyPersonRepository.class);</span><br><span class="line">    <span class="keyword">var</span>  future=repository.findPersonByName(<span class="string">&quot;ok&quot;</span>);</span><br><span class="line"></span><br><span class="line">    future.thenAcceptAsync(p-&gt;&#123;</span><br><span class="line">      System.out.println(p.stream().collect(Collectors.toList()));</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    System.out.println(<span class="string">&quot;结束&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>Page 继承自 Slice ,Slice 不返回分页的可以使用的总页数，关心的是是否有下一页</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">MyPersonRepository</span> <span class="keyword">extends</span> <span class="title class_">Repository</span>&lt;Person, Integer&gt; &#123;</span><br><span class="line">    Slice&lt;Person&gt; <span class="title function_">findPersonByFirstName</span><span class="params">(String name,Pageable pageable)</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@ComponentScan(&#123;&quot;com.hank&quot;&#125;)</span></span><br><span class="line"><span class="meta">@EnableJpaRepositories(</span></span><br><span class="line"><span class="meta">    basePackages = &#123;&quot;com.hank.Pesis&quot;&#125;,</span></span><br><span class="line"><span class="meta">    entityManagerFactoryRef = &quot;myEntityManagerFactory&quot;,</span></span><br><span class="line"><span class="meta">    transactionManagerRef = &quot;jdbcTransactionManager&quot;</span></span><br><span class="line"><span class="meta">)</span></span><br><span class="line"><span class="meta">@EnableTransactionManagement</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Programmer</span> &#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="type">var</span> <span class="variable">context</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AnnotationConfigApplicationContext</span>(Programmer.class);</span><br><span class="line">    <span class="type">var</span> <span class="variable">repository</span> <span class="operator">=</span> context.getBean(MyPersonRepository.class);</span><br><span class="line">    <span class="type">var</span> <span class="variable">pageable</span> <span class="operator">=</span> PageRequest.of(<span class="number">0</span>, <span class="number">2</span>);</span><br><span class="line">    <span class="type">var</span> <span class="variable">slice</span> <span class="operator">=</span> repository.findPersonByFirstName(<span class="string">&quot;ok&quot;</span>, pageable);</span><br><span class="line">    System.out.println(slice.getContent());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(slice.hasNext())&#123;</span><br><span class="line">      System.out.println(<span class="string">&quot;还有数据可以加载&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>使用 Optional  避免空指针</p>
<p>如下代码会报错 ❌</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">MyPersonRepository</span> <span class="keyword">extends</span> <span class="title class_">Repository</span>&lt;Person, Integer&gt; &#123;</span><br><span class="line">   Person <span class="title function_">findTop1ByFirstName</span><span class="params">(String name)</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@ComponentScan(&#123;&quot;com.hank&quot;&#125;)</span></span><br><span class="line"><span class="meta">@EnableJpaRepositories(</span></span><br><span class="line"><span class="meta">    basePackages = &#123;&quot;com.hank.Pesis&quot;&#125;,</span></span><br><span class="line"><span class="meta">    entityManagerFactoryRef = &quot;myEntityManagerFactory&quot;,</span></span><br><span class="line"><span class="meta">    transactionManagerRef = &quot;jdbcTransactionManager&quot;</span></span><br><span class="line"><span class="meta">)</span></span><br><span class="line"><span class="meta">@EnableTransactionManagement</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Programmer</span> &#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="type">var</span> <span class="variable">context</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AnnotationConfigApplicationContext</span>(Programmer.class);</span><br><span class="line">    <span class="type">var</span> <span class="variable">repository</span> <span class="operator">=</span> context.getBean(MyPersonRepository.class);</span><br><span class="line">    <span class="comment">//会报空指针异常</span></span><br><span class="line">    <span class="type">var</span> <span class="variable">person</span> <span class="operator">=</span> repository.findTop1ByFirstName(<span class="string">&quot;not exist&quot;</span>);</span><br><span class="line">    System.out.println(person);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>正确的方法 Optional ✅</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">MyPersonRepository</span> <span class="keyword">extends</span> <span class="title class_">Repository</span>&lt;Person, Integer&gt; &#123;</span><br><span class="line">   Optional&lt;Person&gt; <span class="title function_">findTop1ByFirstName</span><span class="params">(String name)</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@ComponentScan(&#123;&quot;com.hank&quot;&#125;)</span></span><br><span class="line"><span class="meta">@EnableJpaRepositories(</span></span><br><span class="line"><span class="meta">    basePackages = &#123;&quot;com.hank.Pesis&quot;&#125;,</span></span><br><span class="line"><span class="meta">    entityManagerFactoryRef = &quot;myEntityManagerFactory&quot;,</span></span><br><span class="line"><span class="meta">    transactionManagerRef = &quot;jdbcTransactionManager&quot;</span></span><br><span class="line"><span class="meta">)</span></span><br><span class="line"><span class="meta">@EnableTransactionManagement</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Programmer</span> &#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="type">var</span> <span class="variable">context</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AnnotationConfigApplicationContext</span>(Programmer.class);</span><br><span class="line">    <span class="type">var</span> <span class="variable">repository</span> <span class="operator">=</span> context.getBean(MyPersonRepository.class);</span><br><span class="line">    <span class="type">var</span> <span class="variable">optionalPerson</span> <span class="operator">=</span> repository.findTop1ByFirstName(<span class="string">&quot;not exist&quot;</span>);</span><br><span class="line">    optionalPerson.ifPresent(p-&gt;&#123;</span><br><span class="line">      System.out.println(p);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Projections（投影）对查询结果的扩展"><a href="#Projections（投影）对查询结果的扩展" class="headerlink" title="Projections（投影）对查询结果的扩展"></a>Projections（投影）对查询结果的扩展</h3><h4 id="基于接口的投影"><a href="#基于接口的投影" class="headerlink" title="基于接口的投影"></a>基于接口的投影</h4><p>使用方法定义查询是不能返回部分属性的，通过 Projections 可以解决<br>如下代码查询数据库的时候只会查询一个属性</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="meta">@Setter</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Person</span> &#123;</span><br><span class="line">  <span class="meta">@Id</span></span><br><span class="line">  <span class="meta">@Column(name = &quot;id&quot;, nullable = false)</span></span><br><span class="line">  <span class="meta">@GeneratedValue(strategy = GenerationType.IDENTITY)</span></span><br><span class="line">  <span class="keyword">private</span> <span class="type">int</span> id;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Column(name = &quot;firstName&quot;, nullable = true)</span></span><br><span class="line">  String firstName;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Column(name = &quot;lastName&quot;, nullable = true)</span></span><br><span class="line">  String lastName;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//只需要查询一个属性，接口里要写获取属性的方法</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">MyReturn</span> &#123;</span><br><span class="line">    String <span class="title function_">getFirstName</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">MyPersonRepository</span> <span class="keyword">extends</span> <span class="title class_">Repository</span>&lt;Person, Integer&gt; &#123;</span><br><span class="line">    MyReturn  <span class="title function_">findFirstByFirstName</span><span class="params">(String name)</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@ComponentScan(&#123;&quot;com.hank&quot;&#125;)</span></span><br><span class="line"><span class="meta">@EnableJpaRepositories(</span></span><br><span class="line"><span class="meta">    basePackages = &#123;&quot;com.hank.Pesis&quot;&#125;,</span></span><br><span class="line"><span class="meta">    entityManagerFactoryRef = &quot;myEntityManagerFactory&quot;,</span></span><br><span class="line"><span class="meta">    transactionManagerRef = &quot;jdbcTransactionManager&quot;</span></span><br><span class="line"><span class="meta">)</span></span><br><span class="line"><span class="meta">@EnableTransactionManagement</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Programmer</span> &#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="type">var</span> <span class="variable">context</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AnnotationConfigApplicationContext</span>(Programmer.class);</span><br><span class="line">    <span class="type">var</span> <span class="variable">repository</span> <span class="operator">=</span> context.getBean(MyPersonRepository.class);</span><br><span class="line">    <span class="type">var</span> <span class="variable">result</span> <span class="operator">=</span> repository.findFirstByFirstName(<span class="string">&quot;ok1&quot;</span>);</span><br><span class="line">    System.out.println(result.getFirstName());</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如下方法对返回的结果在一个方法里进行投影</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">MyReturn</span> &#123;</span><br><span class="line">    <span class="meta">@Value(&quot;#&#123;target.firstName+&#x27;,&#x27;+target.lastName&#125;&quot;)</span></span><br><span class="line">    String <span class="title function_">getFullName</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//或者</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Component(&quot;myBean&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyBean</span> &#123;</span><br><span class="line">  <span class="keyword">public</span> String <span class="title function_">getFullName</span><span class="params">(Person person)</span>&#123;</span><br><span class="line">      <span class="comment">//这里可以写复杂的语句用于生成结果</span></span><br><span class="line">      <span class="keyword">return</span>  person.getFirstName()+<span class="string">&quot;,&quot;</span>+person.getLastName();</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">MyReturn</span> &#123;</span><br><span class="line">  <span class="meta">@Value(&quot;#&#123;@myBean.getFullName(target)&#125;&quot;)</span></span><br><span class="line">  String <span class="title function_">getFullName</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="基于DTO-类的投影-推荐"><a href="#基于DTO-类的投影-推荐" class="headerlink" title="基于DTO 类的投影-推荐"></a>基于DTO 类的投影-推荐</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyReturnDto</span> &#123;</span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">final</span> String firstName;</span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">final</span> String lastName;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">public</span>  <span class="title function_">MyReturnDto</span><span class="params">(String firstName, String lastName)</span>&#123;</span><br><span class="line">         <span class="built_in">this</span>.firstName=firstName;</span><br><span class="line">        <span class="built_in">this</span>.lastName=lastName;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">public</span>  String <span class="title function_">getFullName</span><span class="params">()</span>&#123;</span><br><span class="line">      <span class="keyword">return</span>  firstName+<span class="string">&quot;,&quot;</span>+lastName;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//@Value lombok 简化</span></span><br><span class="line"><span class="meta">@Value</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyReturnDto</span> &#123;</span><br><span class="line">   <span class="keyword">private</span>  String firstName;</span><br><span class="line">   <span class="keyword">private</span>  String lastName;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">public</span>  String <span class="title function_">getFullName</span><span class="params">()</span>&#123;</span><br><span class="line">      <span class="keyword">return</span>  firstName+<span class="string">&quot;,&quot;</span>+lastName;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">MyPersonRepository</span> <span class="keyword">extends</span> <span class="title class_">Repository</span>&lt;Person, Integer&gt; &#123;</span><br><span class="line">    MyReturnDto  <span class="title function_">findFirstByFirstName</span><span class="params">(String name)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="jpa-hibernate-实体的继承关系"><a href="#jpa-hibernate-实体的继承关系" class="headerlink" title="jpa-hibernate 实体的继承关系"></a>jpa-hibernate 实体的继承关系</h1><p>会使得表与实体之间的关系变得复杂不直观,增加复杂度，不建议使用。</p>
<h2 id="MappedSuperclass-只能用在类上"><a href="#MappedSuperclass-只能用在类上" class="headerlink" title="@MappedSuperclass 只能用在类上"></a>@MappedSuperclass 只能用在类上</h2><p>基于代码复用和模型分离的思想，在项目开发中使用JPA的@MappedSuperclass注解将实体类的多个属性分别封装到不同的非实体类中，纯粹的继承，和表没关系，对象之间的字段共享<br>注意:</p>
<ol>
<li>标注为@MappedSuperclass的类将不是一个完整的实体类，他将不会映射到数据库表，但是他的属性都将映射到其子类的数据库字段中。</li>
<li>标注为@MappedSuperclass的类不能再标注@Entity或@Table注解，也无需实现序列化接口。</li>
</ol>
<p>此表在数据库不会存在</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Setter</span></span><br><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="meta">@MappedSuperclass</span></span><br><span class="line"><span class="keyword">public</span>  <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">Audit</span> &#123;</span><br><span class="line">  <span class="meta">@Column(name = &quot;createUser&quot;)</span></span><br><span class="line">  <span class="keyword">private</span>   String createBy;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Column(name = &quot;editUser&quot;)</span></span><br><span class="line">  <span class="keyword">private</span>   String editBy;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">继承 @MappedSuperclass 标注的类</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Bar</span> <span class="keyword">extends</span>  <span class="title class_">Audit</span> &#123;</span><br><span class="line">  <span class="meta">@Id</span></span><br><span class="line">  <span class="meta">@Column(name = &quot;id&quot;, nullable = false)</span></span><br><span class="line">  <span class="meta">@GeneratedValue</span></span><br><span class="line">  <span class="keyword">private</span> Long id;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h2 id="SecondaryTable-数据库把主表的部分字段分到子表-不用-增加复杂度"><a href="#SecondaryTable-数据库把主表的部分字段分到子表-不用-增加复杂度" class="headerlink" title="@SecondaryTable 数据库把主表的部分字段分到子表 -不用,增加复杂度"></a>@SecondaryTable 数据库把主表的部分字段分到子表 -不用,增加复杂度</h2><p>子表1</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Setter</span></span><br><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Base1</span> &#123;</span><br><span class="line">  <span class="meta">@Id</span></span><br><span class="line">  <span class="keyword">private</span> Long id;</span><br><span class="line">  <span class="keyword">public</span> String name1;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">子表<span class="number">2</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Setter</span></span><br><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Base2</span> &#123;</span><br><span class="line">  <span class="meta">@Id</span></span><br><span class="line">  <span class="keyword">private</span> Long id;</span><br><span class="line">  <span class="keyword">public</span> String name2;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>主表   @SecondaryTable(name =”base1”,pkJoinColumns = @PrimaryKeyJoinColumn(name = “id”)) 指定主表的相关字段数据保存在子表<br>在数据库里主表自有 id ,name  字段，其他字段都是保存在子表里</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="meta">@Setter</span></span><br><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="comment">//定义子表的路径在哪里</span></span><br><span class="line"><span class="meta">@SecondaryTable(name =&quot;base1&quot;,pkJoinColumns = @PrimaryKeyJoinColumn(name = &quot;id&quot;))</span></span><br><span class="line"><span class="meta">@SecondaryTable(name =&quot;base2&quot;,pkJoinColumns = @PrimaryKeyJoinColumn(name = &quot;id&quot;))</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Bar</span> &#123;</span><br><span class="line">  <span class="meta">@Id</span></span><br><span class="line">  <span class="meta">@Column(name = &quot;id&quot;, nullable = false)</span></span><br><span class="line">  <span class="meta">@GeneratedValue(strategy = GenerationType.IDENTITY)</span></span><br><span class="line">  <span class="keyword">private</span> Long id;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span>  String name;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">//告诉 jpa 此字段的数据保存在那个子表</span></span><br><span class="line">  <span class="meta">@Column(table = &quot;base1&quot;)</span></span><br><span class="line">  <span class="keyword">public</span> String name1;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//告诉 jpa 此字段的数据保存在那个子表</span></span><br><span class="line">  <span class="meta">@Column(table = &quot;base2&quot;)</span></span><br><span class="line">  <span class="keyword">public</span> String name2;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Inheritance-不用-增加复杂度"><a href="#Inheritance-不用-增加复杂度" class="headerlink" title="@Inheritance -不用,增加复杂度"></a>@Inheritance -不用,增加复杂度</h2><ol>
<li>@Inheritance (strategy = InheritanceType.SINGLE_TABLE) 将所有父类和子类集合在一张表，只有父类有 @Table ,其他表的字段集合到父类 ,在父类里加字段进行区分子类</li>
<li>@Inheritance (strategy = InheritanceType.TABLE_PER_CLASS) 每个子类会生成一张单独的表，父类可以查询所有子类的表数据</li>
<li>@Inheritance (strategy = InheritanceType.JOINED) 每个类分别生成一张单独的表，但是每张表只有自己的属性，没有父类的属性，通过外键关联的形式使两张表关联起来</li>
</ol>
<h1 id="jpa-hibernate-Entity-Callbacks-的回调方法"><a href="#jpa-hibernate-Entity-Callbacks-的回调方法" class="headerlink" title="jpa-hibernate @Entity Callbacks-的回调方法"></a>jpa-hibernate @Entity Callbacks-的回调方法</h1><p>JPA 协议里面规定，可以通过一些注解，为其监听回调事件、指定回调方法</p>
<table>
<thead>
<tr>
<th>注解</th>
<th>备注</th>
</tr>
</thead>
<tbody><tr>
<td>@PrePersist</td>
<td>在新增之前的回调</td>
</tr>
<tr>
<td>@PostPersist</td>
<td>在新增到数据库之前的回调</td>
</tr>
<tr>
<td>@PreRemove</td>
<td>在数据库删除之前的回调</td>
</tr>
<tr>
<td>@PostRemove</td>
<td>在数据库删除成功之后的回调</td>
</tr>
<tr>
<td>@PreUpdate</td>
<td>在更新到数据库之前回调</td>
</tr>
<tr>
<td>@PostUpdate</td>
<td>在数据库更新之后的回调</td>
</tr>
<tr>
<td>@PostLoad</td>
<td>在实体加载之后的回调</td>
</tr>
</tbody></table>
<p>语法注意事项，关于上表所述的几个方法有一些需要注意的地方，如下：</p>
<ol>
<li>回调函数都是和 EntityManager.flush 或 EntityManager.commit 在同一个线程里面执行的，只不过调用方法有先后之分，都是同步调用，所以当任何一个回调方法里面发生异常，都会触发事务进行回滚，而不会触发事务提交。</li>
<li>Callbacks 注解可以放在实体里面，可以放在 super-class 里面，也可以定义在 entity 的 listener 里面，但需要注意的是：放在实体（或者 super-class）里面的方法，签名格式为“void ()”，即没有参数，方法里面操作的是 this 对象自己；放在实体的 EntityListener 里面的方法签名格式为“void (Object)”，也就是方法可以有参数，参数是代表用来接收回调方法的实体。</li>
<li>使上述注解生效的回调方法可以是 public、private、protected、friendly 类型的，但是不能是 static 和 final 类型的方法。</li>
</ol>
<h2 id="在标注-super-class-注解的实体里写回调方法"><a href="#在标注-super-class-注解的实体里写回调方法" class="headerlink" title="在标注 @super-class 注解的实体里写回调方法"></a>在标注 @super-class 注解的实体里写回调方法</h2><p>在 @MappedSuperclass 标记的类里，声明的回调会在所有的实现类里起到横向拦截的功能，可以自己实现审计追踪的功能</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Setter</span></span><br><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="meta">@MappedSuperclass</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span>  <span class="keyword">class</span> <span class="title class_">Audit</span> &#123;</span><br><span class="line">  <span class="meta">@Column(name = &quot;createUser&quot;)</span></span><br><span class="line">  <span class="keyword">private</span>   String createBy;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Column(name = &quot;editUser&quot;)</span></span><br><span class="line">  <span class="keyword">private</span>   String editBy;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@PrePersist</span></span><br><span class="line">  <span class="keyword">public</span>  <span class="keyword">void</span> <span class="title function_">prePersist</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="comment">//在新增数据未到数据库前，修改的数据会到数据库</span></span><br><span class="line">    <span class="built_in">this</span>.setCreateBy( <span class="built_in">this</span>.getCreateBy()+<span class="string">&quot;新增前&quot;</span>);</span><br><span class="line">    System.out.println(<span class="built_in">this</span>+<span class="string">&quot;,prePersist&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="meta">@PostPersist</span></span><br><span class="line">  <span class="keyword">public</span>  <span class="keyword">void</span> <span class="title function_">postPersist</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="comment">//数据已经新增到数据库了，此时修改的数据并不能保存到数据库</span></span><br><span class="line">    <span class="built_in">this</span>.setCreateBy( <span class="built_in">this</span>.getCreateBy()+<span class="string">&quot;新增后&quot;</span>);</span><br><span class="line">    System.out.println(<span class="built_in">this</span>+<span class="string">&quot;,postPersist&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@PreUpdate</span></span><br><span class="line">  <span class="keyword">public</span>  <span class="keyword">void</span> <span class="title function_">preUpdate</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="comment">//在新增数据未到数据库前，修改的数据会到数据库</span></span><br><span class="line">    <span class="built_in">this</span>.setCreateBy( <span class="built_in">this</span>.getCreateBy()+<span class="string">&quot;更新前&quot;</span>);</span><br><span class="line">    System.out.println(<span class="built_in">this</span>+<span class="string">&quot;,preUpdate&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@PostUpdate</span></span><br><span class="line">  <span class="keyword">public</span>  <span class="keyword">void</span> <span class="title function_">postUpdate</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="comment">//数据已经新增到数据库了，此时修改的数据并不能保存到数据库</span></span><br><span class="line">    <span class="built_in">this</span>.setCreateBy( <span class="built_in">this</span>.getCreateBy()+<span class="string">&quot;更新后&quot;</span>);</span><br><span class="line">    System.out.println(<span class="built_in">this</span>+<span class="string">&quot;,postUpdate&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@PreRemove</span></span><br><span class="line">  <span class="keyword">public</span>  <span class="keyword">void</span> <span class="title function_">preRemove</span><span class="params">()</span>&#123;</span><br><span class="line">    System.out.println(<span class="built_in">this</span>+<span class="string">&quot;,preRemove&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@PostRemove</span></span><br><span class="line">  <span class="keyword">public</span>  <span class="keyword">void</span> <span class="title function_">postRemove</span><span class="params">()</span>&#123;</span><br><span class="line">    System.out.println(<span class="built_in">this</span>+<span class="string">&quot;,postRemove&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@PostLoad</span></span><br><span class="line">  <span class="keyword">public</span>  <span class="keyword">void</span> <span class="title function_">load</span><span class="params">()</span>&#123;</span><br><span class="line">    System.out.println(<span class="built_in">this</span>+<span class="string">&quot;,load&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Bar</span> <span class="keyword">extends</span>  <span class="title class_">Audit</span> &#123;</span><br><span class="line">  <span class="meta">@Id</span></span><br><span class="line">  <span class="meta">@Column(name = &quot;id&quot;, nullable = false)</span></span><br><span class="line">  <span class="meta">@GeneratedValue</span></span><br><span class="line">  <span class="keyword">private</span> Long id;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span>  String <span class="title function_">toString</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>.getCreateBy()+<span class="string">&quot;;&quot;</span>+<span class="built_in">this</span>.getEditBy();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Foo</span> <span class="keyword">extends</span>  <span class="title class_">Audit</span> &#123;</span><br><span class="line">  <span class="meta">@Id</span></span><br><span class="line">  <span class="meta">@Column(name = &quot;id&quot;, nullable = false)</span></span><br><span class="line">  <span class="meta">@GeneratedValue</span></span><br><span class="line">  <span class="keyword">private</span> Long id;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span>  String <span class="title function_">toString</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>.getCreateBy()+<span class="string">&quot;;&quot;</span>+<span class="built_in">this</span>.getEditBy();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="自定义-EntityListener，不建议使用"><a href="#自定义-EntityListener，不建议使用" class="headerlink" title="自定义 EntityListener，不建议使用"></a>自定义 EntityListener，不建议使用</h2><p>此类实例化一次</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyAuditingEntityListener</span> &#123;</span><br><span class="line">  <span class="meta">@PrePersist</span></span><br><span class="line">  <span class="keyword">public</span>  <span class="keyword">void</span> <span class="title function_">prePersist</span><span class="params">(Audit obj)</span>&#123;</span><br><span class="line">    <span class="comment">//在新增数据未到数据库前，修改的数据会到数据库</span></span><br><span class="line">    obj.setCreateBy( obj.getCreateBy()+<span class="string">&quot;新增前&quot;</span>);</span><br><span class="line">    System.out.println(obj+<span class="string">&quot;,prePersist&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="meta">@PostPersist</span></span><br><span class="line">  <span class="keyword">public</span>  <span class="keyword">void</span> <span class="title function_">postPersist</span><span class="params">(Audit obj)</span>&#123;</span><br><span class="line">    <span class="comment">//数据已经新增到数据库了，此时修改的数据并不能保存到数据库</span></span><br><span class="line">    obj.setCreateBy( obj.getCreateBy()+<span class="string">&quot;新增后&quot;</span>);</span><br><span class="line">    System.out.println(obj+<span class="string">&quot;,postPersist&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@PreUpdate</span></span><br><span class="line">  <span class="keyword">public</span>  <span class="keyword">void</span> <span class="title function_">preUpdate</span><span class="params">(Audit obj)</span>&#123;</span><br><span class="line">    <span class="comment">//在新增数据未到数据库前，修改的数据会到数据库</span></span><br><span class="line">    obj.setCreateBy( obj.getCreateBy()+<span class="string">&quot;更新前&quot;</span>);</span><br><span class="line">    System.out.println(obj+<span class="string">&quot;,preUpdate&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@PostUpdate</span></span><br><span class="line">  <span class="keyword">public</span>  <span class="keyword">void</span> <span class="title function_">postUpdate</span><span class="params">(Audit obj)</span>&#123;</span><br><span class="line">    <span class="comment">//数据已经新增到数据库了，此时修改的数据并不能保存到数据库</span></span><br><span class="line">    obj.setCreateBy( obj.getCreateBy()+<span class="string">&quot;更新后&quot;</span>);</span><br><span class="line">    System.out.println(obj+<span class="string">&quot;,postUpdate&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@PreRemove</span></span><br><span class="line">  <span class="keyword">public</span>  <span class="keyword">void</span> <span class="title function_">preRemove</span><span class="params">(Audit obj)</span>&#123;</span><br><span class="line">    System.out.println(obj+<span class="string">&quot;,preRemove&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@PostRemove</span></span><br><span class="line">  <span class="keyword">public</span>  <span class="keyword">void</span> <span class="title function_">postRemove</span><span class="params">(Audit obj)</span>&#123;</span><br><span class="line">    System.out.println(obj+<span class="string">&quot;,postRemove&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@PostLoad</span></span><br><span class="line">  <span class="keyword">public</span>  <span class="keyword">void</span> <span class="title function_">load</span><span class="params">(Audit obj)</span>&#123;</span><br><span class="line">    System.out.println(obj+<span class="string">&quot;,load&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过 @EntityListeners 和回调类进行绑定</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Setter</span></span><br><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="meta">@MappedSuperclass</span></span><br><span class="line"><span class="meta">@EntityListeners(MyAuditingEntityListener.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span>   <span class="keyword">class</span> <span class="title class_">Audit</span> &#123;</span><br><span class="line">  <span class="meta">@Column(name = &quot;createUser&quot;)</span></span><br><span class="line">  <span class="keyword">private</span>   String createBy;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Column(name = &quot;editUser&quot;)</span></span><br><span class="line">  <span class="keyword">private</span>   String editBy;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h1 id="jpa-hibernate-乐观锁和重试机制"><a href="#jpa-hibernate-乐观锁和重试机制" class="headerlink" title="jpa-hibernate 乐观锁和重试机制"></a>jpa-hibernate 乐观锁和重试机制</h1><p>@Version  原理是会在一次查询时获得 version ,做更新后，在更新到数据库前再次到数据库查询最新的 version ，对比这俩个  version 的数值是否相等，如果相等说明在此时间内数据库的此条记录没有更新，本次操作事务可以成功，否则事务执行失败抛出错误</p>
<p><font color=blue>注意点如果是通过 @Query 执行JPQL , version 需要自己控制</font></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Modifying</span></span><br><span class="line"><span class="meta">@Query(&quot;update Account set name=:name, version=:version+1 where id=:id and version=:version&quot;)</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">updateBarByVersion</span><span class="params">(<span class="meta">@Param(&quot;id&quot;)</span> <span class="type">int</span> id,<span class="meta">@Param(&quot;name&quot;)</span> String name, <span class="meta">@Param(&quot;version&quot;)</span> <span class="type">int</span> version)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//service中加判断，抛异常，这样就自己通过数据库实现了乐观锁</span></span><br><span class="line"><span class="meta">@Transactional(rollbackFor = Exception.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">updateBarService</span><span class="params">(Bar bar)</span>&#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span>Dao.updateBarByVersion(bar.getId(),bar.getName(),bar.getVersion());</span><br><span class="line">    <span class="keyword">if</span>(i==<span class="number">0</span>)&#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ObjectOptimisticLockingFailureException</span>(<span class="string">&quot;更新bar失败&quot;</span>,<span class="keyword">new</span> <span class="title class_">Exception</span>());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> i;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><font color=blue>通过JPA 仓库 实现 CRUD , version 字段不要自己控制 ,jpa 会做判断</font></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Bar</span> &#123;</span><br><span class="line">  <span class="meta">@Id</span></span><br><span class="line">  <span class="meta">@Column(name = &quot;id&quot;, nullable = false)</span></span><br><span class="line">  <span class="meta">@GeneratedValue</span></span><br><span class="line">  <span class="keyword">private</span> Long id;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span>  String name;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">//此字段有 JPA 自己进行更新，所以设置 AccessLevel.PRIVATE</span></span><br><span class="line">  <span class="meta">@Version</span></span><br><span class="line">  <span class="meta">@Setter(AccessLevel.PRIVATE)</span></span><br><span class="line">  <span class="keyword">private</span>  <span class="type">int</span> version;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><font color=blue>如果因为 version 不一致就让事务失败了，就放弃此次操作，是不合理的（如网络问题），加入重试机制解决</font></p>
<p><em>@EnableRetry 让重试起作用 , @Retryable 在需要重试方法或类上加此注解</em></p>
<p>@Retryable</p>
<ul>
<li>value：指定发生的异常进行重试 </li>
<li>include：和value一样，默认空，当exclude也为空时，所有异常都重试 </li>
<li>exclude：指定异常不重试，默认空，当include也为空时，所有异常都重试 </li>
<li>maxAttemps：重试次数，默认3 </li>
<li>backoff：重试补偿机制，默认没有</li>
</ul>
<p>@Backoff注解</p>
<ul>
<li>delay:指定延迟后重试 </li>
<li>multiplier:指定延迟的倍数，比如delay=5000l,multiplier=2时，第一次重试为5秒后，第二次为10秒，第三次为20秒</li>
</ul>
<p>@Recover </p>
<ul>
<li>当重试到达指定次数时，被注解的方法将被回调，可以在该方法中进行日志处理。需要注意的是发生的异常和入参类型一致时才会回调。</li>
</ul>
<p>!参考(<a target="_blank" rel="noopener" href="https://www.baeldung.com/spring-retry,https://github.com/spring-projects/spring-retry">https://www.baeldung.com/spring-retry,https://github.com/spring-projects/spring-retry</a>)</p>
<p>依赖的包</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 使用 spring-retry 包实现重试 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.retry<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-retry<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.0.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 重试的机制是 aop 代理，需要引入此包 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.aspectj<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>aspectjrt<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.9.9.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">MyRepository</span> <span class="keyword">extends</span> <span class="title class_">JpaRepository</span>&lt;Bar, Long&gt; &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> 定义基类处理重试</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">@Retryable(value = RuntimeException.class, maxAttempts = 3, backoff = @Backoff(value = 1000, multiplier = 1.5))</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">BaseService</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 被此注解处理的异常，不会向上抛出，除非手动抛出异常</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> exception</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="meta">@Recover</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span>  <span class="title function_">fun</span><span class="params">(RuntimeException exception)</span>&#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;连续重试还是无效：&quot;</span>+exception.getMessage());</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">服务类</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyService</span>  <span class="keyword">extends</span>  <span class="title class_">BaseService</span>&#123;</span><br><span class="line">  <span class="meta">@Autowired</span></span><br><span class="line">  <span class="keyword">private</span> MyRepository  myRepository;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span>  <span class="keyword">void</span> <span class="title function_">f</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="keyword">var</span> result=  myRepository.findById(<span class="number">58L</span>);</span><br><span class="line">    result.ifPresent(p-&gt;&#123;</span><br><span class="line">      p.setName(LocalDateTime.now().toString());</span><br><span class="line">      myRepository.save(p);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>启动类上加 @EnableRetry 注解</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ComponentScan(&#123;&quot;com.hank&quot;&#125;)</span></span><br><span class="line"><span class="meta">@EnableJpaRepositories(</span></span><br><span class="line"><span class="meta">    basePackages = &#123;&quot;com.hank.Pesis&quot;&#125;,</span></span><br><span class="line"><span class="meta">    entityManagerFactoryRef = &quot;myEntityManagerFactory&quot;,</span></span><br><span class="line"><span class="meta">    transactionManagerRef = &quot;jdbcTransactionManager&quot;</span></span><br><span class="line"><span class="meta">)</span></span><br><span class="line"><span class="meta">@EnableRetry</span></span><br><span class="line"><span class="meta">@EnableTransactionManagement</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Programmer</span> &#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="type">var</span> <span class="variable">context</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AnnotationConfigApplicationContext</span>(Programmer.class);</span><br><span class="line">    <span class="keyword">var</span> myService= context.getBean(MyService.class);</span><br><span class="line">    myService.f();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h1 id="jpa-hibernate-提供的注解"><a href="#jpa-hibernate-提供的注解" class="headerlink" title="jpa-hibernate 提供的注解"></a>jpa-hibernate 提供的注解</h1><table>
<thead>
<tr>
<th align="left">注解</th>
<th align="left">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="left">@Entity</td>
<td align="left">将此类标记为实体，被标注的实体，将映射到数据库</td>
</tr>
<tr>
<td align="left">@Embedded</td>
<td align="left">将此类标记为值对象</td>
</tr>
<tr>
<td align="left">@Table</td>
<td align="left">指定此实体的数据的表名,不指定默认用类名</td>
</tr>
<tr>
<td align="left">@Id</td>
<td align="left">将此类的字段标记为主键</td>
</tr>
<tr>
<td align="left">@IdClass</td>
<td align="left">利用外部类定义联合主键，标记在实体类上</td>
</tr>
<tr>
<td align="left">@Column</td>
<td align="left">将此类的字段和数据库的列名进行绑定</td>
</tr>
<tr>
<td align="left">@Version</td>
<td align="left">用于支持乐观锁版本控制</td>
</tr>
<tr>
<td align="left">@Transient</td>
<td align="left">标注的字段不会在数据库中存在,比如年龄可以自动计算</td>
</tr>
<tr>
<td align="left">@Enumerated</td>
<td align="left">如果字段是枚举类型，默认映射到数据库的是 int 类型，如果想要映射字符串 @Enumerated(EnumType.STRING)，建议映射字符串</td>
</tr>
<tr>
<td align="left">@GeneratedValue</td>
<td align="left">为主键生成策略</td>
</tr>
<tr>
<td align="left">@Basic</td>
<td align="left">表示属性是到数据库表的字段的映射。如果实体的字段上没有任何注解，默认即为@Basic</td>
</tr>
<tr>
<td align="left">@Temporal</td>
<td align="left">旧的 java.util.Date 不能区分日期和时间，但是数据库默认有 date , time , datetime. 此注解就是指定映射关系</td>
</tr>
<tr>
<td align="left">@Lob</td>
<td align="left">将属性映射为数据库支持的大数据对象类型</td>
</tr>
<tr>
<td align="left">@Access</td>
<td align="left">用于指定 entity 里面的注解是写在字段上面，还是 get/set 方法上面生效，非必填。在默认不填写的情况下，当实体里面的第一个注解出现在字段上或者 get/set 方法上面，就以第一次出现的方式为准,不能一些写在字段上，一些写在方法上</td>
</tr>
</tbody></table>
<h2 id="Table"><a href="#Table" class="headerlink" title="@Table"></a>@Table</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target(TYPE)</span> </span><br><span class="line"><span class="meta">@Retention(RUNTIME)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Table &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 数据库里的表名</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    String <span class="title function_">name</span><span class="params">()</span> <span class="keyword">default</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** </span></span><br><span class="line"><span class="comment">     * 数据库实例名，在驱动连接的 url 里已经指定了实例，默认不指定数据库的表出现在 url 里的实例里</span></span><br><span class="line"><span class="comment">     *  如果在这里指定实例，这此表会在此实例里创建，如果数据库根本就没有此实例，者创建表的过程失败</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    String <span class="title function_">catalog</span><span class="params">()</span> <span class="keyword">default</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** </span></span><br><span class="line"><span class="comment">     *  不是所有数据库都支持。mySQL 就不支持</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    String <span class="title function_">schema</span><span class="params">()</span> <span class="keyword">default</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 指定此表的唯一约束 </span></span><br><span class="line"><span class="comment">       <span class="doctag">@Table</span>(name = &quot;users&quot;, uniqueConstraints = &#123;</span></span><br><span class="line"><span class="comment">               //复合字段的唯一约束</span></span><br><span class="line"><span class="comment">              <span class="doctag">@UniqueConstraint</span>(columnNames = &#123;&quot;name&quot;, &quot;age&quot;&#125;),</span></span><br><span class="line"><span class="comment">              //单个字段的唯一约束</span></span><br><span class="line"><span class="comment">              <span class="doctag">@UniqueConstraint</span>(columnNames = &#123;&quot;account&quot;&#125;)</span></span><br><span class="line"><span class="comment">       &#125;)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    UniqueConstraint[] uniqueConstraints() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    指定此表的索引</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    Index[] indexes() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="IdClass-，-EmbeddedId-联合主键"><a href="#IdClass-，-EmbeddedId-联合主键" class="headerlink" title="@IdClass ， @EmbeddedId 联合主键"></a>@IdClass ， @EmbeddedId 联合主键</h2><p><em>@Embeddable 与 @EmbeddedId 注解同样可以做到联合主键的效果，并且更方便</em></p>
<p>作为符合主键类，要满足以下几点要求。</p>
<ol>
<li>必须实现Serializable接口。</li>
<li>必须有默认的public无参数的构造方法。</li>
<li>必须覆盖equals和hashCode方法。<ul>
<li>equals方法用于判断两个对象是否相同，EntityManger通过find方法来查找Entity时是根据equals的返回值来判断的。</li>
<li>hashCode方法返回当前对象的哈希码，用于equals判断</li>
</ul>
</li>
</ol>
<p>联合主键必须定义在一个类里</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span>  <span class="keyword">class</span> <span class="title class_">CityIdentity</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line">  <span class="keyword">private</span> String name;</span><br><span class="line">  <span class="keyword">private</span> String address;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><font color=blue>@IdClass 定义联合主键，缺点是要写字符串的硬编码</font></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="comment">//告知 jpa 此实体的的联合组建是 CityIdentity</span></span><br><span class="line"><span class="meta">@IdClass(CityIdentity.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">City</span> &#123;</span><br><span class="line">  <span class="meta">@Id</span></span><br><span class="line">  <span class="meta">@Column(name=&quot;name&quot;)</span></span><br><span class="line">  <span class="comment">//属性名必须是在 CityIdentity 里定义的属性</span></span><br><span class="line">  <span class="keyword">private</span>  String name;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Id</span></span><br><span class="line">  <span class="meta">@Column(name=&quot;address&quot;)</span></span><br><span class="line">  <span class="comment">//属性名必须是在 CityIdentity 里定义的属性</span></span><br><span class="line">  <span class="keyword">private</span>  String address;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="type">int</span> peopleAccount;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">MyPersonRepository</span> <span class="keyword">extends</span> <span class="title class_">CrudRepository</span>&lt;City, CityIdentity&gt; &#123;</span><br><span class="line">     List&lt;City&gt; <span class="title function_">findCityByPeopleAccount</span><span class="params">(<span class="type">int</span> account)</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@ComponentScan(&#123;&quot;com.hank&quot;&#125;)</span></span><br><span class="line"><span class="meta">@EnableJpaRepositories(</span></span><br><span class="line"><span class="meta">    basePackages = &#123;&quot;com.hank.Pesis&quot;&#125;,</span></span><br><span class="line"><span class="meta">    entityManagerFactoryRef = &quot;myEntityManagerFactory&quot;,</span></span><br><span class="line"><span class="meta">    transactionManagerRef = &quot;jdbcTransactionManager&quot;</span></span><br><span class="line"><span class="meta">)</span></span><br><span class="line"><span class="meta">@EnableTransactionManagement</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Programmer</span> &#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="type">var</span> <span class="variable">context</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AnnotationConfigApplicationContext</span>(Programmer.class);</span><br><span class="line">    <span class="type">var</span> <span class="variable">repository</span> <span class="operator">=</span> context.getBean(MyPersonRepository.class);</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">var</span> city=<span class="keyword">new</span> <span class="title class_">City</span>();</span><br><span class="line">      city.setName(<span class="string">&quot;bj&quot;</span>);</span><br><span class="line">      city.setAddress(<span class="string">&quot;维度8&quot;</span>);</span><br><span class="line">      city.setPeopleAccount(<span class="number">10000</span>);</span><br><span class="line">      repository.save(city);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">var</span> city=<span class="keyword">new</span> <span class="title class_">City</span>();</span><br><span class="line">      city.setName(<span class="string">&quot;sh&quot;</span>);</span><br><span class="line">      city.setAddress(<span class="string">&quot;维度8&quot;</span>);</span><br><span class="line">      city.setPeopleAccount(<span class="number">10000</span>);</span><br><span class="line">      repository.save(city);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">var</span> id=<span class="keyword">new</span> <span class="title class_">CityIdentity</span>();</span><br><span class="line">      id.setAddress(<span class="string">&quot;维度8&quot;</span>);</span><br><span class="line">      id.setName(<span class="string">&quot;bj&quot;</span>);</span><br><span class="line">      <span class="comment">//通过ID 查询</span></span><br><span class="line">      <span class="type">var</span> <span class="variable">city</span> <span class="operator">=</span> repository.findById(id);</span><br><span class="line">      System.out.println(city);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p><font color=blue>@EmbeddedId 定义联合主键，优点是不需要要写字符串的硬编码</font></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="comment">//把联合主键定义成嵌入类型</span></span><br><span class="line"><span class="meta">@Embeddable</span></span><br><span class="line"><span class="keyword">public</span>  <span class="keyword">class</span> <span class="title class_">CityIdentity</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> -<span class="number">8229477451589838531L</span>;</span><br><span class="line">  <span class="keyword">private</span> String name;</span><br><span class="line">  <span class="keyword">private</span> String address;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">City</span> &#123;</span><br><span class="line">  <span class="comment">//嵌入式的主键</span></span><br><span class="line">  <span class="meta">@EmbeddedId</span></span><br><span class="line">  <span class="keyword">private</span> CityIdentity cityIdentity;</span><br><span class="line">  <span class="keyword">private</span> <span class="type">int</span> peopleAccount;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="GeneratedValue"><a href="#GeneratedValue" class="headerlink" title="@GeneratedValue"></a>@GeneratedValue</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> <span class="title class_">GenerationType</span> &#123; </span><br><span class="line">    </span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    使用一个特定的数据库表格来保存主键,持久化引擎通过关系数据库的一张特定的表格来生成主键,这种策略的好处就是不依赖于外部环境和数据库的具体实现,在不同数据库间可以很容易的进行移植</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    TABLE, </span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    在某些数据库中,不支持主键自增长,比如Oracle,其提供了一种叫做&quot;序列(sequence)&quot;的机制生成主键</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    SEQUENCE, </span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    数据库生成自增长的 id</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    IDENTITY, </span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    默认值，有 jip 根据数据库引擎自己决定</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    AUTO</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Column"><a href="#Column" class="headerlink" title="@Column"></a>@Column</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target(&#123;METHOD, FIELD&#125;)</span> </span><br><span class="line"><span class="meta">@Retention(RUNTIME)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Column &#123;</span><br><span class="line"></span><br><span class="line">     <span class="comment">/**</span></span><br><span class="line"><span class="comment">      数据库内映射的列名</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    String <span class="title function_">name</span><span class="params">()</span> <span class="keyword">default</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     此字段是否唯一，也可以在 <span class="doctag">@Table</span> 里指定唯一约束</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">unique</span><span class="params">()</span> <span class="keyword">default</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 是否可为 null</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">nullable</span><span class="params">()</span> <span class="keyword">default</span> <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 执行 insert 时是否包含此字段</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">insertable</span><span class="params">()</span> <span class="keyword">default</span> <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 执行 update 时是否包含此字段</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">updatable</span><span class="params">()</span> <span class="keyword">default</span> <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 此字段在数据库中的指定的数据类型</span></span><br><span class="line"><span class="comment">     * 编程语言中字符串一般都用String表示，但是数据库中varcahr数值类型有长度限制，一旦需要大文本，则需要text数值类型</span></span><br><span class="line"><span class="comment">     * 但是String类型默认映射的数值类型是varchar，columnDefinition可以进行额外指定 -&gt; columnDefinition=&quot;text&quot;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    String <span class="title function_">columnDefinition</span><span class="params">()</span> <span class="keyword">default</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * todo 不确定做什么用 </span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    String <span class="title function_">table</span><span class="params">()</span> <span class="keyword">default</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 如果是字符串类型 ，可以指定字符串的长度</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="type">int</span> <span class="title function_">length</span><span class="params">()</span> <span class="keyword">default</span> <span class="number">255</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 表示浮点数的总长度（整数部分和小数部分的长度和）</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="type">int</span> <span class="title function_">precision</span><span class="params">()</span> <span class="keyword">default</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 表示浮点数的小数部分的长度</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="type">int</span> <span class="title function_">scale</span><span class="params">()</span> <span class="keyword">default</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Temporal"><a href="#Temporal" class="headerlink" title="@Temporal"></a>@Temporal</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> <span class="title class_">TemporalType</span> &#123;</span><br><span class="line">    <span class="comment">/** Map as &lt;code&gt;java.sql.Date&lt;/code&gt; */</span></span><br><span class="line">    DATE, </span><br><span class="line">    <span class="comment">/** Map as &lt;code&gt;java.sql.Time&lt;/code&gt; */</span></span><br><span class="line">    TIME, </span><br><span class="line">    <span class="comment">/** Map as &lt;code&gt;java.sql.Timestamp&lt;/code&gt; */</span></span><br><span class="line">    TIMESTAMP</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@IdClass(CityIdentity.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">City</span> &#123;</span><br><span class="line">  <span class="meta">@Id</span></span><br><span class="line">  <span class="meta">@Column(name=&quot;name&quot;)</span></span><br><span class="line">  <span class="keyword">private</span>  String name;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Id</span></span><br><span class="line">  <span class="meta">@Column(name=&quot;address&quot;)</span></span><br><span class="line">  <span class="keyword">private</span>  String address;</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line">  <span class="keyword">private</span> <span class="type">int</span> peopleAccount;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">//为了配合旧的 Date API</span></span><br><span class="line">  <span class="meta">@Temporal(TemporalType.DATE)</span></span><br><span class="line">  <span class="keyword">private</span>  Date overDate;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="comment">//如下采用新的 API 根本不需要 @Temporal 做映射</span></span><br><span class="line">  <span class="keyword">private</span> LocalDate createDate;</span><br><span class="line">  <span class="keyword">private</span> LocalTime updateTime;</span><br><span class="line">  <span class="keyword">private</span> LocalDateTime happenDateTime;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h2 id="Lob"><a href="#Lob" class="headerlink" title="@Lob"></a>@Lob</h2><p>@Lob 注解支持以下数据库类型的字段：</p>
<ol>
<li>Clob（ Character Large Ojects） 类型是长字符串类型，java.sql.Clob、Character[]、char[] 和 String 将被映射为 Clob 类型。</li>
<li>Blob（ Binary Large Objects） 类型是字节类型，java.sql.Blob、Byte[]、byte[] 和实现了 Serializable 接口的类型将被映射为 Blob 类型。</li>
</ol>
<p>注意：Clob、 Blob 占用内存空间较大，一般配合 @Basic(fetch=FetchType.LAZY) 注解将其设置为延迟加载。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//可序列的对象也可以保存为数据库的二进制数据</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EmbObject</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line">   <span class="keyword">private</span>  String name;</span><br><span class="line">   <span class="keyword">private</span>  <span class="type">int</span> account;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BlobObject</span> &#123;</span><br><span class="line">  <span class="meta">@Id</span></span><br><span class="line">  <span class="meta">@Column(name = &quot;id&quot;, nullable = false)</span></span><br><span class="line">  <span class="keyword">private</span> Long id;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">//longblob</span></span><br><span class="line">  <span class="meta">@Lob</span></span><br><span class="line">  <span class="keyword">private</span>  String summary1;</span><br><span class="line">  <span class="comment">//longblob</span></span><br><span class="line">  <span class="meta">@Lob</span></span><br><span class="line">  <span class="keyword">private</span>  <span class="type">char</span>[] summary2;</span><br><span class="line">  <span class="comment">//longblob</span></span><br><span class="line">  <span class="meta">@Lob</span></span><br><span class="line">  <span class="keyword">private</span>  Character[] summary3;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="comment">//longtext</span></span><br><span class="line">  <span class="meta">@Lob</span></span><br><span class="line">  <span class="keyword">private</span>  <span class="type">byte</span>[] face1;</span><br><span class="line">  <span class="comment">//longtext</span></span><br><span class="line">  <span class="meta">@Lob</span></span><br><span class="line">  <span class="keyword">private</span>  Byte[] face2;</span><br><span class="line">  <span class="comment">//longtext</span></span><br><span class="line">  <span class="meta">@Lob</span></span><br><span class="line">  <span class="keyword">private</span>  EmbObject  embObject;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Basic"><a href="#Basic" class="headerlink" title="@Basic"></a>@Basic</h2><p>//TODO 对非关联对象的字段使用延迟加载没有效果<br>某些情况下不需要立即加载某字段的值，可以采用延迟加载</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target(&#123;METHOD, FIELD&#125;)</span> </span><br><span class="line"><span class="meta">@Retention(RUNTIME)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Basic &#123;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    LAZY 延迟加载, 立即加载 EAGER，默认立即加载此字段</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    FetchType <span class="title function_">fetch</span><span class="params">()</span> <span class="keyword">default</span> EAGER;</span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">optional</span><span class="params">()</span> <span class="keyword">default</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Embeddable-Embedded-值对象"><a href="#Embeddable-Embedded-值对象" class="headerlink" title="@Embeddable ,  @Embedded 值对象"></a>@Embeddable ,  @Embedded 值对象</h2><p>注意点：</p>
<ol>
<li>@Embeddable 定义没有主键的值对象</li>
<li>@Embedded   把值对象嵌入实体类里面</li>
<li>@AttributeOverrides 如果一个实体类有多个相同的值对象，用此注解去定义不同值对象在数据库的列名<br>麻烦之处是如果值对象的字段比较多，此注解写起来相当麻烦</li>
</ol>
<p>定义值对象</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Embeddable</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyAddress</span> &#123;</span><br><span class="line">  <span class="keyword">private</span>  String road;</span><br><span class="line">  <span class="keyword">private</span>  String city;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><font color=blue>嵌入值对象到实体对象</font></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CargoOrder</span> &#123;</span><br><span class="line">  <span class="meta">@Id</span></span><br><span class="line">  <span class="keyword">private</span> Long id;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span>  String cargoName;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Embedded</span></span><br><span class="line">  <span class="meta">@AttributeOverrides(&#123;</span></span><br><span class="line"><span class="meta">      @AttributeOverride(name = &quot;road&quot;,column = @Column(name = &quot;sendAddress_road&quot;)),</span></span><br><span class="line"><span class="meta">      @AttributeOverride(name = &quot;city&quot;,column = @Column(name = &quot;sendAddress_city&quot;))</span></span><br><span class="line"><span class="meta">  &#125;)</span></span><br><span class="line">  <span class="keyword">private</span> MyAddress sendAddress;</span><br><span class="line">  </span><br><span class="line">  <span class="meta">@Embedded</span></span><br><span class="line">  <span class="meta">@AttributeOverrides(&#123;</span></span><br><span class="line"><span class="meta">      @AttributeOverride(name = &quot;road&quot;,column = @Column(name = &quot;receiveAddress_road&quot;)),</span></span><br><span class="line"><span class="meta">      @AttributeOverride(name = &quot;city&quot;,column = @Column(name = &quot;receiveAddress_city&quot;))</span></span><br><span class="line"><span class="meta">  &#125;)</span></span><br><span class="line">  <span class="keyword">private</span> MyAddress receiveAddress;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><font color=blue>嵌入值对象集合到实体对象</font></p>
<p>会另外生产一个表用于保存值对象的集合，数据库值对象集合的表和实体表是强关联的表</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CargoOrder</span> &#123;</span><br><span class="line">  <span class="meta">@Id</span></span><br><span class="line">  <span class="meta">@GeneratedValue</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> Long id;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span>  String cargoName;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">  @ElementCollection(fetch = FetchType.EAGER) 设置成立即加载对集合值对象，用默认的懒加载会报错</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  <span class="meta">@ElementCollection(fetch = FetchType.EAGER)</span></span><br><span class="line">  <span class="keyword">private</span> List&lt;MyAddress&gt; receiveAddress;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>针对集合也的写一个强类型的转换器</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 此注解会被 spring jpa 全局使用,不需要在值对象字段上加 @Convert(converter = MyInstanceJpaConvertJson.class)</span></span><br><span class="line"><span class="comment">// 如果不加此注解，需要在值对象字段上加 @Convert(converter = MyInstanceJpaConvertJson.class)</span></span><br><span class="line"><span class="comment">// @Converter(autoApply = true)</span></span><br><span class="line"><span class="meta">@Converter</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyInstanceJpaConvertJson1</span> <span class="keyword">implements</span>  <span class="title class_">JpaConverterJson</span>&lt;List&lt;Contacts&gt;&gt; &#123;</span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> List&lt;Contacts&gt; <span class="title function_">getInstance</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;Contacts&gt;() ;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="值对象的其他解决方法"><a href="#值对象的其他解决方法" class="headerlink" title="值对象的其他解决方法"></a>值对象的其他解决方法</h3><p>值对象作为可序列化对象</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Contacts</span>  <span class="keyword">implements</span>  <span class="title class_">Serializable</span> &#123;</span><br><span class="line">  <span class="keyword">private</span>  String name;</span><br><span class="line">  <span class="keyword">private</span>  String  phone;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><font color=blue>序列化为二进制数据，对集合不行</font></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CargoOrder</span> &#123;</span><br><span class="line">  <span class="meta">@Id</span></span><br><span class="line">  <span class="keyword">private</span> Long id;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span>  String cargoName;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//默认不加注解,保存到数据库是二进制数据</span></span><br><span class="line">  <span class="meta">@Column(name = &quot;sendContacts&quot;)</span></span><br><span class="line">  <span class="keyword">private</span> Contacts sendContacts;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><font color=blue>自定义保存方式，这个最为灵活</font></p>
<p>自定义一个数据库和实体字段转换器，此转换器把对象转换为 json 字符串</p>
<p>定义一个泛型的转换器</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">JpaConverterJson</span>&lt;T&gt; <span class="keyword">extends</span> <span class="title class_">AttributeConverter</span>&lt;T, String&gt; &#123;</span><br><span class="line"></span><br><span class="line">  T <span class="title function_">getInstance</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">final</span> <span class="keyword">static</span> <span class="type">ObjectMapper</span> <span class="variable">objectMapper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>();</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">default</span> <span class="keyword">public</span> String <span class="title function_">convertToDatabaseColumn</span><span class="params">(T meta)</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> objectMapper.writeValueAsString(meta);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (JsonProcessingException ex) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">      <span class="comment">// or throw an error</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">default</span> <span class="keyword">public</span> T <span class="title function_">convertToEntityAttribute</span><span class="params">(String dbData)</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="type">var</span> <span class="variable">obj</span> <span class="operator">=</span> objectMapper.readValue(dbData, (Class&lt;T&gt;) getInstance().getClass());</span><br><span class="line">      <span class="keyword">return</span> obj;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException ex) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>强类型的转换器，每个值对象都要定义一个</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// @Converter(autoApply = true) 此注解会被 spring jpa 全局使用,不需要在值对象字段上加 @Convert(converter = MyInstanceJpaConvertJson.class)</span></span><br><span class="line"><span class="comment">// @Converter注解，需要在值对象字段上加 @Convert(converter = MyInstanceJpaConvertJson.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyInstanceJpaConvertJson</span> <span class="keyword">implements</span>  <span class="title class_">JpaConverterJson</span>&lt;Contacts&gt; &#123;</span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> Contacts <span class="title function_">getInstance</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Contacts</span>();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>对实体里的值对象字段应用转换器</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CargoOrder</span> &#123;</span><br><span class="line">  <span class="meta">@Id</span></span><br><span class="line">  <span class="keyword">private</span> Long id;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span>  String cargoName;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Column(name = &quot;receiveContacts&quot;)</span></span><br><span class="line">  <span class="meta">@Convert(converter = MyInstanceJpaConvertJson.class)</span></span><br><span class="line">  <span class="keyword">private</span>  Contacts receiveContacts;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><font color=blue>嵌入值对象集合到实体对象</font></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CargoOrder</span> &#123;</span><br><span class="line">  <span class="meta">@Id</span></span><br><span class="line">  <span class="meta">@GeneratedValue</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> Long id;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span>  String cargoName;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 这种方式可以写入但是不能读取，等于不能用</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="comment">//@Column(name = &quot;sendContacts&quot;,columnDefinition = &quot;blob&quot;)</span></span><br><span class="line">  <span class="comment">//private List&lt;Contacts&gt; sendContacts=new ArrayList&lt;&gt;();</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">  自定义序列化方式是比较好用的</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  <span class="meta">@Column(name = &quot;receiveContacts&quot;,length = 2000)</span></span><br><span class="line">  <span class="meta">@Convert(converter = MyInstanceJpaConvertJson1.class)</span></span><br><span class="line">  <span class="keyword">private</span>  List&lt;Contacts&gt; receiveContacts;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>针对集合也的写一个强类型的转换器</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 此注解会被 spring jpa 全局使用,不需要在值对象字段上加 @Convert(converter = MyInstanceJpaConvertJson.class)</span></span><br><span class="line"><span class="comment">// 如果不加此注解，需要在值对象字段上加 @Convert(converter = MyInstanceJpaConvertJson.class)</span></span><br><span class="line"><span class="comment">// @Converter(autoApply = true)</span></span><br><span class="line"><span class="meta">@Converter</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyInstanceJpaConvertJson1</span> <span class="keyword">implements</span>  <span class="title class_">JpaConverterJson</span>&lt;List&lt;Contacts&gt;&gt; &#123;</span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> List&lt;Contacts&gt; <span class="title function_">getInstance</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;Contacts&gt;() ;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="jpa-hibernate-关联关系"><a href="#jpa-hibernate-关联关系" class="headerlink" title="jpa-hibernate 关联关系"></a>jpa-hibernate 关联关系</h1><p>spring  data jpa 没有提供关联关系的扩展，关联关系注解包括 @JoinColumn、 @OneToOne、 @OneToMany、 @ManyToOne、 @ManyToMany、@JoinTable、 @OrderBy。<br>注意点：<br>多对多关联关系的实体需要加 Serializable 接口</p>
<h2 id="JoinColumn-注解用来定义主键字段和外键字段的对应关系"><a href="#JoinColumn-注解用来定义主键字段和外键字段的对应关系" class="headerlink" title="@JoinColumn 注解用来定义主键字段和外键字段的对应关系"></a>@JoinColumn 注解用来定义主键字段和外键字段的对应关系</h2><p> 如果没有 @JoinColumn 注解的话默认通过两个实体的主键进行关联 name </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Repeatable(JoinColumns.class)</span></span><br><span class="line"><span class="meta">@Target(&#123;METHOD, FIELD&#125;)</span></span><br><span class="line"><span class="meta">@Retention(RUNTIME)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> JoinColumn &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** </span></span><br><span class="line"><span class="comment">     定义在数据库里的外键名,此外键名会在使用  <span class="doctag">@JoinColumn</span> 注解的表里创建.主表通过外键名去查找关联表</span></span><br><span class="line"><span class="comment">     默认不指定的化，值是关联表的表名+主键</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    String <span class="title function_">name</span><span class="params">()</span> <span class="keyword">default</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     此字段用途是 name() 方法定义的外键，指向关联表的字段，默认不写的化是指向关联表的 id</span></span><br><span class="line"><span class="comment">     name() 定义的字段里存放的数值是 referencedColumnName() 指定的字段</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    String <span class="title function_">referencedColumnName</span><span class="params">()</span> <span class="keyword">default</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    外键字段是否唯一</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">unique</span><span class="params">()</span> <span class="keyword">default</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/** </span></span><br><span class="line"><span class="comment">    外键字段是是否允许为空</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">nullable</span><span class="params">()</span> <span class="keyword">default</span> <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    是否允许插入, false :关联表会插入数据，但是外键字段会为 null</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">insertable</span><span class="params">()</span> <span class="keyword">default</span> <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     是否允许更新 没有测试过效果</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">updatable</span><span class="params">()</span> <span class="keyword">default</span> <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    定义建表时创建此列的DDL</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    String <span class="title function_">columnDefinition</span><span class="params">()</span> <span class="keyword">default</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">   </span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    String <span class="title function_">table</span><span class="params">()</span> <span class="keyword">default</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    </span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    ForeignKey <span class="title function_">foreignKey</span><span class="params">()</span> <span class="keyword">default</span> <span class="meta">@ForeignKey(PROVIDER_DEFAULT)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="OneToOne-实体和实体是1对1关联"><a href="#OneToOne-实体和实体是1对1关联" class="headerlink" title="@OneToOne 实体和实体是1对1关联"></a>@OneToOne 实体和实体是1对1关联</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target(&#123;METHOD, FIELD&#125;)</span> </span><br><span class="line"><span class="meta">@Retention(RUNTIME)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> OneToOne &#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** </span></span><br><span class="line"><span class="comment">    </span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">  Class <span class="title function_">targetEntity</span><span class="params">()</span> <span class="keyword">default</span> <span class="keyword">void</span>.class;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">    指定关联操作，查询不需要关联操作</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">  CascadeType[] cascade() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** </span></span><br><span class="line"><span class="comment">   关联表是否立即加载，默认立即加载</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">  FetchType <span class="title function_">fetch</span><span class="params">()</span> <span class="keyword">default</span> EAGER;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** </span></span><br><span class="line"><span class="comment">   </span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">  <span class="type">boolean</span> <span class="title function_">optional</span><span class="params">()</span> <span class="keyword">default</span> <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** </span></span><br><span class="line"><span class="comment">    </span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">  String <span class="title function_">mappedBy</span><span class="params">()</span> <span class="keyword">default</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   </span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">  <span class="type">boolean</span> <span class="title function_">orphanRemoval</span><span class="params">()</span> <span class="keyword">default</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CargoOrder</span> &#123;</span><br><span class="line">  <span class="meta">@Id</span></span><br><span class="line">  <span class="meta">@Column(name = &quot;id&quot;, nullable = false)</span></span><br><span class="line">  <span class="meta">@GeneratedValue(strategy = GenerationType.IDENTITY)</span></span><br><span class="line">  <span class="keyword">private</span> Long id;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> String  name;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">//设置关联是懒加载的方式</span></span><br><span class="line">  <span class="meta">@OneToOne(cascade = CascadeType.ALL,fetch = FetchType.LAZY)</span></span><br><span class="line">  <span class="comment">//设置外键去关联 customer 表，不是用此注解会生成默认的外键</span></span><br><span class="line">  <span class="meta">@JoinColumn(name = &quot;customer_id&quot;)</span></span><br><span class="line">  <span class="keyword">private</span> Customer customer;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Customer</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> <span class="number">6286816358723854706L</span>;</span><br><span class="line">  <span class="meta">@Id</span></span><br><span class="line">  <span class="meta">@Column(name = &quot;id&quot;, nullable = false)</span></span><br><span class="line">  <span class="meta">@GeneratedValue(strategy=GenerationType.IDENTITY)</span></span><br><span class="line">  <span class="keyword">private</span> Long id;</span><br><span class="line">  <span class="keyword">private</span> String name;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">//一般我们的关联关系都是单个的</span></span><br><span class="line">  <span class="comment">//@OneToOne(cascade = CascadeType.ALL)</span></span><br><span class="line">  <span class="comment">//public CargoOrder cargoOrder;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">var</span>  <span class="variable">myRepository</span> <span class="operator">=</span>  context.getBean(MyRepository.class);</span><br><span class="line"><span class="comment">//执行下面语句后，session 已经结束</span></span><br><span class="line"><span class="keyword">var</span> result=  myRepository.findById(<span class="number">1L</span>);</span><br><span class="line"></span><br><span class="line">result.ifPresent(p-&gt;&#123;</span><br><span class="line">  System.out.println(p.getName());</span><br><span class="line">  <span class="comment">//查询关联实体会失败, no session 错误</span></span><br><span class="line">  <span class="comment">// hibernate 给的解决方法是 JpaProperties hibernate.enable_lazy_load_no_trans 为 true</span></span><br><span class="line">  <span class="comment">// 这种方式在关联对象是 @OneToOne  的时候是可以解决问题的 但是在 @OneToMany 的时候会有n +1 的问题</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 开启 JpaProperties hibernate.enable_lazy_load_no_trans，会单独开启会话去查询关联表</span></span><br><span class="line">  System.out.println(p.getCustomer().getName());</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>


<h2 id="OneToMany-实体和实体是1对多关联"><a href="#OneToMany-实体和实体是1对多关联" class="headerlink" title="@OneToMany 实体和实体是1对多关联"></a>@OneToMany 实体和实体是1对多关联</h2><p>@OneToMany 1的一方没有办法维护多的一方的所有外键，但是在多的一方，可以维护1的一方的外键，如果在多的一方维护外键关系用 @ManyToOne 维护,此种情况 hibernate 会生成一张中间表来维护外键之间的关系<br>数据库中间表的表名是 CargoOrder_Customer 字段是: CargoOrder_Customer,customers_id</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CargoOrder</span> &#123;</span><br><span class="line">  <span class="meta">@Id</span></span><br><span class="line">  <span class="meta">@Column(name = &quot;id&quot;, nullable = false)</span></span><br><span class="line">  <span class="meta">@GeneratedValue(strategy = GenerationType.IDENTITY)</span></span><br><span class="line">  <span class="keyword">private</span> Long id;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> String  name;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@OneToMany(cascade = CascadeType.ALL,fetch = FetchType.LAZY)</span></span><br><span class="line">  <span class="keyword">private</span> Set&lt;Customer&gt; customers=<span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;Customer&gt;();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Setter</span></span><br><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Customer</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> <span class="number">6286816358723854706L</span>;</span><br><span class="line">  <span class="meta">@Id</span></span><br><span class="line">  <span class="meta">@Column(name = &quot;id&quot;, nullable = false)</span></span><br><span class="line">  <span class="meta">@GeneratedValue(strategy=GenerationType.IDENTITY)</span></span><br><span class="line">  <span class="keyword">private</span> Long id;</span><br><span class="line">  <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span>  Integer age;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@ManyToOne</span></span><br><span class="line">  <span class="keyword">private</span>  CargoOrder cargoOrder;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p><font color=blue>解决方法1： 1端维护外键，但是外键字段定义在多方表里，<em>在多方表插入数据后1端会更新多方表的外键字段</em></font></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//1的一方</span></span><br><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="meta">@Setter</span></span><br><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CargoOrder</span> &#123;</span><br><span class="line">  <span class="meta">@Id</span></span><br><span class="line">  <span class="meta">@Column(name = &quot;id&quot;, nullable = false)</span></span><br><span class="line">  <span class="meta">@GeneratedValue(strategy = GenerationType.IDENTITY)</span></span><br><span class="line">  <span class="keyword">private</span> Long id;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> String  name;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">//OneToMany 默认是懒加载</span></span><br><span class="line">  <span class="meta">@OneToMany(cascade = CascadeType.ALL)</span></span><br><span class="line">  <span class="comment">//给 Customer 设置外键指向 CargoOrder</span></span><br><span class="line">  <span class="comment">//hibernate 知道这里设置外键肯定不是给 CargoOrder 设置外键 指向 Customer</span></span><br><span class="line">  <span class="meta">@JoinColumn(name = &quot;cargoOrderID&quot;)</span></span><br><span class="line">  <span class="keyword">private</span> Set&lt;Customer&gt; customers=<span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;Customer&gt;();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//多的一方，不需要做其他配置</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Customer</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> <span class="number">6286816358723854706L</span>;</span><br><span class="line">  <span class="meta">@Id</span></span><br><span class="line">  <span class="meta">@Column(name = &quot;id&quot;, nullable = false)</span></span><br><span class="line">  <span class="meta">@GeneratedValue(strategy=GenerationType.IDENTITY)</span></span><br><span class="line">  <span class="keyword">private</span> Long id;</span><br><span class="line">  <span class="keyword">private</span> String name;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><font color=blue>解决方法2： 1端放弃维护外键，有多方自己维护外键，此外键字段在多方表里，外键的插入是在多方新增数据的时候，同时插入的</font></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//1端</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="meta">@Setter</span></span><br><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CargoOrder</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> <span class="number">458774547746966971L</span>;</span><br><span class="line">  <span class="meta">@Id</span></span><br><span class="line">  <span class="meta">@Column(name = &quot;id&quot;, nullable = false)</span></span><br><span class="line">  <span class="meta">@GeneratedValue(strategy = GenerationType.IDENTITY)</span></span><br><span class="line">  <span class="keyword">private</span> Long id;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> String  name;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">  mappedBy 告知 jpa 外键关系由 Customer 表的 cargoOrder 属性来维护</span></span><br><span class="line"><span class="comment">  Customer_.CARGO_ORDER  这个是 jpa metamodel 插件提供的功能</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  <span class="meta">@OneToMany(cascade = CascadeType.ALL,fetch = FetchType.LAZY,mappedBy = Customer_.CARGO_ORDER)</span></span><br><span class="line">  <span class="comment">//这里不能在定义外键列了</span></span><br><span class="line">  <span class="keyword">private</span> Set&lt;Customer&gt; customers=<span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;Customer&gt;(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//多端</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="meta">@Setter</span></span><br><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Customer</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> <span class="number">5227592687670264157L</span>;</span><br><span class="line">  <span class="meta">@Id</span></span><br><span class="line">  <span class="meta">@Column(name = &quot;id&quot;, nullable = false)</span></span><br><span class="line">  <span class="meta">@GeneratedValue(strategy=GenerationType.IDENTITY)</span></span><br><span class="line">  <span class="keyword">private</span> Long id;</span><br><span class="line">  <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@ManyToOne(cascade = CascadeType.ALL,fetch = FetchType.LAZY)</span></span><br><span class="line">  <span class="comment">//此处的外键列可以不定义，用默认值</span></span><br><span class="line">  <span class="meta">@JoinColumn(name = &quot;cargoOrderID&quot;)</span></span><br><span class="line">  <span class="keyword">private</span> CargoOrder cargoOrder;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ComponentScan(&#123;&quot;com.hank&quot;&#125;)</span></span><br><span class="line"><span class="meta">@EnableJpaRepositories(</span></span><br><span class="line"><span class="meta">    basePackages = &#123;&quot;com.hank.Pesis&quot;&#125;,</span></span><br><span class="line"><span class="meta">    entityManagerFactoryRef = &quot;myEntityManagerFactory&quot;,</span></span><br><span class="line"><span class="meta">    transactionManagerRef = &quot;jdbcTransactionManager&quot;</span></span><br><span class="line"><span class="meta">)</span></span><br><span class="line"><span class="meta">@EnableTransactionManagement</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Programmer</span> &#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="type">var</span> <span class="variable">context</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AnnotationConfigApplicationContext</span>(Programmer.class);</span><br><span class="line">    <span class="type">MyRepository</span>  <span class="variable">myRepository</span> <span class="operator">=</span>  context.getBean(MyRepository.class);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="type">val</span> <span class="variable">cargoOrder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CargoOrder</span>();</span><br><span class="line">    cargoOrder.setName(<span class="string">&quot;iphone&quot;</span>);</span><br><span class="line">    <span class="keyword">var</span> cus=<span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;Customer&gt;();</span><br><span class="line">    cus.add(<span class="keyword">new</span> <span class="title class_">Customer</span>()&#123;&#123;</span><br><span class="line">      setName(LocalDateTime.now().toString());</span><br><span class="line">      <span class="comment">//有多端来维护外键，如果不这样写多端表里的外键将为空，因为 mappedBy 已经告知 jpa ,外键有多端维护</span></span><br><span class="line">      setCargoOrder(cargoOrder);</span><br><span class="line">    &#125;&#125;);</span><br><span class="line">    cargoOrder.setCustomers(cus);</span><br><span class="line">    myRepository.save(cargoOrder);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line">     <span class="keyword">var</span> result=  myRepository.&lt;CargoOrder&gt;findById(<span class="number">1L</span>);</span><br><span class="line">     result.ifPresent(p-&gt;&#123;</span><br><span class="line">       <span class="type">val</span> <span class="variable">customer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Customer</span>();</span><br><span class="line">       customer.setName(LocalDateTime.now().toString());</span><br><span class="line"></span><br><span class="line">       <span class="comment">/*</span></span><br><span class="line"><span class="comment">       如下在多端维护外键的时候，会报在临时对象的属性里赋值持久性或分离对象不被允许</span></span><br><span class="line"><span class="comment">       customer 是灵思对象，p 是分离对象，因为此时事务已经结束</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">       解决方法：JpaProperties 属性增加 put(&quot;hibernate.event.merge.entity_copy_observer&quot;,&quot;allow&quot;);</span></span><br><span class="line"><span class="comment">      */</span></span><br><span class="line">       customer.setCargoOrder(p);</span><br><span class="line"></span><br><span class="line">       p.getCustomers().add(customer);</span><br><span class="line">       myRepository.save(p);</span><br><span class="line">       System.out.println(p);</span><br><span class="line">    &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如上俩种方式是互斥的不能混着写，还有就是  lombok 的 @ToString @EqualsAndHashCode 和  hibernate 兼容有问题</p>
<h2 id="OrderBy-对多端的返回进行排序"><a href="#OrderBy-对多端的返回进行排序" class="headerlink" title="@OrderBy 对多端的返回进行排序"></a>@OrderBy 对多端的返回进行排序</h2><p>一般和@OneToMany一起使用，对多端返回的数据排序</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="meta">@Setter</span></span><br><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CargoOrder</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> <span class="number">458774547746966971L</span>;</span><br><span class="line">  <span class="meta">@Id</span></span><br><span class="line">  <span class="meta">@Column(name = &quot;id&quot;, nullable = false)</span></span><br><span class="line">  <span class="meta">@GeneratedValue(strategy = GenerationType.IDENTITY)</span></span><br><span class="line">  <span class="keyword">private</span> Long id;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> String  name;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@OneToMany(cascade = CascadeType.ALL,fetch = FetchType.LAZY,mappedBy = Customer_.CARGO_ORDER)</span></span><br><span class="line">  <span class="comment">//指定返回的多端的排序方式</span></span><br><span class="line">  <span class="meta">@OrderBy(Customer_.NAME+&quot; asc,&quot;+Customer_.ID+&quot; asc&quot;)</span></span><br><span class="line">  <span class="keyword">private</span> Set&lt;Customer&gt; customers=<span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;Customer&gt;(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="JoinTable-自定义中间表，基本不用"><a href="#JoinTable-自定义中间表，基本不用" class="headerlink" title="@JoinTable 自定义中间表，基本不用"></a>@JoinTable 自定义中间表，基本不用</h2><p>@JoinTable 注解用于关联映射，它是在关联的拥有方进行配置。使用 @JoinTable 注解将创建一个连接表，也称为“中间表”。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="meta">@Setter</span></span><br><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CargoOrder</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> <span class="number">458774547746966971L</span>;</span><br><span class="line">  <span class="meta">@Id</span></span><br><span class="line">  <span class="meta">@Column(name = &quot;id&quot;, nullable = false)</span></span><br><span class="line">  <span class="meta">@GeneratedValue(strategy = GenerationType.IDENTITY)</span></span><br><span class="line">  <span class="keyword">private</span> Long id;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">private</span> String  name;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">//OneToMany 默认会生成中间表，@JoinTable 注解可以自定义中间表的表名，字段等</span></span><br><span class="line">  <span class="meta">@OneToMany(cascade = CascadeType.ALL,fetch = FetchType.LAZY)</span></span><br><span class="line">  <span class="comment">//自定义中间表</span></span><br><span class="line">  <span class="meta">@JoinTable(name = &quot;a_b&quot;)</span></span><br><span class="line">  <span class="keyword">private</span> Set&lt;Customer&gt; customers=<span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;Customer&gt;(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="ManyToMany-多对多-必须要有中间表，基本不用"><a href="#ManyToMany-多对多-必须要有中间表，基本不用" class="headerlink" title="@ManyToMany 多对多-必须要有中间表，基本不用"></a>@ManyToMany 多对多-必须要有中间表，基本不用</h2><p>ManyToMany总是使用中间关系连接表来存储关系。如果两个实体都定义了ManyToMany的话，因为单向关系，会生成有2个中间表。所以需要用 mappedBy 改造，使其只存在一个中间表</p>
<h1 id="jpa-hibernate-缓存"><a href="#jpa-hibernate-缓存" class="headerlink" title="jpa-hibernate 缓存"></a>jpa-hibernate 缓存</h1><p>在 JPA2.0 中，缓存分为一级缓存和二级缓存（JPA1.0 只支持一级缓存）</p>
<p>在 JPA 中，持久化上下文（EntityManager）就是 JPA 的一级缓存。在该缓存区中，会将查询到的对象缓存到该区域中。</p>
<h2 id="一级缓存"><a href="#一级缓存" class="headerlink" title="一级缓存"></a>一级缓存</h2><p>如果在同一个 EntityManager 中，查询相同 OID 的数据，那么只需要发送一条 sql。在事务提交/关闭 EntityManager 之后，一级缓存会清空。所以在不同的 EntityManager（或者上下文） 中使用不同的一级缓存。JPA 中的一级缓存的缓存能力是非常有限的，<em>因为我们不会经常在一个 EntityManager 中查询相同的数据</em>。</p>
<p>JPA 中的一级缓存也可以使用下面的方法手动清除缓存数据：</p>
<ol>
<li>detach：清除一级缓存中指定的对象</li>
<li>clear：清除一级缓存中的所有的缓存数据</li>
</ol>
<h2 id="二级缓存"><a href="#二级缓存" class="headerlink" title="二级缓存"></a>二级缓存</h2><p>JPA 中的二级缓存通常是用来提高应用程序性能的，它可以避免访问已经从数据库加载的数据，提高访问未被修改数据对象的速度,JPA 二级缓存是跨越持久化上下文的，是真正意义上的全局应用缓存<br>如果二级缓存激活，JPA 会先从一级缓存中查找实体，未找到再从二级缓存中查找。当二级缓存有效时，就不能依靠事务来保护并发的数据，而是依靠锁策略，如在确认修改后，需要手工处理乐观锁失败等。</p>
<p>JPA 二级缓存通常用来提高性能，同时，使用二级缓存可能会导致提取到“陈旧”数据，也会出现并发写的问题。所以二级缓存最好是用在经常读取的数据，比较少更新数据的情况，而不应该对重要数据使用二级缓存.</p>

    </div>

    
    
    

    <footer class="post-footer">
          

<div class="post-copyright">
<ul>
  <li class="post-copyright-author">
      <strong>本文作者： </strong>Hank Bai
  </li>
  <li class="post-copyright-link">
      <strong>本文链接：</strong>
      <a href="http://bh.com/2021/05/25/java/springDataJpa/springDataJpa/" title="spring data jpa">http://bh.com/2021/05/25/java/springDataJpa/springDataJpa/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！
  </li>
</ul>
</div>


        

          <div class="post-nav">
            <div class="post-nav-item">
            </div>
            <div class="post-nav-item">
                <a href="/2021/05/25/java/springBoot/springBoot/" rel="next" title="spring boot">
                  spring boot <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






    <div class="comments gitalk-container"></div>
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Hank Bai</span>
</div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
      <span>站点总字数：</span>
    <span title="站点总字数">98k</span>
  </span>
</div>


  <script src='https://unpkg.com/mermaid@9.2.2/dist/mermaid.min.js'></script>
  <script>
    if (window.mermaid) {
      mermaid.initialize({theme: 'forest'});
    }
  </script>


    </div>
  </footer>

  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js" integrity="sha256-yt2kYMy0w8AbtF89WXb2P1rfjcP/HTHLT7097U8Y5b8=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  


  <script class="next-config" data-name="mermaid" type="application/json">{"enable":true,"version":"9.2.2","theme":{"light":"default","dark":"dark","options":{"maxTextSize":99999}},"js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mermaid/9.2.2/mermaid.min.js","integrity":"sha256-CemUs9ITT7liCZpVMktcEw0BpAOZ1+mujlMB3UyuImU="}}</script>
  <script src="/js/third-party/tags/mermaid.js"></script>

  <script src="/js/third-party/fancybox.js"></script>

  <script src="/js/third-party/pace.js"></script>

  




<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/gitalk/1.7.2/gitalk.css" integrity="sha256-AJnUHL7dBv6PGaeyPQJcgQPDjt/Hn/PvYZde1iqfp8U=" crossorigin="anonymous">

<script class="next-config" data-name="gitalk" type="application/json">{"enable":true,"github_id":"BAI-HANK","repo":"bai-hank.github.io","client_id":"ee40f9d8aaf703fdb6ed","client_secret":"64cd53b08de038c5276753612c35ace517544597","admin_user":"BAI-HANK","distraction_free_mode":true,"proxy":"https://cors-anywhere.azm.workers.dev/https://github.com/login/oauth/access_token","language":"zh-CN","js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/gitalk/1.7.2/gitalk.min.js","integrity":"sha256-Pmj85ojLaPOWwRtlMJwmezB/Qg8BzvJp5eTzvXaYAfA="},"path_md5":"c0d1d764e6701246df575cbb80848532"}</script>
<script src="/js/third-party/comments/gitalk.js"></script>

<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"log":false,"model":{"jsonPath":"/live2dw/assets/koharu.model.json"},"display":{"position":"left","width":150,"height":300},"mobile":{"show":false},"react":{"opacity":0.7}});</script></body>
</html>

<!-- 页面点击小红心 -->
<script type="text/javascript" src="/js/custom/clickLove.js"></script>

